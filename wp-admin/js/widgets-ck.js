/*global ajaxurl, isRtl */var wpWidgets;(function(e){var t=e(document);wpWidgets={init:function(){var n,r,i=this,s=e(".widgets-chooser"),o=s.find(".widgets-chooser-sidebars"),u=e("div.widgets-sortables"),a="undefined"!=typeof isRtl&&!!isRtl;e("#widgets-right .sidebar-name").click(function(){var n=e(this),r=n.closest(".widgets-holder-wrap");if(r.hasClass("closed")){r.removeClass("closed");n.parent().sortable("refresh")}else r.addClass("closed");t.triggerHandler("wp-pin-menu")});e("#widgets-left .sidebar-name").click(function(){e(this).closest(".widgets-holder-wrap").toggleClass("closed");t.triggerHandler("wp-pin-menu")});e(document.body).bind("click.widgets-toggle",function(t){var n=e(t.target),r={"z-index":100},i,s,o,u,f;if(n.parents(".widget-top").length&&!n.parents("#available-widgets").length){i=n.closest("div.widget");s=i.children(".widget-inside");o=parseInt(i.find("input.widget-width").val(),10),u=i.parent().width();if(s.is(":hidden")){if(o>250&&o+30>u&&i.closest("div.widgets-sortables").length){i.closest("div.widget-liquid-right").length?f=a?"margin-right":"margin-left":f=a?"margin-left":"margin-right";r[f]=u-(o+30)+"px";i.css(r)}i.addClass("open");s.slideDown("fast")}else s.slideUp("fast",function(){i.attr("style","");i.removeClass("open")});t.preventDefault()}else if(n.hasClass("widget-control-save")){wpWidgets.save(n.closest("div.widget"),0,1,0);t.preventDefault()}else if(n.hasClass("widget-control-remove")){wpWidgets.save(n.closest("div.widget"),1,1,0);t.preventDefault()}else if(n.hasClass("widget-control-close")){i=n.closest("div.widget");i.removeClass("open");wpWidgets.close(i);t.preventDefault()}});u.children(".widget").each(function(){var t=e(this);wpWidgets.appendTitle(this);t.find("p.widget-error").length&&t.find("a.widget-action").trigger("click")});e("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:100,containment:"#wpwrap",start:function(t,n){var s=e(this).find(".widgets-chooser");n.helper.find("div.widget-description").hide();r=this.id;if(s.length){e("#wpbody-content").append(s.hide());n.helper.find(".widgets-chooser").remove();i.clearWidgetSelection()}},stop:function(){n&&e(n).hide();n=""}});u.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"#wpwrap",start:function(t,n){var r,i=e(this),s=i.parent(),o=n.item.children(".widget-inside");if(o.css("display")==="block"){o.hide();e(this).sortable("refreshPositions")}if(!s.hasClass("closed")){r=n.item.hasClass("ui-draggable")?i.height():1+i.height();i.css("min-height",r+"px")}},stop:function(i,s){var o,u,a,f,l,c,h=s.item,p=r;if(h.hasClass("deleting")){wpWidgets.save(h,1,0,1);h.remove();return}o=h.find("input.add_new").val();u=h.find("input.multi_number").val();h.attr("style","").removeClass("ui-draggable");r="";if(o){if("multi"===o){h.html(h.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,u)}));h.attr("id",p.replace("__i__",u));u++;e("div#"+p).find("input.multi_number").val(u)}else if("single"===o){h.attr("id","new-"+p);n="div#"+p}wpWidgets.save(h,0,0,1);h.find("input.add_new").val("");t.trigger("widget-added",[h])}a=h.parent();if(a.parent().hasClass("closed")){a.parent().removeClass("closed");f=a.children(".widget");if(f.length>1){l=f.get(0);c=h.get(0);l.id&&c.id&&l.id!==c.id&&e(l).before(h)}}o?h.find("a.widget-action").trigger("click"):wpWidgets.saveOrder(a.attr("id"))},activate:function(){e(this).parent().addClass("widget-hover")},deactivate:function(){e(this).css("min-height","").parent().removeClass("widget-hover")},receive:function(t,n){var r=e(n.sender);if(this.id.indexOf("orphaned_widgets")>-1){r.sortable("cancel");return}r.attr("id").indexOf("orphaned_widgets")>-1&&!r.children(".widget").length&&r.parents(".orphan-sidebar").slideUp(400,function(){e(this).remove()})}}).sortable("option","connectWith","div.widgets-sortables");e("#available-widgets").droppable({tolerance:"pointer",accept:function(t){return e(t).parent().attr("id")!=="widget-list"},drop:function(t,n){n.draggable.addClass("deleting");e("#removing-widget").hide().children("span").empty()},over:function(t,n){n.draggable.addClass("deleting");e("div.widget-placeholder").hide();n.draggable.hasClass("ui-sortable-helper")&&e("#removing-widget").show().children("span").html(n.draggable.find("div.widget-title").children("h4").html())},out:function(t,n){n.draggable.removeClass("deleting");e("div.widget-placeholder").show();e("#removing-widget").hide().children("span").empty()}});e("#widgets-right .widgets-holder-wrap").each(function(t,n){var r=e(n),i=r.find(".sidebar-name h3").text(),s=r.find(".widgets-sortables").attr("id"),u=e('<li tabindex="0">').text(e.trim(i));t===0&&u.addClass("widgets-chooser-selected");o.append(u);u.data("sidebarId",s)});e("#available-widgets .widget .widget-title").on("click.widgets-chooser",function(){var t=e(this).closest(".widget");if(t.hasClass("widget-in-question")||e("#widgets-left").hasClass("chooser"))i.closeChooser();else{i.clearWidgetSelection();e("#widgets-left").addClass("chooser");t.addClass("widget-in-question").children(".widget-description").after(s);s.slideDown(300,function(){o.find(".widgets-chooser-selected").focus()});o.find("li").on("focusin.widgets-chooser",function(){o.find(".widgets-chooser-selected").removeClass("widgets-chooser-selected");e(this).addClass("widgets-chooser-selected")})}});s.on("click.widgets-chooser",function(t){var n=e(t.target);if(n.hasClass("button-primary")){i.addWidget(s);i.closeChooser()}else n.hasClass("button-secondary")&&i.closeChooser()}).on("keyup.widgets-chooser",function(t){if(t.which===e.ui.keyCode.ENTER)if(e(t.target).hasClass("button-secondary"))i.closeChooser();else{i.addWidget(s);i.closeChooser()}else t.which===e.ui.keyCode.ESCAPE&&i.closeChooser()})},saveOrder:function(t){var n={action:"widgets-order",savewidgets:e("#_wpnonce_widgets").val(),sidebars:[]};t&&e("#"+t).find(".spinner:first").addClass("is-active");e("div.widgets-sortables").each(function(){e(this).sortable&&(n["sidebars["+e(this).attr("id")+"]"]=e(this).sortable("toArray").join(","))});e.post(ajaxurl,n,function(){e(".spinner").removeClass("is-active")})},save:function(n,r,i,s){var o=n.closest("div.widgets-sortables").attr("id"),u=n.find("form").serialize(),a;n=e(n);e(".spinner",n).addClass("is-active");a={action:"save-widget",savewidgets:e("#_wpnonce_widgets").val(),sidebar:o};r&&(a.delete_widget=1);u+="&"+e.param(a);e.post(ajaxurl,u,function(o){var u;if(r){if(!e("input.widget_number",n).val()){u=e("input.widget-id",n).val();e("#available-widgets").find("input.widget-id").each(function(){e(this).val()===u&&e(this).closest("div.widget").show()})}if(i){s=0;n.slideUp("fast",function(){e(this).remove();wpWidgets.saveOrder()})}else n.remove()}else{e(".spinner").removeClass("is-active");if(o&&o.length>2){e("div.widget-content",n).html(o);wpWidgets.appendTitle(n);t.trigger("widget-updated",[n])}}s&&wpWidgets.saveOrder()})},appendTitle:function(t){var n=e('input[id*="-title"]',t).val()||"";n&&(n=": "+n.replace(/<[^<>]+>/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;"));e(t).children(".widget-top").children(".widget-title").children().children(".in-widget-title").html(n)},close:function(e){e.children(".widget-inside").slideUp("fast",function(){e.attr("style","")})},addWidget:function(n){var r,i,s,o,u,a,f,l=n.find(".widgets-chooser-selected").data("sidebarId"),c=e("#"+l);r=e("#available-widgets").find(".widget-in-question").clone();i=r.attr("id");s=r.find("input.add_new").val();o=r.find("input.multi_number").val();r.find(".widgets-chooser").remove();if("multi"===s){r.html(r.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,o)}));r.attr("id",i.replace("__i__",o));o++;e("#"+i).find("input.multi_number").val(o)}else if("single"===s){r.attr("id","new-"+i);e("#"+i).hide()}c.closest(".widgets-holder-wrap").removeClass("closed");c.append(r);c.sortable("refresh");wpWidgets.save(r,0,0,1);r.find("input.add_new").val("");t.trigger("widget-added",[r]);u=e(window).scrollTop();a=u+e(window).height();f=c.offset();f.bottom=f.top+c.outerHeight();(u>f.bottom||a<f.top)&&e("html, body").animate({scrollTop:f.top-130},200);window.setTimeout(function(){r.find(".widget-title").trigger("click")},250)},closeChooser:function(){var t=this;e(".widgets-chooser").slideUp(200,function(){e("#wpbody-content").append(this);t.clearWidgetSelection()})},clearWidgetSelection:function(){e("#widgets-left").removeClass("chooser");e(".widget-in-question").removeClass("widget-in-question")}};t.ready(function(){wpWidgets.init()})})(jQuery);