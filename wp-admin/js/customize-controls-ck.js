/* globals _wpCustomizeHeader, _wpCustomizeBackground, _wpMediaViewsL10n */(function(e,t){var n,r,i=wp.customize;i.Setting=i.Value.extend({initialize:function(e,t,n){i.Value.prototype.initialize.call(this,t,n);this.id=e;this.transport=this.transport||"refresh";this.bind(this.preview)},preview:function(){switch(this.transport){case"refresh":return this.previewer.refresh();case"postMessage":return this.previewer.send("setting",[this.id,this()])}}});i.utils={};i.utils.bubbleChildValueChanges=function(e,n){t.each(n,function(t,n){e[n].bind(function(t,n){e.parent&&t!==n&&e.parent.trigger("change",e)})})};r=function(e){var t,n,r;t=this;e=e||{};r=function(){t.container.find(":focusable:first").focus();t.container[0].scrollIntoView(!0)};if(e.completeCallback){n=e.completeCallback;e.completeCallback=function(){r();n()}}else e.completeCallback=r;t.expand?t.expand(e):e.completeCallback()};i.utils.prioritySort=function(e,t){return e.priority()===t.priority()&&typeof e.params.instanceNumber=="number"&&typeof t.params.instanceNumber=="number"?e.params.instanceNumber-t.params.instanceNumber:e.priority()-t.priority()};i.utils.isKeydownButNotEnterEvent=function(e){return"keydown"===e.type&&13!==e.which};i.utils.areElementListsEqual=function(e,n){var r=e.length===n.length&&-1===_.indexOf(_.map(_.zip(e,n),function(e){return t(e[0]).is(e[1])}),!1);return r};n=i.Class.extend({defaultActiveArguments:{duration:"fast",completeCallback:t.noop},defaultExpandedArguments:{duration:"fast",completeCallback:t.noop},initialize:function(e,n){var r=this;r.id=e;r.params={};t.extend(r,n||{});r.container=t(r.params.content);r.deferred={embedded:new t.Deferred};r.priority=new i.Value;r.active=new i.Value;r.activeArgumentsQueue=[];r.expanded=new i.Value;r.expandedArgumentsQueue=[];r.active.bind(function(e){var n=r.activeArgumentsQueue.shift();n=t.extend({},r.defaultActiveArguments,n);e=e&&r.isContextuallyActive();r.onChangeActive(e,n)});r.expanded.bind(function(e){var n=r.expandedArgumentsQueue.shift();n=t.extend({},r.defaultExpandedArguments,n);r.onChangeExpanded(e,n)});r.attachEvents();i.utils.bubbleChildValueChanges(r,["priority","active"]);r.priority.set(isNaN(r.params.priority)?100:r.params.priority);r.active.set(r.params.active);r.expanded.set(!1)},ready:function(){},_children:function(e,t){var n=this,r=[];i[t].each(function(t){t[e].get()===n.id&&r.push(t)});r.sort(i.utils.prioritySort);return r},isContextuallyActive:function(){throw new Error("Container.isContextuallyActive() must be overridden in a subclass.")},onChangeActive:function(e,n){var r="resolved"===i.previewer.deferred.active.state()?n.duration:0;if(!t.contains(document,this.container)){this.container.toggle(e);n.completeCallback&&n.completeCallback()}else e?this.container.stop(!0,!0).slideDown(r,n.completeCallback):this.container.stop(!0,!0).slideUp(r,n.completeCallback)},_toggleActive:function(e,t){var n=this;t=t||{};if(e&&this.active.get()||!e&&!this.active.get()){t.unchanged=!0;n.onChangeActive(n.active.get(),t);return!1}t.unchanged=!1;this.activeArgumentsQueue.push(t);this.active.set(e);return!0},activate:function(e){return this._toggleActive(!0,e)},deactivate:function(e){return this._toggleActive(!1,e)},onChangeExpanded:function(){throw new Error("Must override with subclass.")},_toggleExpanded:function(e,t){var n=this;t=t||{};if(e&&this.expanded.get()||!e&&!this.expanded.get()){t.unchanged=!0;n.onChangeExpanded(n.expanded.get(),t);return!1}t.unchanged=!1;this.expandedArgumentsQueue.push(t);this.expanded.set(e);return!0},expand:function(e){return this._toggleExpanded(!0,e)},collapse:function(e){return this._toggleExpanded(!1,e)},focus:r});i.Section=n.extend({initialize:function(e,r){var s=this;n.prototype.initialize.call(s,e,r);s.id=e;s.panel=new i.Value;s.panel.bind(function(e){t(s.container).toggleClass("control-subsection",!!e)});s.panel.set(s.params.panel||"");i.utils.bubbleChildValueChanges(s,["panel"]);s.embed();s.deferred.embedded.done(function(){s.ready()})},embed:function(){var e=this,n;n=function(n){var r;if(n)i.panel(n,function(t){t.deferred.embedded.done(function(){r=t.container.find("ul:first");e.container.parent().is(r)||r.append(e.container);e.deferred.embedded.resolve()})});else{r=t("#customize-theme-controls").children("ul");e.container.parent().is(r)||r.append(e.container);e.deferred.embedded.resolve()}};e.panel.bind(n);n(e.panel.get())},attachEvents:function(){var e=this;e.container.find(".accordion-section-title").on("click keydown",function(t){if(i.utils.isKeydownButNotEnterEvent(t))return;t.preventDefault();e.expanded()?e.collapse():e.expand()})},isContextuallyActive:function(){var e=this,t=e.controls(),n=0;_(t).each(function(e){e.active()&&(n+=1)});return n!==0},controls:function(){return this._children("section","control")},onChangeExpanded:function(e,t){var n=this,r=n.container.find(".accordion-section-content"),s;if(e){t.unchanged?s=t.completeCallback:s=function(){r.stop().slideDown(t.duration,t.completeCallback);n.container.addClass("open")};t.allowMultiple||i.section.each(function(e){e!==n&&e.collapse({duration:t.duration})});n.panel()?i.panel(n.panel()).expand({duration:t.duration,completeCallback:s}):s()}else{n.container.removeClass("open");r.slideUp(t.duration,t.completeCallback)}}});i.Panel=n.extend({initialize:function(e,t){var r=this;n.prototype.initialize.call(r,e,t);r.embed();r.deferred.embedded.done(function(){r.ready()})},embed:function(){var e=this,n=t("#customize-theme-controls > ul");e.container.parent().is(n)||n.append(e.container);e.deferred.embedded.resolve()},attachEvents:function(){var e,t=this;t.container.find(".accordion-section-title").on("click keydown",function(e){if(i.utils.isKeydownButNotEnterEvent(e))return;e.preventDefault();t.expanded()||t.expand()});e=t.container.find(".panel-meta:first");e.find("> .accordion-section-title").on("click keydown",function(n){if(i.utils.isKeydownButNotEnterEvent(n))return;n.preventDefault();if(e.hasClass("cannot-expand"))return;var r=e.find(".accordion-section-content:first");if(e.hasClass("open")){e.toggleClass("open");r.slideUp(t.defaultExpandedArguments.duration)}else{r.slideDown(t.defaultExpandedArguments.duration);e.toggleClass("open")}})},sections:function(){return this._children("panel","section")},isContextuallyActive:function(){var e=this,t=e.sections(),n=0;_(t).each(function(e){e.active()&&e.isContextuallyActive()&&(n+=1)});return n!==0},onChangeExpanded:function(e,t){if(t.unchanged){t.completeCallback&&t.completeCallback();return}var n,r,s=this,o=s.container.closest(".accordion-section"),u=o.closest(".wp-full-overlay"),a=o.closest(".accordion-container"),f=a.find(".open"),l=u.find("#customize-theme-controls > ul > .accordion-section > .accordion-section-title").add("#customize-info > .accordion-section-title"),c=u.find(".control-panel-back"),h=o.find(".accordion-section-title").first(),p=o.find(".control-panel-content");if(e){i.section.each(function(e){e.panel()||e.collapse({duration:0})});i.panel.each(function(e){s!==e&&e.collapse({duration:0})});p.show(0,function(){n=p.offset().top;r=a.scrollTop();p.css("margin-top",45-n-r);o.addClass("current-panel");u.addClass("in-sub-panel");a.scrollTop(0);t.completeCallback&&t.completeCallback()});l.attr("tabindex","-1");c.attr("tabindex","0");c.focus()}else{f.removeClass("open");o.removeClass("current-panel");u.removeClass("in-sub-panel");p.delay(180).hide(0,function(){p.css("margin-top","inherit");t.completeCallback&&t.completeCallback()});l.attr("tabindex","0");c.attr("tabindex","-1");h.focus();a.scrollTop(0)}}});i.Control=i.Class.extend({defaultActiveArguments:{duration:"fast",completeCallback:t.noop},initialize:function(e,n){var r=this,s,o,u;r.params={};t.extend(r,n||{});r.id=e;r.selector="#customize-control-"+e.replace(/\]/g,"").replace(/\[/g,"-");r.templateSelector="customize-control-"+r.params.type+"-content";r.container=r.params.content?t(r.params.content):t(r.selector);r.deferred={embedded:new t.Deferred};r.section=new i.Value;r.priority=new i.Value;r.active=new i.Value;r.activeArgumentsQueue=[];r.elements=[];s=r.container.find("[data-customize-setting-link]");o={};s.each(function(){var e=t(this),n;if(e.is(":radio")){n=e.prop("name");if(o[n])return;o[n]=!0;e=s.filter('[name="'+n+'"]')}i(e.data("customizeSettingLink"),function(t){var n=new i.Element(e);r.elements.push(n);n.sync(t);n.set(t())})});r.active.bind(function(e){var n=r.activeArgumentsQueue.shift();n=t.extend({},r.defaultActiveArguments,n);r.onChangeActive(e,n)});r.section.set(r.params.section);r.priority.set(isNaN(r.params.priority)?10:r.params.priority);r.active.set(r.params.active);i.utils.bubbleChildValueChanges(r,["section","priority","active"]);u=t.map(r.params.settings,function(e){return e});i.apply(i,u.concat(function(){var e;r.settings={};for(e in r.params.settings)r.settings[e]=i(r.params.settings[e]);r.setting=r.settings["default"]||null;r.embed()}));r.deferred.embedded.done(function(){r.ready()})},embed:function(){var e=this,t;t=function(t){var n;if(!t)return;i.section(t,function(t){t.deferred.embedded.done(function(){n=t.container.find("ul:first");if(!e.container.parent().is(n)){n.append(e.container);e.renderContent()}e.deferred.embedded.resolve()})})};e.section.bind(t);t(e.section.get())},ready:function(){},expand:function(e){i.section(this.section()).expand(e)},focus:r,onChangeActive:function(e,n){if(!t.contains(document,this.container)){this.container.toggle(e);n.completeCallback&&n.completeCallback()}else e?this.container.slideDown(n.duration,n.completeCallback):this.container.slideUp(n.duration,n.completeCallback)},toggle:function(e){return this.onChangeActive(e,this.defaultActiveArguments)},activate:n.prototype.activate,deactivate:n.prototype.deactivate,_toggleActive:n.prototype._toggleActive,dropdownInit:function(){var e=this,t=this.container.find(".dropdown-status"),n=this.params,r=!1,s=function(e){typeof e=="string"&&n.statuses&&n.statuses[e]?t.html(n.statuses[e]).show():t.hide()};this.container.on("click keydown",".dropdown",function(t){if(i.utils.isKeydownButNotEnterEvent(t))return;t.preventDefault();r||e.container.toggleClass("open");e.container.hasClass("open")&&e.container.parent().parent().find("li.library-selected").focus();r=!0;setTimeout(function(){r=!1},400)});this.setting.bind(s);s(this.setting())},renderContent:function(){var e,n=this;if(0!==t("#tmpl-"+n.templateSelector).length){e=wp.template(n.templateSelector);e&&n.container&&n.container.html(e(n.params))}}});i.ColorControl=i.Control.extend({ready:function(){var e=this,t=this.container.find(".color-picker-hex");t.val(e.setting()).wpColorPicker({change:function(){e.setting.set(t.wpColorPicker("color"))},clear:function(){e.setting.set(!1)}});this.setting.bind(function(e){t.val(e);t.wpColorPicker("color",e)})}});i.UploadControl=i.Control.extend({ready:function(){var e=this;_.bindAll(e,"restoreDefault","removeFile","openFrame","select");e.container.on("click keydown",".upload-button",e.openFrame);e.container.on("click keydown",".thumbnail-image img",e.openFrame);e.container.on("click keydown",".default-button",e.restoreDefault);e.container.on("click keydown",".remove-button",e.removeFile);e.setting.bind(function(){e.renderContent()})},openFrame:function(e){if(i.utils.isKeydownButNotEnterEvent(e))return;e.preventDefault();this.frame||this.initFrame();this.frame.open()},initFrame:function(){this.frame=wp.media({button:{text:this.params.button_labels.frame_button},states:[new wp.media.controller.Library({title:this.params.button_labels.frame_title,library:wp.media.query({type:this.params.mime_type}),multiple:!1,date:!1})]});this.frame.on("select",this.select)},select:function(){var e=this.frame.state().get("selection").first().toJSON();this.params.attachment=e;this.setting(e.url)},restoreDefault:function(e){if(i.utils.isKeydownButNotEnterEvent(e))return;e.preventDefault();this.params.attachment=this.params.defaultAttachment;this.setting(this.params.defaultAttachment.url)},removeFile:function(e){if(i.utils.isKeydownButNotEnterEvent(e))return;e.preventDefault();this.params.attachment={};this.setting("");this.renderContent()},success:function(){},removerVisibility:function(){}});i.ImageControl=i.UploadControl.extend({thumbnailSrc:function(){}});i.BackgroundControl=i.UploadControl.extend({ready:function(){i.UploadControl.prototype.ready.apply(this,arguments)},select:function(){i.UploadControl.prototype.select.apply(this,arguments);wp.ajax.post("custom-background-add",{nonce:_wpCustomizeBackground.nonces.add,wp_customize:"on",theme:i.settings.theme.stylesheet,attachment_id:this.params.attachment.id})}});i.HeaderControl=i.Control.extend({ready:function(){this.btnRemove=t("#customize-control-header_image .actions .remove");this.btnNew=t("#customize-control-header_image .actions .new");_.bindAll(this,"openMedia","removeImage");this.btnNew.on("click",this.openMedia);this.btnRemove.on("click",this.removeImage);i.HeaderTool.currentHeader=new i.HeaderTool.ImageModel;new i.HeaderTool.CurrentView({model:i.HeaderTool.currentHeader,el:"#customize-control-header_image .current .container"});new i.HeaderTool.ChoiceListView({collection:i.HeaderTool.UploadsList=new i.HeaderTool.ChoiceList,el:"#customize-control-header_image .choices .uploaded .list"});new i.HeaderTool.ChoiceListView({collection:i.HeaderTool.DefaultsList=new i.HeaderTool.DefaultsList,el:"#customize-control-header_image .choices .default .list"});i.HeaderTool.combinedList=i.HeaderTool.CombinedList=new i.HeaderTool.CombinedList([i.HeaderTool.UploadsList,i.HeaderTool.DefaultsList])},calculateImageSelectOptions:function(e,t){var n=parseInt(_wpCustomizeHeader.data.width,10),r=parseInt(_wpCustomizeHeader.data.height,10),s=!!parseInt(_wpCustomizeHeader.data["flex-width"],10),o=!!parseInt(_wpCustomizeHeader.data["flex-height"],10),u,a,f,l,c,h;c=e.get("width");l=e.get("height");this.headerImage=new i.HeaderTool.ImageModel;this.headerImage.set({themeWidth:n,themeHeight:r,themeFlexWidth:s,themeFlexHeight:o,imageWidth:c,imageHeight:l});t.set("canSkipCrop",!this.headerImage.shouldBeCropped());u=n/r;a=c;f=l;if(a/f>u){r=f;n=r*u}else{n=a;r=n/u}h={handles:!0,keys:!0,instance:!0,persistent:!0,imageWidth:c,imageHeight:l,x1:0,y1:0,x2:n,y2:r};o===!1&&s===!1&&(h.aspectRatio=n+":"+r);o===!1&&(h.maxHeight=r);s===!1&&(h.maxWidth=n);return h},openMedia:function(e){var t=_wpMediaViewsL10n;e.preventDefault();this.frame=wp.media({button:{text:t.selectAndCrop,close:!1},states:[new wp.media.controller.Library({title:t.chooseImage,library:wp.media.query({type:"image"}),multiple:!1,date:!1,priority:20,suggestedWidth:_wpCustomizeHeader.data.width,suggestedHeight:_wpCustomizeHeader.data.height}),new wp.media.controller.Cropper({imgSelectOptions:this.calculateImageSelectOptions})]});this.frame.on("select",this.onSelect,this);this.frame.on("cropped",this.onCropped,this);this.frame.on("skippedcrop",this.onSkippedCrop,this);this.frame.open()},onSelect:function(){this.frame.setState("cropper")},onCropped:function(e){var t=e.post_content,n=e.attachment_id,r=e.width,i=e.height;this.setImageFromURL(t,n,r,i)},onSkippedCrop:function(e){var t=e.get("url"),n=e.get("width"),r=e.get("height");this.setImageFromURL(t,e.id,n,r)},setImageFromURL:function(e,t,n,r){var s,o={};o.url=e;o.thumbnail_url=e;o.timestamp=_.now();t&&(o.attachment_id=t);n&&(o.width=n);r&&(o.height=r);s=new i.HeaderTool.ImageModel({header:o,choice:e.split("/").pop()});i.HeaderTool.UploadsList.add(s);i.HeaderTool.currentHeader.set(s.toJSON());s.save();s.importImage()},removeImage:function(){i.HeaderTool.currentHeader.trigger("hide");i.HeaderTool.CombinedList.trigger("control:removeImage")}});i.defaultConstructor=i.Setting;i.control=new i.Values({defaultConstructor:i.Control});i.section=new i.Values({defaultConstructor:i.Section});i.panel=new i.Values({defaultConstructor:i.Panel});i.PreviewFrame=i.Messenger.extend({sensitivity:2e3,initialize:function(e,n){var r=t.Deferred();r.promise(this);this.container=e.container;this.signature=e.signature;t.extend(e,{channel:i.PreviewFrame.uuid()});i.Messenger.prototype.initialize.call(this,e,n);this.add("previewUrl",e.previewUrl);this.query=t.extend(e.query||{},{customize_messenger_channel:this.channel()});this.run(r)},run:function(e){var n=this,r=!1,s=!1;this._ready&&this.unbind("ready",this._ready);this._ready=function(){s=!0;r&&e.resolveWith(n)};this.bind("ready",this._ready);this.bind("ready",function(e){if(!e)return;var t={panel:e.activePanels,section:e.activeSections,control:e.activeControls};_(t).each(function(e,t){i[t].each(function(t,n){var r=!!e&&!!e[n];t.active(r)})})});this.request=t.ajax(this.previewUrl(),{type:"POST",data:this.query,xhrFields:{withCredentials:!0}});this.request.fail(function(){e.rejectWith(n,["request failure"])});this.request.done(function(i){var o=n.request.getResponseHeader("Location"),u=n.signature,a;if(o&&o!==n.previewUrl()){e.rejectWith(n,["redirect",o]);return}if("0"===i){n.login(e);return}if("-1"===i){e.rejectWith(n,["cheatin"]);return}a=i.lastIndexOf(u);if(-1===a||a<i.lastIndexOf("</html>")){e.rejectWith(n,["unsigned"]);return}i=i.slice(0,a)+i.slice(a+u.length);n.iframe=t("<iframe />").appendTo(n.container);n.iframe.one("load",function(){r=!0;s?e.resolveWith(n):setTimeout(function(){e.rejectWith(n,["ready timeout"])},n.sensitivity)});n.targetWindow(n.iframe[0].contentWindow);n.targetWindow().document.open();n.targetWindow().document.write(i);n.targetWindow().document.close()})},login:function(e){var n=this,r;r=function(){e.rejectWith(n,["logged out"])};if(this.triedLogin)return r();t.get(i.settings.url.ajax,{action:"logged-in"}).fail(r).done(function(i){var s;"1"!==i&&r();s=t('<iframe src="'+n.previewUrl()+'" />').hide();s.appendTo(n.container);s.load(function(){n.triedLogin=!0;s.remove();n.run(e)})})},destroy:function(){i.Messenger.prototype.destroy.call(this);this.request.abort();this.iframe&&this.iframe.remove();delete this.request;delete this.iframe;delete this.targetWindow}});(function(){var e=0;i.PreviewFrame.uuid=function(){return"preview-"+e++}})();i.setDocumentTitle=function(e){var t,n;t=i.settings.documentTitleTmpl;n=t.replace("%s",e);document.title=n;window!==window.parent&&(window.parent.document.title=document.title)};i.Previewer=i.Messenger.extend({refreshBuffer:250,initialize:function(e,n){var r=this,s=/^https?/;t.extend(this,n||{});this.deferred={active:t.Deferred()};this.refresh=function(e){var t=e.refresh,n=function(){r=null;t.call(e)},r;return function(){if(typeof r!="number"){if(!e.loading)return n();e.abort()}clearTimeout(r);r=setTimeout(n,e.refreshBuffer)}}(this);this.container=i.ensure(e.container);this.allowedUrls=e.allowedUrls;this.signature=e.signature;e.url=window.location.href;i.Messenger.prototype.initialize.call(this,e);this.add("scheme",this.origin()).link(this.origin).setter(function(e){var t=e.match(s);return t?t[0]:""});this.add("previewUrl",e.previewUrl).setter(function(e){var n;if(/\/wp-admin(\/|$)/.test(e.replace(/[#?].*$/,"")))return null;t.each([e.replace(s,r.scheme()),e],function(e,i){t.each(r.allowedUrls,function(e,t){var r;t=t.replace(/\/+$/,"");r=i.replace(t,"");if(0===i.indexOf(t)&&/^([/#?]|$)/.test(r)){n=i;return!1}});if(n)return!1});return n?n:null});this.previewUrl.bind(this.refresh);this.scroll=0;this.bind("scroll",function(e){this.scroll=e});this.bind("url",this.previewUrl);this.bind("documentTitle",function(e){i.setDocumentTitle(e)})},query:function(){},abort:function(){if(this.loading){this.loading.destroy();delete this.loading}},refresh:function(){var e=this;this.abort();this.loading=new i.PreviewFrame({url:this.url(),previewUrl:this.previewUrl(),query:this.query()||{},container:this.container,signature:this.signature});this.loading.done(function(){this.bind("synced",function(){e.preview&&e.preview.destroy();e.preview=this;delete e.loading;e.targetWindow(this.targetWindow());e.channel(this.channel());e.deferred.active.resolve();e.send("active")});this.send("sync",{scroll:e.scroll,settings:i.get()})});this.loading.fail(function(t,n){"redirect"===t&&n&&e.previewUrl(n);if("logged out"===t){if(e.preview){e.preview.destroy();delete e.preview}e.login().done(e.refresh)}"cheatin"===t&&e.cheatin()})},login:function(){var e=this,n,r,s;if(this._login)return this._login;n=t.Deferred();this._login=n.promise();r=new i.Messenger({channel:"login",url:i.settings.url.login});s=t('<iframe src="'+i.settings.url.login+'" />').appendTo(this.container);r.targetWindow(s[0].contentWindow);r.bind("login",function(){s.remove();r.destroy();delete e._login;n.resolve()});return this._login},cheatin:function(){t(document.body).empty().addClass("cheatin").append("<p>"+i.l10n.cheatin+"</p>")}});i.controlConstructor={color:i.ColorControl,upload:i.UploadControl,image:i.ImageControl,header:i.HeaderControl,background:i.BackgroundControl};i.panelConstructor={};i.sectionConstructor={};t(function(){i.settings=window._wpCustomizeSettings;i.l10n=window._wpCustomizeControlsL10n;if(!i.settings)return;if(!t.support.postMessage||!t.support.cors&&i.settings.isCrossDomain)return window.location=i.settings.url.fallback;var e,n,r=t(document.body),s=r.children(".wp-full-overlay"),o=t("#customize-info .theme-name.site-title"),u=t(".customize-controls-close"),a=t("#save");t("#customize-controls").on("keydown",function(e){var n=13===e.which,r=t(e.target);n&&(r.is("input:not([type=button])")||r.is("select"))&&e.preventDefault()});t("#customize-info").find("> .accordion-section-title").on("click keydown",function(e){if(i.utils.isKeydownButNotEnterEvent(e))return;e.preventDefault();var n=t(this).parent(),r=n.find(".accordion-section-content:first");if(n.hasClass("cannot-expand"))return;if(n.hasClass("open")){n.toggleClass("open");r.slideUp(i.Panel.prototype.defaultExpandedArguments.duration)}else{r.slideDown(i.Panel.prototype.defaultExpandedArguments.duration);n.toggleClass("open")}});i.previewer=new i.Previewer({container:"#customize-preview",form:"#customize-controls",previewUrl:i.settings.url.preview,allowedUrls:i.settings.url.allowed,signature:"WP_CUSTOMIZER_SIGNATURE"},{nonce:i.settings.nonce,query:function(){var e={};i.each(function(t,n){t._dirty&&(e[n]=t())});return{wp_customize:"on",theme:i.settings.theme.stylesheet,customized:JSON.stringify(e),nonce:this.nonce.preview}},save:function(){var e=this,n=t.extend(this.query(),{action:"customize_save",nonce:this.nonce.save}),s=i.state("processing"),o,u;r.addClass("saving");u=function(){var s=t.post(i.settings.url.ajax,n);i.trigger("save",s);s.always(function(){r.removeClass("saving")});s.done(function(t){if("0"===t){e.preview.iframe.hide();e.login().done(function(){e.save();e.preview.iframe.show()});return}if("-1"===t){e.cheatin();return}i.each(function(e){e._dirty=!1});i.trigger("saved")})};if(0===s())u();else{o=function(){if(0===s()){i.state.unbind("change",o);u()}};i.state.bind("change",o)}}});i.previewer.bind("nonce",function(e){t.extend(this.nonce,e)});t.each(i.settings.settings,function(e,t){i.create(e,e,t.value,{transport:t.transport,previewer:i.previewer})});t.each(i.settings.panels,function(e,t){var n=i.panelConstructor[t.type]||i.Panel,r;r=new n(e,{params:t});i.panel.add(e,r)});t.each(i.settings.sections,function(e,t){var n=i.sectionConstructor[t.type]||i.Section,r;r=new n(e,{params:t});i.section.add(e,r)});t.each(i.settings.controls,function(e,t){var n=i.controlConstructor[t.type]||i.Control,r;r=new n(e,{params:t,previewer:i.previewer});i.control.add(e,r)});_.each(["panel","section","control"],function(e){var t,n=i.settings.autofocus[e];if(n&&i[e](n)){t=i[e](n);t.deferred.embedded.done(function(){i.previewer.deferred.active.done(function(){t.focus()})})}});i.reflowPaneContents=_.bind(function(){var e,n,r,s=[],o=!1;document.activeElement&&(n=t(document.activeElement));i.panel.each(function(t){var n=t.sections(),r=_.pluck(n,"container");s.push(t);e=t.container.find("ul:first");if(!i.utils.areElementListsEqual(r,e.children("[id]"))){_(n).each(function(t){e.append(t.container)});o=!0}});i.section.each(function(t){var n=t.controls(),r=_.pluck(n,"container");t.panel()||s.push(t);e=t.container.find("ul:first");if(!i.utils.areElementListsEqual(r,e.children("[id]"))){_(n).each(function(t){e.append(t.container)});o=!0}});s.sort(i.utils.prioritySort);r=_.pluck(s,"container");e=t("#customize-theme-controls").children("ul");if(!i.utils.areElementListsEqual(r,e.children())){_(s).each(function(t){e.append(t.container)});o=!0}i.panel.each(function(e){var t=e.active();e.active.callbacks.fireWith(e.active,[t,t])});i.section.each(function(e){var t=e.active();e.active.callbacks.fireWith(e.active,[t,t])});o&&n&&n.focus()},i);i.bind("ready",i.reflowPaneContents);i.reflowPaneContents=_.debounce(i.reflowPaneContents,100);t([i.panel,i.section,i.control]).each(function(e,t){t.bind("add",i.reflowPaneContents);t.bind("change",i.reflowPaneContents);t.bind("remove",i.reflowPaneContents)});i.previewer.previewUrl()?i.previewer.refresh():i.previewer.previewUrl(i.settings.url.home);(function(){var e=new i.Values,t=e.create("saved"),n=e.create("activated"),r=e.create("processing");e.bind("change",function(){if(!n()){a.val(i.l10n.activate).prop("disabled",!1);u.find(".screen-reader-text").text(i.l10n.cancel)}else if(t()){a.val(i.l10n.saved).prop("disabled",!0);u.find(".screen-reader-text").text(i.l10n.close)}else{a.val(i.l10n.save).prop("disabled",!1);u.find(".screen-reader-text").text(i.l10n.cancel)}});t(!0);n(i.settings.theme.active);r(0);i.bind("change",function(){e("saved").set(!1)});i.bind("saved",function(){e("saved").set(!0);e("activated").set(!0)});n.bind(function(e){e&&i.trigger("activated")});i.state=e})();a.click(function(e){i.previewer.save();e.preventDefault()}).keydown(function(e){if(9===e.which)return;13===e.which&&i.previewer.save();e.preventDefault()});t("#customize-header-actions").on("click keydown",".control-panel-back",function(e){if(i.utils.isKeydownButNotEnterEvent(e))return;e.preventDefault();i.panel.each(function(e){e.collapse()})});u.keydown(function(e){if(9===e.which)return;13===e.which&&this.click();e.preventDefault()});t(".collapse-sidebar").on("click keydown",function(e){if(i.utils.isKeydownButNotEnterEvent(e))return;s.toggleClass("collapsed").toggleClass("expanded");e.preventDefault()});o.length&&t("#customize-control-blogname input").on("input",function(){o.text(this.value)});e=new i.Messenger({url:i.settings.url.parent,channel:"loader"});e.bind("back",function(){u.on("click.customize-controls-close",function(t){t.preventDefault();e.send("close")})});t(window).on("beforeunload",function(){if(!i.state("saved")())return i.l10n.saveAlert});t.each(["saved","change"],function(t,n){i.bind(n,function(){e.send(n)})});i.bind("activated",function(){e.targetWindow()?e.send("activated",i.settings.url.activated):i.settings.url.activated&&(window.location=i.settings.url.activated)});e.send("ready");t.each({background_image:{controls:["background_repeat","background_position_x","background_attachment"],callback:function(e){return!!e}},show_on_front:{controls:["page_on_front","page_for_posts"],callback:function(e){return"page"===e}},header_textcolor:{controls:["header_textcolor"],callback:function(e){return"blank"!==e}}},function(e,n){i(e,function(e){t.each(n.controls,function(t,r){i.control(r,function(t){var r=function(e){t.container.toggle(n.callback(e))};r(e.get());e.bind(r)})})})});i.control("display_header_text",function(e){var t="";e.elements[0].unsync(i("header_textcolor"));e.element=new i.Element(e.container.find("input"));e.element.set("blank"!==e.setting());e.element.bind(function(n){n||(t=i("header_textcolor").get());e.setting.set(n?t:"blank")});e.setting.bind(function(t){e.element.set("blank"!==t)})});i.trigger("ready");n=u;n.focus();setTimeout(function(){n.focus()},200)})})(wp,jQuery);