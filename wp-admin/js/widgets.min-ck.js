var wpWidgets;!function(e){var t=e(document);wpWidgets={init:function(){var n,r,i=this,s=e(".widgets-chooser"),o=s.find(".widgets-chooser-sidebars"),u=e("div.widgets-sortables"),f="undefined"!=typeof isRtl&&!!isRtl;e("#widgets-right .sidebar-name").click(function(){var n=e(this),r=n.closest(".widgets-holder-wrap");r.hasClass("closed")?(r.removeClass("closed"),n.parent().sortable("refresh")):r.addClass("closed"),t.triggerHandler("wp-pin-menu")}),e("#widgets-left .sidebar-name").click(function(){e(this).closest(".widgets-holder-wrap").toggleClass("closed"),t.triggerHandler("wp-pin-menu")}),e(document.body).bind("click.widgets-toggle",function(t){var n,r,i,s,o,u=e(t.target),l={"z-index":100};u.parents(".widget-top").length&&!u.parents("#available-widgets").length?(n=u.closest("div.widget"),r=n.children(".widget-inside"),i=parseInt(n.find("input.widget-width").val(),10),s=n.parent().width(),r.is(":hidden")?(i>250&&i+30>s&&n.closest("div.widgets-sortables").length&&(o=n.closest("div.widget-liquid-right").length?f?"margin-right":"margin-left":f?"margin-left":"margin-right",l[o]=s-(i+30)+"px",n.css(l)),n.addClass("open"),r.slideDown("fast")):r.slideUp("fast",function(){n.attr("style",""),n.removeClass("open")}),t.preventDefault()):u.hasClass("widget-control-save")?(wpWidgets.save(u.closest("div.widget"),0,1,0),t.preventDefault()):u.hasClass("widget-control-remove")?(wpWidgets.save(u.closest("div.widget"),1,1,0),t.preventDefault()):u.hasClass("widget-control-close")&&(n=u.closest("div.widget"),n.removeClass("open"),wpWidgets.close(n),t.preventDefault())}),u.children(".widget").each(function(){var t=e(this);wpWidgets.appendTitle(this),t.find("p.widget-error").length&&t.find("a.widget-action").trigger("click")}),e("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:100,containment:"#wpwrap",start:function(t,n){var s=e(this).find(".widgets-chooser");n.helper.find("div.widget-description").hide(),r=this.id,s.length&&(e("#wpbody-content").append(s.hide()),n.helper.find(".widgets-chooser").remove(),i.clearWidgetSelection())},stop:function(){n&&e(n).hide(),n=""}}),u.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"#wpwrap",start:function(t,n){var r,i=e(this),s=i.parent(),o=n.item.children(".widget-inside");"block"===o.css("display")&&(o.hide(),e(this).sortable("refreshPositions")),s.hasClass("closed")||(r=n.item.hasClass("ui-draggable")?i.height():1+i.height(),i.css("min-height",r+"px"))},stop:function(i,s){var o,u,f,l,h,p,v=s.item,m=r;return v.hasClass("deleting")?(wpWidgets.save(v,1,0,1),void v.remove()):(o=v.find("input.add_new").val(),u=v.find("input.multi_number").val(),v.attr("style","").removeClass("ui-draggable"),r="",o&&("multi"===o?(v.html(v.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,u)})),v.attr("id",m.replace("__i__",u)),u++,e("div#"+m).find("input.multi_number").val(u)):"single"===o&&(v.attr("id","new-"+m),n="div#"+m),wpWidgets.save(v,0,0,1),v.find("input.add_new").val(""),t.trigger("widget-added",[v])),f=v.parent(),f.parent().hasClass("closed")&&(f.parent().removeClass("closed"),l=f.children(".widget"),l.length>1&&(h=l.get(0),p=v.get(0),h.id&&p.id&&h.id!==p.id&&e(h).before(v))),void (o?v.find("a.widget-action").trigger("click"):wpWidgets.saveOrder(f.attr("id"))))},activate:function(){e(this).parent().addClass("widget-hover")},deactivate:function(){e(this).css("min-height","").parent().removeClass("widget-hover")},receive:function(t,n){var r=e(n.sender);return this.id.indexOf("orphaned_widgets")>-1?void r.sortable("cancel"):void (r.attr("id").indexOf("orphaned_widgets")>-1&&!r.children(".widget").length&&r.parents(".orphan-sidebar").slideUp(400,function(){e(this).remove()}))}}).sortable("option","connectWith","div.widgets-sortables"),e("#available-widgets").droppable({tolerance:"pointer",accept:function(t){return"widget-list"!==e(t).parent().attr("id")},drop:function(t,n){n.draggable.addClass("deleting"),e("#removing-widget").hide().children("span").empty()},over:function(t,n){n.draggable.addClass("deleting"),e("div.widget-placeholder").hide(),n.draggable.hasClass("ui-sortable-helper")&&e("#removing-widget").show().children("span").html(n.draggable.find("div.widget-title").children("h4").html())},out:function(t,n){n.draggable.removeClass("deleting"),e("div.widget-placeholder").show(),e("#removing-widget").hide().children("span").empty()}}),e("#widgets-right .widgets-holder-wrap").each(function(t,n){var r=e(n),i=r.find(".sidebar-name h3").text(),s=r.find(".widgets-sortables").attr("id"),u=e('<li tabindex="0">').text(e.trim(i));0===t&&u.addClass("widgets-chooser-selected"),o.append(u),u.data("sidebarId",s)}),e("#available-widgets .widget .widget-title").on("click.widgets-chooser",function(){var t=e(this).closest(".widget");t.hasClass("widget-in-question")||e("#widgets-left").hasClass("chooser")?i.closeChooser():(i.clearWidgetSelection(),e("#widgets-left").addClass("chooser"),t.addClass("widget-in-question").children(".widget-description").after(s),s.slideDown(300,function(){o.find(".widgets-chooser-selected").focus()}),o.find("li").on("focusin.widgets-chooser",function(){o.find(".widgets-chooser-selected").removeClass("widgets-chooser-selected"),e(this).addClass("widgets-chooser-selected")}))}),s.on("click.widgets-chooser",function(t){var n=e(t.target);n.hasClass("button-primary")?(i.addWidget(s),i.closeChooser()):n.hasClass("button-secondary")&&i.closeChooser()}).on("keyup.widgets-chooser",function(t){t.which===e.ui.keyCode.ENTER?e(t.target).hasClass("button-secondary")?i.closeChooser():(i.addWidget(s),i.closeChooser()):t.which===e.ui.keyCode.ESCAPE&&i.closeChooser()})},saveOrder:function(t){var n={action:"widgets-order",savewidgets:e("#_wpnonce_widgets").val(),sidebars:[]};t&&e("#"+t).find(".spinner:first").addClass("is-active"),e("div.widgets-sortables").each(function(){e(this).sortable&&(n["sidebars["+e(this).attr("id")+"]"]=e(this).sortable("toArray").join(","))}),e.post(ajaxurl,n,function(){e(".spinner").removeClass("is-active")})},save:function(n,r,i,s){var o,u=n.closest("div.widgets-sortables").attr("id"),f=n.find("form").serialize();n=e(n),e(".spinner",n).addClass("is-active"),o={action:"save-widget",savewidgets:e("#_wpnonce_widgets").val(),sidebar:u},r&&(o.delete_widget=1),f+="&"+e.param(o),e.post(ajaxurl,f,function(o){var u;r?(e("input.widget_number",n).val()||(u=e("input.widget-id",n).val(),e("#available-widgets").find("input.widget-id").each(function(){e(this).val()===u&&e(this).closest("div.widget").show()})),i?(s=0,n.slideUp("fast",function(){e(this).remove(),wpWidgets.saveOrder()})):n.remove()):(e(".spinner").removeClass("is-active"),o&&o.length>2&&(e("div.widget-content",n).html(o),wpWidgets.appendTitle(n),t.trigger("widget-updated",[n]))),s&&wpWidgets.saveOrder()})},appendTitle:function(t){var n=e('input[id*="-title"]',t).val()||"";n&&(n=": "+n.replace(/<[^<>]+>/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;")),e(t).children(".widget-top").children(".widget-title").children().children(".in-widget-title").html(n)},close:function(e){e.children(".widget-inside").slideUp("fast",function(){e.attr("style","")})},addWidget:function(n){var r,i,s,o,u,f,l,c=n.find(".widgets-chooser-selected").data("sidebarId"),h=e("#"+c);r=e("#available-widgets").find(".widget-in-question").clone(),i=r.attr("id"),s=r.find("input.add_new").val(),o=r.find("input.multi_number").val(),r.find(".widgets-chooser").remove(),"multi"===s?(r.html(r.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,o)})),r.attr("id",i.replace("__i__",o)),o++,e("#"+i).find("input.multi_number").val(o)):"single"===s&&(r.attr("id","new-"+i),e("#"+i).hide()),h.closest(".widgets-holder-wrap").removeClass("closed"),h.append(r),h.sortable("refresh"),wpWidgets.save(r,0,0,1),r.find("input.add_new").val(""),t.trigger("widget-added",[r]),u=e(window).scrollTop(),f=u+e(window).height(),l=h.offset(),l.bottom=l.top+h.outerHeight(),(u>l.bottom||f<l.top)&&e("html, body").animate({scrollTop:l.top-130},200),window.setTimeout(function(){r.find(".widget-title").trigger("click")},250)},closeChooser:function(){var t=this;e(".widgets-chooser").slideUp(200,function(){e("#wpbody-content").append(this),t.clearWidgetSelection()})},clearWidgetSelection:function(){e("#widgets-left").removeClass("chooser"),e(".widget-in-question").removeClass("widget-in-question")}},t.ready(function(){wpWidgets.init()})}(jQuery);