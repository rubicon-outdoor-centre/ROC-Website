/* global _wpMediaViewsL10n, MediaElementPlayer, _wpMediaGridSettings */(function(e,t,n,r){var i=r.media,s;if(i.view.l10n)s=i.view.l10n;else{s=i.view.l10n=typeof _wpMediaViewsL10n=="undefined"?{}:_wpMediaViewsL10n;delete s.settings}i.controller.EditAttachmentMetadata=i.controller.State.extend({defaults:{id:"edit-attachment",title:s.attachmentDetails,content:"edit-metadata",menu:!1,toolbar:!1,router:!1}});i.view.MediaFrame.Manage=i.view.MediaFrame.extend({initialize:function(){var n=this;t.defaults(this.options,{title:"",modal:!1,selection:[],library:{},multiple:"add",state:"library",uploader:!0,mode:["grid","edit"]});this.$body=e(document.body);this.$window=e(window);this.$adminBar=e("#wpadminbar");this.$window.on("scroll resize",t.debounce(t.bind(this.fixPosition,this),15));e(document).on("click",".add-new-h2",t.bind(this.addNewClickHandler,this));this.$el.addClass("wp-core-ui");if(r.Uploader.limitExceeded||!r.Uploader.browser.supported)this.options.uploader=!1;if(this.options.uploader){this.uploader=(new i.view.UploaderWindow({controller:this,uploader:{dropzone:document.body,container:document.body}})).render();this.uploader.ready();e("body").append(this.uploader.el);this.options.uploader=!1}this.gridRouter=new i.view.MediaFrame.Manage.Router;i.view.MediaFrame.prototype.initialize.apply(this,arguments);this.$el.appendTo(this.options.container);this.createStates();this.bindRegionModeHandlers();this.render();e("#media-search-input").on("input",t.debounce(function(t){var r=e(t.currentTarget).val(),i="";r&&(i+="?search="+r);n.gridRouter.navigate(n.gridRouter.baseUrl(i))},1e3))},createStates:function(){var e=this.options;if(this.options.states)return;this.states.add([new i.controller.Library({library:i.query(e.library),multiple:e.multiple,title:e.title,content:"browse",toolbar:"select",contentUserSetting:!1,filterable:"all",autoSelect:!1})])},bindRegionModeHandlers:function(){this.on("content:create:browse",this.browseContent,this);this.on("edit:attachment",this.openEditAttachmentModal,this);this.on("select:activate",this.bindKeydown,this);this.on("select:deactivate",this.unbindKeydown,this)},handleKeydown:function(e){if(27===e.which){e.preventDefault();this.deactivateMode("select").activateMode("edit")}},bindKeydown:function(){this.$body.on("keydown.select",t.bind(this.handleKeydown,this))},unbindKeydown:function(){this.$body.off("keydown.select")},fixPosition:function(){var e,t;if(!this.isModeActive("select"))return;e=this.$(".attachments-browser");t=e.find(".media-toolbar");if(e.offset().top+16<this.$window.scrollTop()+this.$adminBar.height()){e.addClass("fixed");t.css("width",e.width()+"px")}else{e.removeClass("fixed");t.css("width","")}},addNewClickHandler:function(e){e.preventDefault();this.trigger("toggle:upload:attachment")},openEditAttachmentModal:function(e){r.media({frame:"edit-attachments",controller:this,library:this.state().get("library"),model:e})},browseContent:function(e){var n=this.state();this.browserView=e.view=new i.view.AttachmentsBrowser({controller:this,collection:n.get("library"),selection:n.get("selection"),model:n,sortable:n.get("sortable"),search:n.get("searchable"),filters:n.get("filterable"),display:n.get("displaySettings"),dragInfo:n.get("dragInfo"),sidebar:"errors",suggestedWidth:n.get("suggestedWidth"),suggestedHeight:n.get("suggestedHeight"),AttachmentView:n.get("AttachmentView"),scrollElement:document});this.browserView.on("ready",t.bind(this.bindDeferred,this));this.errors=r.Uploader.errors;this.errors.on("add remove reset",this.sidebarVisibility,this)},sidebarVisibility:function(){this.browserView.$(".media-sidebar").toggle(!!this.errors.length)},bindDeferred:function(){if(!this.browserView.dfd)return;this.browserView.dfd.done(t.bind(this.startHistory,this))},startHistory:function(){window.history&&window.history.pushState&&n.history.start({root:_wpMediaGridSettings.adminUrl,pushState:!0})}});i.view.Attachment.Details.TwoColumn=i.view.Attachment.Details.extend({template:i.template("attachment-details-two-column"),editAttachment:function(e){e.preventDefault();this.controller.content.mode("edit-image")},toggleSelectionHandler:function(){},render:function(){i.view.Attachment.Details.prototype.render.apply(this,arguments);i.mixin.removeAllPlayers();this.$("audio, video").each(function(e,t){var n=i.view.MediaDetails.prepareSrc(t);setTimeout(function(){new MediaElementPlayer(n,i.mixin.mejsSettings)},0)})}});i.view.MediaFrame.Manage.Router=n.Router.extend({routes:{"upload.php?item=:slug":"showItem","upload.php?search=:query":"search"},baseUrl:function(e){return"upload.php"+e},search:function(t){e("#media-search-input").val(t).trigger("input")},showItem:function(e){var t=i.frame.state().get("library"),n;n=t.findWhere({id:parseInt(e,10)});if(n)i.frame.trigger("edit:attachment",n);else{n=i.attachment(e);i.frame.listenTo(n,"change",function(e){i.frame.stopListening(n);i.frame.trigger("edit:attachment",e)});n.fetch()}}});i.view.EditImage.Details=i.view.EditImage.extend({initialize:function(e){this.editor=window.imageEdit;this.frame=e.frame;this.controller=e.controller;i.View.prototype.initialize.apply(this,arguments)},back:function(){this.frame.content.mode("edit-metadata")},save:function(){var e=this;this.model.fetch().done(function(){e.frame.content.mode("edit-metadata")})}});i.view.MediaFrame.EditAttachments=i.view.MediaFrame.extend({className:"edit-attachment-frame",template:i.template("edit-attachment-frame"),regions:["title","content"],events:{"click .left":"previousMediaItem","click .right":"nextMediaItem"},initialize:function(){i.view.Frame.prototype.initialize.apply(this,arguments);t.defaults(this.options,{modal:!0,state:"edit-attachment"});this.controller=this.options.controller;this.gridRouter=this.controller.gridRouter;this.library=this.options.library;this.options.model&&(this.model=this.options.model);this.bindHandlers();this.createStates();this.createModal();this.title.mode("default");this.toggleNav()},bindHandlers:function(){this.on("title:create:default",this.createTitle,this);this.listenTo(this.model,"change:status destroy",this.close,this);this.on("content:create:edit-metadata",this.editMetadataMode,this);this.on("content:create:edit-image",this.editImageMode,this);this.on("content:render:edit-image",this.editImageModeRender,this);this.on("close",this.detach)},createModal:function(){var n=this;if(this.options.modal){this.modal=new i.view.Modal({controller:this,title:this.options.title});this.modal.on("open",function(){e("body").on("keydown.media-modal",t.bind(n.keyEvent,n))});this.modal.on("close",function(){n.modal.remove();e("body").off("keydown.media-modal");e('li.attachment[data-id="'+n.model.get("id")+'"]').focus();n.resetRoute()});this.modal.content(this);this.modal.open()}},createStates:function(){this.states.add([new i.controller.EditAttachmentMetadata({model:this.model})])},editMetadataMode:function(e){e.view=new i.view.Attachment.Details.TwoColumn({controller:this,model:this.model});e.view.views.set(".attachment-compat",new i.view.AttachmentCompat({controller:this,model:this.model}));this.model&&this.gridRouter.navigate(this.gridRouter.baseUrl("?item="+this.model.id))},editImageMode:function(e){var t=new i.controller.EditImage({model:this.model,frame:this});t._toolbar=function(){};t._router=function(){};t._menu=function(){};e.view=new i.view.EditImage.Details({model:this.model,frame:this,controller:t})},editImageModeRender:function(e){e.on("ready",e.loadEditor)},toggleNav:function(){this.$(".left").toggleClass("disabled",!this.hasPrevious());this.$(".right").toggleClass("disabled",!this.hasNext())},rerender:function(){this.content.mode()!=="edit-metadata"?this.content.mode("edit-metadata"):this.content.render();this.toggleNav()},previousMediaItem:function(){if(!this.hasPrevious()){this.$(".left").blur();return}this.model=this.library.at(this.getCurrentIndex()-1);this.rerender();this.$(".left").focus()},nextMediaItem:function(){if(!this.hasNext()){this.$(".right").blur();return}this.model=this.library.at(this.getCurrentIndex()+1);this.rerender();this.$(".right").focus()},getCurrentIndex:function(){return this.library.indexOf(this.model)},hasNext:function(){return this.getCurrentIndex()+1<this.library.length},hasPrevious:function(){return this.getCurrentIndex()-1>-1},keyEvent:function(e){if(("INPUT"===e.target.nodeName||"TEXTAREA"===e.target.nodeName)&&!e.target.readOnly&&!e.target.disabled)return;39===e.keyCode&&this.nextMediaItem();37===e.keyCode&&this.previousMediaItem()},resetRoute:function(){this.gridRouter.navigate(this.gridRouter.baseUrl(""))}});i.view.SelectModeToggleButton=i.view.Button.extend({initialize:function(){i.view.Button.prototype.initialize.apply(this,arguments);this.listenTo(this.controller,"select:activate select:deactivate",this.toggleBulkEditHandler);this.listenTo(this.controller,"selection:action:done",this.back)},back:function(){this.controller.deactivateMode("select").activateMode("edit")},click:function(){i.view.Button.prototype.click.apply(this,arguments);this.controller.isModeActive("select")?this.back():this.controller.deactivateMode("edit").activateMode("select")},render:function(){i.view.Button.prototype.render.apply(this,arguments);this.$el.addClass("select-mode-toggle-button");return this},toggleBulkEditHandler:function(){var e=this.controller.content.get().toolbar,t;t=e.$(".media-toolbar-secondary > *, .media-toolbar-primary > *");if(this.controller.isModeActive("select")){this.model.set("text",s.cancelSelection);t.not(".media-button").hide();this.$el.show();e.$(".delete-selected-button").removeClass("hidden")}else{this.model.set("text",s.bulkSelect);this.controller.content.get().$el.removeClass("fixed");e.$el.css("width","");e.$(".delete-selected-button").addClass("hidden");t.not(".spinner, .media-button").show();this.controller.state().get("selection").reset()}}});i.view.DeleteSelectedButton=i.view.Button.extend({initialize:function(){i.view.Button.prototype.initialize.apply(this,arguments);this.options.filters&&this.listenTo(this.options.filters.model,"change",this.filterChange);this.listenTo(this.controller,"selection:toggle",this.toggleDisabled)},filterChange:function(e){"trash"===e.get("status")?this.model.set("text",s.untrashSelected):i.view.settings.mediaTrash?this.model.set("text",s.trashSelected):this.model.set("text",s.deleteSelected)},toggleDisabled:function(){this.model.set("disabled",!this.controller.state().get("selection").length)},render:function(){i.view.Button.prototype.render.apply(this,arguments);this.controller.isModeActive("select")?this.$el.addClass("delete-selected-button"):this.$el.addClass("delete-selected-button hidden");this.toggleDisabled();return this}});i.view.DeleteSelectedPermanentlyButton=i.view.DeleteSelectedButton.extend({initialize:function(){i.view.DeleteSelectedButton.prototype.initialize.apply(this,arguments);this.listenTo(this.controller,"select:activate",this.selectActivate);this.listenTo(this.controller,"select:deactivate",this.selectDeactivate)},filterChange:function(e){this.canShow="trash"===e.get("status")},selectActivate:function(){this.toggleDisabled();this.$el.toggleClass("hidden",!this.canShow)},selectDeactivate:function(){this.toggleDisabled();this.$el.addClass("hidden")},render:function(){i.view.Button.prototype.render.apply(this,arguments);this.selectActivate();return this}})})(jQuery,_,Backbone,wp);