/* global tinymce *//**
 * WordPress View plugin.
 */tinymce.PluginManager.add("wpview",function(e){function g(e){return y(e,"wpview-wrap")}function y(e,t){while(e&&e.parentNode){if(e.className&&(" "+e.className+" ").indexOf(" "+t+" ")!==-1)return e;e=e.parentNode}return!1}function b(e){e.stopPropagation()}function w(t,n){var r=t?"before":"after",i=t?0:1;T();e.selection.setCursorLocation(e.dom.select(".wpview-selection-"+r,n)[0],i);e.nodeChanged()}function E(t,n,s){var o=e.dom,u=o.create("p");r.ie&&r.ie<11||(u.innerHTML='<br data-mce-bogus="1">');n?t.parentNode.insertBefore(u,t):o.insertAfter(u,t);T();n&&s===i.ENTER?w(n,t):e.selection.setCursorLocation(u,0);e.nodeChanged()}function S(t){e.undoManager.transact(function(){E(t);wp.mce.views.remove(e,t)})}function x(t){var r,i=e.dom;if(!t)return;if(t!==n){e.getBody().focus();T();n=t;i.setAttrib(t,"data-mce-selected",1);r=i.create("div",{"class":"wpview-clipboard",contenteditable:"true"},wp.mce.views.getText(t));e.dom.select(".wpview-body",t)[0].appendChild(r);i.bind(r,"beforedeactivate focusin focusout",b);i.bind(n,"beforedeactivate focusin focusout",b);f?e.selection.select(r):e.selection.select(r,!0)}e.nodeChanged();e.fire("wpview-selected",t)}function T(){var t,r=e.dom;if(n){t=e.dom.select(".wpview-clipboard",n)[0];r.unbind(t);r.remove(t);r.unbind(n,"beforedeactivate focusin focusout click mouseup",b);r.setAttrib(n,"data-mce-selected",null)}n=null}function N(e,t){return"<p>"+window.decodeURIComponent(t)+"</p>"}function C(e){return e.replace(/<div[^>]+data-wpview-text="([^"]+)"[^>]*>(?:[\s\S]+?wpview-selection-after[^>]+>[^<>]*<\/p>\s*|\.)<\/div>/g,N).replace(/<p [^>]*?data-wpview-marker="([^"]+)"[^>]*>[\s\S]*?<\/p>/g,N)}function k(e){t("div[data-wpview-text], p[data-wpview-marker]",e).each(function(e,t){t.innerHTML="."})}function L(e){return e<=47&&e!==i.SPACEBAR&&e!==i.ENTER&&e!==i.DELETE&&e!==i.BACKSPACE&&(e<37||e>40)||e>=224||e>=144&&e<=150||e>=91&&e<=93||e>=112&&e<=135}var t=e.$,n,r=tinymce.Env,i=tinymce.util.VK,s=tinymce.dom.TreeWalker,o=!1,u=!0,a=function(){return!1},f=/iPad|iPod|iPhone/.test(navigator.userAgent),l,c,h,p,d,v,m;if(typeof wp=="undefined"||!wp.mce)return{getView:a};e.on("BeforeAddUndo",function(e){e.level.content&&(e.level.content=C(e.level.content))});e.on("BeforeSetContent",function(r){var i;r.selection||wp.mce.views.unbind();if(!r.content)return;if(!r.load){n&&S(n);i=e.selection.getNode();if(i&&i!==e.getBody()&&/^\s*https?:\/\/\S+\s*$/i.test(r.content)){i=e.dom.getParent(i,"p");if(!i||!/^[\s\uFEFF\u00A0]*$/.test(t(i).text()||""))return;i.innerHTML=""}}r.content=wp.mce.views.setMarkers(r.content)});e.on("pastePreProcess",function(e){var t=e.content;if(t){t=tinymce.trim(t.replace(/<[^>]+>/g,""));/^https?:\/\/\S+$/i.test(t)&&(e.content=t)}});e.on("SetContent",function(){wp.mce.views.render()});e.on("click",function(t){var n=t.clientX,r=t.clientY,i=e.getBody(),s=i.getBoundingClientRect(),o=i.firstChild,u=i.lastChild,a,f,l;if(!o||!u)return;a=o.getBoundingClientRect();f=u.getBoundingClientRect();if(r<a.top&&(l=g(o))){w(!0,l);t.preventDefault()}else if(r>f.bottom&&(l=g(u))){w(!1,l);t.preventDefault()}else(n<s.left||n>s.right)&&tinymce.each(e.dom.select(".wpview-wrap"),function(e){var i=e.getBoundingClientRect();if(r<i.top)return!1;if(r>=i.top&&r<=i.bottom){if(n<s.left){w(!0,e);t.preventDefault()}else if(n>s.right){w(!1,e);t.preventDefault()}return!1}})});e.on("init",function(){var t=!1,n=e.selection,r=window.MutationObserver||window.WebKitMutationObserver;e.on("BeforeSetContent",function(){var t,r,i=g(n.getNode());if(!i)return;if(!i.nextSibling||g(i.nextSibling)){r=e.getDoc().createTextNode("");e.dom.insertAfter(r,i)}else{t=new s(i.nextSibling,i.nextSibling);r=t.next()}n.select(r);n.collapse(!0)});e.dom.bind(e.getDoc(),"touchmove",function(){t=!0});e.on("mousedown mouseup click touchend",function(e){var n=g(e.target);u=!1;if(n){e.stopImmediatePropagation();e.preventDefault();e.type==="touchend"&&t?t=!1:x(n);return!1}(e.type==="touchend"||e.type==="mousedown")&&T();e.type==="touchend"&&t&&(t=!1)},!0);r&&(new r(function(){e.fire("wp-body-class-change")})).observe(e.getBody(),{attributes:!0,attributeFilter:["class"]})});e.on("PreProcess",function(e){k(e.node)},!0);e.on("hide",function(){wp.mce.views.unbind();T();k()});e.on("PostProcess",function(e){e.content&&(e.content=e.content.replace(/<div [^>]*?data-wpview-text="([^"]+)"[^>]*>[\s\S]*?<\/div>/g,N).replace(/<p [^>]*?data-wpview-marker="([^"]+)"[^>]*>[\s\S]*?<\/p>/g,N))});e.on("keydown",function(t){var r=t.keyCode,s=e.dom,u=e.selection,a,f,l,h,p,d,v;if(n){if((t.metaKey||t.ctrlKey)&&r!==i.BACKSPACE&&r!==86||r>=112&&r<=123){(t.metaKey||t.ctrlKey)&&r===88&&(o=n);return}f=g(u.getNode());if(f!==n){T();return}if(r===i.LEFT){w(!0,f);t.preventDefault()}else if(r===i.UP){if(f.previousSibling)if(g(f.previousSibling))w(!0,f.previousSibling);else{T();u.select(f.previousSibling,!0);u.collapse()}else w(!0,f);t.preventDefault()}else if(r===i.RIGHT){w(!1,f);t.preventDefault()}else if(r===i.DOWN){if(f.nextSibling)if(g(f.nextSibling))w(!1,f.nextSibling);else{T();u.setCursorLocation(f.nextSibling,0)}else w(!1,f);t.preventDefault()}else if(!L(r)){S(n);(r===i.ENTER||r===i.DELETE||r===i.BACKSPACE)&&t.preventDefault()}}else{if(t.metaKey||t.ctrlKey||r>=112&&r<=123)return;a=u.getNode();c=a;f=g(a);if(!u.isCollapsed()){p=u.getRng();if(f=g(p.endContainer)){d=p.cloneRange();u.select(f.previousSibling,!0);u.collapse();v=u.getRng();d.setEnd(v.endContainer,v.endOffset);u.setRng(d)}else if(f=g(p.startContainer)){d=p.cloneRange();d.setStart(f.nextSibling,0);u.setRng(d)}}if(!f){if(t.keyCode===i.BACKSPACE)if(e.dom.isEmpty(a)){if(f=g(a.previousSibling)){w(!1,f);e.dom.remove(a);t.preventDefault()}}else if((p=u.getRng())&&p.startOffset===0&&p.endOffset===0&&(f=g(a.previousSibling))){w(!1,f);t.preventDefault()}return}if(!(l=s.hasClass(f,"wpview-selection-before"))&&!(h=s.hasClass(f,"wpview-selection-after")))return;if(L(r))return;if(h&&r===i.UP||l&&r===i.BACKSPACE){if(f.previousSibling)if(g(f.previousSibling))w(!1,f.previousSibling);else if(s.isEmpty(f.previousSibling)&&r===i.BACKSPACE)s.remove(f.previousSibling);else{u.select(f.previousSibling,!0);u.collapse()}else w(!0,f);t.preventDefault()}else if(!h||r!==i.DOWN&&r!==i.RIGHT)if(!l||r!==i.UP&&r!==i.LEFT)if(l&&r===i.DOWN){f.nextSibling?g(f.nextSibling)?w(!0,f.nextSibling):u.setCursorLocation(f.nextSibling,0):w(!1,f);t.preventDefault()}else if(h&&r===i.LEFT||l&&r===i.RIGHT){x(f);t.preventDefault()}else if(h&&r===i.BACKSPACE){S(f);t.preventDefault()}else h?E(f):l&&E(f,!0,r);else{if(f.previousSibling)if(g(f.previousSibling))w(r===i.UP,f.previousSibling);else{u.select(f.previousSibling,!0);u.collapse()}t.preventDefault()}else{f.nextSibling&&(g(f.nextSibling)?w(r===i.RIGHT,f.nextSibling):u.setCursorLocation(f.nextSibling,0));t.preventDefault()}r===i.ENTER&&t.preventDefault()}});e.on("keyup",function(){if(o){S(o);o=!1}});e.on("focus",function(){var t;p=!0;e.dom.addClass(e.getBody(),"has-focus");u&&(t=g(e.getBody().firstChild))&&w(!0,t);u=!1});e.on("blur",function(){p=!1;e.dom.removeClass(e.getBody(),"has-focus")});e.on("NodeChange",function(t){var n=e.dom,r=e.dom.select(".wpview-wrap"),i=t.element.className,s=g(t.element),o=c;c=!1;clearInterval(l);tinymce.each(r,function(e){e.className&&(e.className=e.className.replace(/ ?\bwpview-(?:selection-before|selection-after|cursor-hide)\b/g,""))});if(p&&s)if(i!=="wpview-selection-before"&&i!=="wpview-selection-after"||!e.selection.isCollapsed()){if(!y(t.element,"wpview-clipboard")&&!h){T();h++;w(!0,s)}}else{h=0;T();if(o===s.previousSibling){w(!0,s);return}if(o===s.nextSibling){w(!1,s);return}n.addClass(s,i);l=setInterval(function(){n.hasClass(s,"wpview-cursor-hide")?n.removeClass(s,"wpview-cursor-hide"):n.addClass(s,"wpview-cursor-hide")},500)}});e.on("BeforeExecCommand",function(){var t=e.selection.getNode(),n;if(t&&((v=t.className==="wpview-selection-before")||t.className==="wpview-selection-after")&&(n=g(t))){E(n,v);d=n}});e.on("ExecCommand",function(){var t,r;if(n){t=n;T();x(t)}if(d){r=d[v?"previousSibling":"nextSibling"];if(r&&r.nodeName==="P"&&e.dom.isEmpty(r)){e.dom.remove(r);w(v,d)}d=!1}});e.on("ResolveName",function(t){if(e.dom.hasClass(t.target,"wpview-wrap")){t.name=e.dom.getAttrib(t.target,"data-wpview-type")||"wpview";t.stopPropagation()}else if(g(t.target)){t.preventDefault();t.stopPropagation()}});e.addButton("wp_view_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",onclick:function(){n&&wp.mce.views.edit(e,n)}});e.addButton("wp_view_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){n&&S(n)}});e.once("preinit",function(){m=e.wp._createToolbar(["wp_view_edit","wp_view_remove"])});e.on("wptoolbar",function(e){if(n){e.element=n;e.toolbar=m}});e.wp=e.wp||{};e.wp.getView=g;return{getView:g}});