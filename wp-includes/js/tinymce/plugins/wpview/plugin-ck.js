/* global tinymce *//**
 * WordPress View plugin.
 */tinymce.PluginManager.add("wpview",function(e){function v(e){return m(e,"wpview-wrap")}function m(e,t){while(e&&e.parentNode){if(e.className&&(" "+e.className+" ").indexOf(" "+t+" ")!==-1)return e;e=e.parentNode}return!1}function g(t){return(t=v(t))?window.decodeURIComponent(e.dom.getAttrib(t,"data-wpview-text")||""):""}function y(t,n){t=v(t);if(t){e.dom.setAttrib(t,"data-wpview-text",window.encodeURIComponent(n||""));return!0}return!1}function b(e){e.stopPropagation()}function w(t,n){var r=t?"before":"after",i=t?0:1;T();e.selection.setCursorLocation(e.dom.select(".wpview-selection-"+r,n)[0],i);e.nodeChanged()}function E(t,i,s){var o=e.dom,u=o.create("p");n.ie&&n.ie<11||(u.innerHTML='<br data-mce-bogus="1">');i?t.parentNode.insertBefore(u,t):o.insertAfter(u,t);T();i&&s===r.ENTER?w(i,t):e.selection.setCursorLocation(u,0);e.nodeChanged()}function S(t){e.undoManager.transact(function(){E(t);e.dom.remove(t)})}function x(n){var r,i=e.dom;if(!n||n===t)return;e.getBody().focus();T();t=n;i.setAttrib(n,"data-mce-selected",1);r=i.create("div",{"class":"wpview-clipboard",contenteditable:"true"},g(n));e.dom.select(".wpview-body",n)[0].appendChild(r);i.bind(r,"beforedeactivate focusin focusout",b);i.bind(t,"beforedeactivate focusin focusout",b);a?e.selection.select(r):e.selection.select(r,!0);e.nodeChanged();e.fire("wpview-selected",n)}function T(){var n,r=e.dom;if(t){n=e.dom.select(".wpview-clipboard",t)[0];r.unbind(n);r.remove(n);r.unbind(t,"beforedeactivate focusin focusout click mouseup",b);r.setAttrib(t,"data-mce-selected",null)}t=null}function N(e){return e.replace(/<div[^>]+data-wpview-text=\"([^"]+)"[^>]*>[\s\S]+?wpview-selection-after[^>]+>(?:&nbsp;|\u00a0)*<\/p><\/div>/g,"$1")}function C(e){return e<=47&&e!==r.SPACEBAR&&e!==r.ENTER&&e!==r.DELETE&&e!==r.BACKSPACE&&(e<37||e>40)||e>=224||e>=144&&e<=150||e>=91&&e<=93||e>=112&&e<=135}var t,n=tinymce.Env,r=tinymce.util.VK,i=tinymce.dom.TreeWalker,s=!1,o=!0,u=function(){return!1},a=/iPad|iPod|iPhone/.test(navigator.userAgent),f,l,c,h,p,d;if(typeof wp=="undefined"||!wp.mce)return{getViewText:u,setViewText:u,getView:u};e.on("BeforeAddUndo",function(e){e.lastLevel&&N(e.level.content)===N(e.lastLevel.content)&&e.preventDefault()});e.on("BeforeSetContent",function(n){var r;if(!n.content)return;t&&S(t);r=e.selection.getNode();if(n.content.match(/^\s*(https?:\/\/[^\s"]+)\s*$/i)&&(r.nodeName!=="P"||r.parentNode!==e.getBody()||!e.dom.isEmpty(r)))return;n.content=wp.mce.views.toViews(n.content)});e.on("SetContent",function(){wp.mce.views.render()});e.on("click",function(t){var n=t.clientX,r=t.clientY,i=e.getBody(),s=i.getBoundingClientRect(),o=i.firstChild,u=o.getBoundingClientRect(),a=i.lastChild,f=a.getBoundingClientRect(),l;if(r<u.top&&(l=v(o))){w(!0,l);t.preventDefault()}else if(r>f.bottom&&(l=v(a))){w(!1,l);t.preventDefault()}else tinymce.each(e.dom.select(".wpview-wrap"),function(e){var i=e.getBoundingClientRect();if(r>=i.top&&r<=i.bottom){if(n<s.left){w(!0,e);t.preventDefault()}else if(n>s.right){w(!1,e);t.preventDefault()}return}})});e.on("init",function(){var t=!1,n=e.selection,r=window.MutationObserver||window.WebKitMutationObserver;e.on("BeforeSetContent",function(){var t,r,s=v(n.getNode());if(!s)return;if(!s.nextSibling||v(s.nextSibling)){r=e.getDoc().createTextNode("");e.dom.insertAfter(r,s)}else{t=new i(s.nextSibling,s.nextSibling);r=t.next()}n.select(r);n.collapse(!0)});e.dom.bind(e.getDoc(),"touchmove",function(){t=!0});e.on("mousedown mouseup click touchend",function(n){var r=v(n.target);o=!1;if(r){n.stopImmediatePropagation();n.preventDefault();if((n.type==="touchend"||n.type==="mousedown")&&!n.metaKey&&!n.ctrlKey){if(e.dom.hasClass(n.target,"edit")){wp.mce.views.edit(r);e.focus();return!1}if(e.dom.hasClass(n.target,"remove")){S(r);return!1}}n.type==="touchend"&&t?t=!1:x(r);return!1}(n.type==="touchend"||n.type==="mousedown")&&T();n.type==="touchend"&&t&&(t=!1)},!0);r&&(new r(function(){e.fire("wp-body-class-change")})).observe(e.getBody(),{attributes:!0,attributeFilter:["class"]})});e.on("PreProcess",function(t){tinymce.each(e.dom.select("div[data-wpview-text]",t.node),function(e){e.textContent=e.innerText="Â "})});e.on("PostProcess",function(e){e.content&&(e.content=e.content.replace(/<div [^>]*?data-wpview-text="([^"]*)"[^>]*>[\s\S]*?<\/div>/g,function(e,t){return t?"<p>"+window.decodeURIComponent(t)+"</p>":""}))});e.on("keydown",function(n){var i=n.keyCode,o=e.dom,u=e.selection,a,f,c,h,p,d,m;if(t){if((n.metaKey||n.ctrlKey)&&i!==r.BACKSPACE&&i!==86||i>=112&&i<=123){(n.metaKey||n.ctrlKey)&&i===88&&(s=t);return}f=v(u.getNode());if(f!==t){T();return}if(i===r.LEFT){w(!0,f);n.preventDefault()}else if(i===r.UP){if(f.previousSibling)if(v(f.previousSibling))w(!0,f.previousSibling);else{T();u.select(f.previousSibling,!0);u.collapse()}else w(!0,f);n.preventDefault()}else if(i===r.RIGHT){w(!1,f);n.preventDefault()}else if(i===r.DOWN){if(f.nextSibling)if(v(f.nextSibling))w(!1,f.nextSibling);else{T();u.setCursorLocation(f.nextSibling,0)}else w(!1,f);n.preventDefault()}else if(!C(i)){S(t);(i===r.ENTER||i===r.DELETE||i===r.BACKSPACE)&&n.preventDefault()}}else{if(n.metaKey||n.ctrlKey||i>=112&&i<=123)return;a=u.getNode();l=a;f=v(a);if(!u.isCollapsed()){p=u.getRng();if(f=v(p.endContainer)){d=p.cloneRange();u.select(f.previousSibling,!0);u.collapse();m=u.getRng();d.setEnd(m.endContainer,m.endOffset);u.setRng(d)}else if(f=v(p.startContainer)){d=p.cloneRange();d.setStart(f.nextSibling,0);u.setRng(d)}}if(!f){if(n.keyCode===r.BACKSPACE)if(e.dom.isEmpty(a)){if(f=v(a.previousSibling)){w(!1,f);e.dom.remove(a);n.preventDefault()}}else if((p=u.getRng())&&p.startOffset===0&&p.endOffset===0&&(f=v(a.previousSibling))){w(!1,f);n.preventDefault()}return}if(!(c=o.hasClass(f,"wpview-selection-before"))&&!(h=o.hasClass(f,"wpview-selection-after")))return;if(C(i))return;if(h&&i===r.UP||c&&i===r.BACKSPACE){if(f.previousSibling)if(v(f.previousSibling))w(!1,f.previousSibling);else if(o.isEmpty(f.previousSibling)&&i===r.BACKSPACE)o.remove(f.previousSibling);else{u.select(f.previousSibling,!0);u.collapse()}else w(!0,f);n.preventDefault()}else if(!h||i!==r.DOWN&&i!==r.RIGHT)if(!c||i!==r.UP&&i!==r.LEFT)if(c&&i===r.DOWN){f.nextSibling?v(f.nextSibling)?w(!0,f.nextSibling):u.setCursorLocation(f.nextSibling,0):w(!1,f);n.preventDefault()}else if(h&&i===r.LEFT||c&&i===r.RIGHT){x(f);n.preventDefault()}else if(h&&i===r.BACKSPACE){S(f);n.preventDefault()}else h?E(f):c&&E(f,!0,i);else{if(f.previousSibling)if(v(f.previousSibling))w(i===r.UP,f.previousSibling);else{u.select(f.previousSibling,!0);u.collapse()}n.preventDefault()}else{f.nextSibling&&(v(f.nextSibling)?w(i===r.RIGHT,f.nextSibling):u.setCursorLocation(f.nextSibling,0));n.preventDefault()}i===r.ENTER&&n.preventDefault()}});e.on("keyup",function(){if(s){S(s);s=!1}});e.on("focus",function(){var t;h=!0;e.dom.addClass(e.getBody(),"has-focus");o&&(t=v(e.getBody().firstChild))&&w(!0,t);o=!1});e.on("blur",function(){h=!1;e.dom.removeClass(e.getBody(),"has-focus")});e.on("NodeChange",function(t){var n=e.dom,r=e.dom.select(".wpview-wrap"),i=t.element.className,s=v(t.element),o=l;l=!1;clearInterval(f);tinymce.each(r,function(e){e.className&&(e.className=e.className.replace(/ ?\bwpview-(?:selection-before|selection-after|cursor-hide)\b/g,""))});if(h&&s)if(i!=="wpview-selection-before"&&i!=="wpview-selection-after"||!e.selection.isCollapsed()){if(!m(t.element,"wpview-clipboard")&&!c){T();c++;w(!0,s)}}else{c=0;T();if(o===s.previousSibling){w(!0,s);return}if(o===s.nextSibling){w(!1,s);return}n.addClass(s,i);f=setInterval(function(){n.hasClass(s,"wpview-cursor-hide")?n.removeClass(s,"wpview-cursor-hide"):n.addClass(s,"wpview-cursor-hide")},500)}});e.on("BeforeExecCommand",function(){var t=e.selection.getNode(),n;if(t&&((d=t.className==="wpview-selection-before")||t.className==="wpview-selection-after")&&(n=v(t))){E(n,d);p=n}});e.on("ExecCommand",function(){var n,r;if(t){n=t;T();x(n)}if(p){r=p[d?"previousSibling":"nextSibling"];if(r&&r.nodeName==="P"&&e.dom.isEmpty(r)){e.dom.remove(r);w(d,p)}p=!1}});e.on("ResolveName",function(t){if(e.dom.hasClass(t.target,"wpview-wrap")){t.name=e.dom.getAttrib(t.target,"data-wpview-type")||"wpview";t.stopPropagation()}else if(v(t.target)){t.preventDefault();t.stopPropagation()}});return{getViewText:g,setViewText:y,getView:v}});