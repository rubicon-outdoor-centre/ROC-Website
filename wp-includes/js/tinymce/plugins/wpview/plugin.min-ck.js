tinymce.PluginManager.add("wpview",function(e){function t(e){return n(e,"wpview-wrap")}function n(e,t){for(;e&&e.parentNode;){if(e.className&&-1!==(" "+e.className+" ").indexOf(" "+t+" "))return e;e=e.parentNode}return!1}function r(e){e.stopPropagation()}function i(t,n){var r=t?"before":"after",i=t?0:1;a(),e.selection.setCursorLocation(e.dom.select(".wpview-selection-"+r,n)[0],i),e.nodeChanged()}function s(t,n,r){var s=e.dom,o=s.create("p");S.ie&&S.ie<11||(o.innerHTML='<br data-mce-bogus="1">'),n?t.parentNode.insertBefore(o,t):s.insertAfter(o,t),a(),n&&r===x.ENTER?i(n,t):e.selection.setCursorLocation(o,0),e.nodeChanged()}function o(t){e.undoManager.transact(function(){s(t),wp.mce.views.remove(e,t)})}function u(t){var n,i=e.dom;t&&(t!==p&&(e.getBody().focus(),a(),p=t,i.setAttrib(t,"data-mce-selected",1),n=i.create("div",{"class":"wpview-clipboard",contenteditable:"true"},wp.mce.views.getText(t)),e.dom.select(".wpview-body",t)[0].appendChild(n),i.bind(n,"beforedeactivate focusin focusout",r),i.bind(p,"beforedeactivate focusin focusout",r),L?e.selection.select(n):e.selection.select(n,!0)),e.nodeChanged(),e.fire("wpview-selected",t))}function a(){var t,n=e.dom;p&&(t=e.dom.select(".wpview-clipboard",p)[0],n.unbind(t),n.remove(t),n.unbind(p,"beforedeactivate focusin focusout click mouseup",r),n.setAttrib(p,"data-mce-selected",null)),p=null}function f(e,t){return"<p>"+window.decodeURIComponent(t)+"</p>"}function l(e){return e.replace(/<div[^>]+data-wpview-text="([^"]+)"[^>]*>(?:[\s\S]+?wpview-selection-after[^>]+>[^<>]*<\/p>\s*|\.)<\/div>/g,f).replace(/<p [^>]*?data-wpview-marker="([^"]+)"[^>]*>[\s\S]*?<\/p>/g,f)}function c(e){E("div[data-wpview-text], p[data-wpview-marker]",e).each(function(e,t){t.innerHTML="."})}function h(e){return 47>=e&&e!==x.SPACEBAR&&e!==x.ENTER&&e!==x.DELETE&&e!==x.BACKSPACE&&(37>e||e>40)||e>=224||e>=144&&150>=e||e>=91&&93>=e||e>=112&&135>=e}var p,d,v,m,g,y,b,w,E=e.$,S=tinymce.Env,x=tinymce.util.VK,T=tinymce.dom.TreeWalker,N=!1,C=!0,k=function(){return!1},L=/iPad|iPod|iPhone/.test(navigator.userAgent);return"undefined"!=typeof wp&&wp.mce?(e.on("BeforeAddUndo",function(e){e.level.content&&(e.level.content=l(e.level.content))}),e.on("BeforeSetContent",function(t){var n;if(t.selection||wp.mce.views.unbind(),t.content){if(!t.load&&(p&&o(p),n=e.selection.getNode(),n&&n!==e.getBody()&&/^\s*https?:\/\/\S+\s*$/i.test(t.content))){if(n=e.dom.getParent(n,"p"),!n||!/^[\s\uFEFF\u00A0]*$/.test(E(n).text()||""))return;n.innerHTML=""}t.content=wp.mce.views.setMarkers(t.content)}}),e.on("pastePreProcess",function(e){var t=e.content;t&&(t=tinymce.trim(t.replace(/<[^>]+>/g,"")),/^https?:\/\/\S+$/i.test(t)&&(e.content=t))}),e.on("SetContent",function(){wp.mce.views.render()}),e.on("click",function(n){var r,s,o,u=n.clientX,a=n.clientY,f=e.getBody(),l=f.getBoundingClientRect(),c=f.firstChild,h=f.lastChild;c&&h&&(r=c.getBoundingClientRect(),s=h.getBoundingClientRect(),a<r.top&&(o=t(c))?(i(!0,o),n.preventDefault()):a>s.bottom&&(o=t(h))?(i(!1,o),n.preventDefault()):(u<l.left||u>l.right)&&tinymce.each(e.dom.select(".wpview-wrap"),function(e){var t=e.getBoundingClientRect();return a<t.top?!1:a>=t.top&&a<=t.bottom?(u<l.left?(i(!0,e),n.preventDefault()):u>l.right&&(i(!1,e),n.preventDefault()),!1):void 0}))}),e.on("init",function(){var n=!1,r=e.selection,i=window.MutationObserver||window.WebKitMutationObserver;e.on("BeforeSetContent",function(){var n,i,s=t(r.getNode());s&&(!s.nextSibling||t(s.nextSibling)?(i=e.getDoc().createTextNode(""),e.dom.insertAfter(i,s)):(n=new T(s.nextSibling,s.nextSibling),i=n.next()),r.select(i),r.collapse(!0))}),e.dom.bind(e.getDoc(),"touchmove",function(){n=!0}),e.on("mousedown mouseup click touchend",function(e){var r=t(e.target);return C=!1,r?(e.stopImmediatePropagation(),e.preventDefault(),"touchend"===e.type&&n?n=!1:u(r),!1):(("touchend"===e.type||"mousedown"===e.type)&&a(),void ("touchend"===e.type&&n&&(n=!1)))},!0),i&&(new i(function(){e.fire("wp-body-class-change")})).observe(e.getBody(),{attributes:!0,attributeFilter:["class"]})}),e.on("PreProcess",function(e){c(e.node)},!0),e.on("hide",function(){wp.mce.views.unbind(),a(),c()}),e.on("PostProcess",function(e){e.content&&(e.content=e.content.replace(/<div [^>]*?data-wpview-text="([^"]+)"[^>]*>[\s\S]*?<\/div>/g,f).replace(/<p [^>]*?data-wpview-marker="([^"]+)"[^>]*>[\s\S]*?<\/p>/g,f))}),e.on("keydown",function(n){var r,f,l,c,d,m,g,y=n.keyCode,b=e.dom,w=e.selection;if(p){if((n.metaKey||n.ctrlKey)&&y!==x.BACKSPACE&&86!==y||y>=112&&123>=y)return void ((n.metaKey||n.ctrlKey)&&88===y&&(N=p));if(f=t(w.getNode()),f!==p)return void a();y===x.LEFT?(i(!0,f),n.preventDefault()):y===x.UP?(f.previousSibling?t(f.previousSibling)?i(!0,f.previousSibling):(a(),w.select(f.previousSibling,!0),w.collapse()):i(!0,f),n.preventDefault()):y===x.RIGHT?(i(!1,f),n.preventDefault()):y===x.DOWN?(f.nextSibling?t(f.nextSibling)?i(!1,f.nextSibling):(a(),w.setCursorLocation(f.nextSibling,0)):i(!1,f),n.preventDefault()):h(y)||(o(p),(y===x.ENTER||y===x.DELETE||y===x.BACKSPACE)&&n.preventDefault())}else{if(n.metaKey||n.ctrlKey||y>=112&&123>=y)return;if(r=w.getNode(),v=r,f=t(r),w.isCollapsed()||(d=w.getRng(),(f=t(d.endContainer))?(m=d.cloneRange(),w.select(f.previousSibling,!0),w.collapse(),g=w.getRng(),m.setEnd(g.endContainer,g.endOffset),w.setRng(m)):(f=t(d.startContainer))&&(m=d.cloneRange(),m.setStart(f.nextSibling,0),w.setRng(m))),!f)return void (n.keyCode===x.BACKSPACE&&(e.dom.isEmpty(r)?(f=t(r.previousSibling))&&(i(!1,f),e.dom.remove(r),n.preventDefault()):(d=w.getRng())&&0===d.startOffset&&0===d.endOffset&&(f=t(r.previousSibling))&&(i(!1,f),n.preventDefault())));if(!(l=b.hasClass(f,"wpview-selection-before"))&&!(c=b.hasClass(f,"wpview-selection-after")))return;if(h(y))return;c&&y===x.UP||l&&y===x.BACKSPACE?(f.previousSibling?t(f.previousSibling)?i(!1,f.previousSibling):b.isEmpty(f.previousSibling)&&y===x.BACKSPACE?b.remove(f.previousSibling):(w.select(f.previousSibling,!0),w.collapse()):i(!0,f),n.preventDefault()):!c||y!==x.DOWN&&y!==x.RIGHT?!l||y!==x.UP&&y!==x.LEFT?l&&y===x.DOWN?(f.nextSibling?t(f.nextSibling)?i(!0,f.nextSibling):w.setCursorLocation(f.nextSibling,0):i(!1,f),n.preventDefault()):c&&y===x.LEFT||l&&y===x.RIGHT?(u(f),n.preventDefault()):c&&y===x.BACKSPACE?(o(f),n.preventDefault()):c?s(f):l&&s(f,!0,y):(f.previousSibling&&(t(f.previousSibling)?i(y===x.UP,f.previousSibling):(w.select(f.previousSibling,!0),w.collapse())),n.preventDefault()):(f.nextSibling&&(t(f.nextSibling)?i(y===x.RIGHT,f.nextSibling):w.setCursorLocation(f.nextSibling,0)),n.preventDefault()),y===x.ENTER&&n.preventDefault()}}),e.on("keyup",function(){N&&(o(N),N=!1)}),e.on("focus",function(){var n;g=!0,e.dom.addClass(e.getBody(),"has-focus"),C&&(n=t(e.getBody().firstChild))&&i(!0,n),C=!1}),e.on("blur",function(){g=!1,e.dom.removeClass(e.getBody(),"has-focus")}),e.on("NodeChange",function(r){var s=e.dom,o=e.dom.select(".wpview-wrap"),u=r.element.className,f=t(r.element),l=v;if(v=!1,clearInterval(d),tinymce.each(o,function(e){e.className&&(e.className=e.className.replace(/ ?\bwpview-(?:selection-before|selection-after|cursor-hide)\b/g,""))}),g&&f)if("wpview-selection-before"!==u&&"wpview-selection-after"!==u||!e.selection.isCollapsed())n(r.element,"wpview-clipboard")||m||(a(),m++,i(!0,f));else{if(m=0,a(),l===f.previousSibling)return void i(!0,f);if(l===f.nextSibling)return void i(!1,f);s.addClass(f,u),d=setInterval(function(){s.hasClass(f,"wpview-cursor-hide")?s.removeClass(f,"wpview-cursor-hide"):s.addClass(f,"wpview-cursor-hide")},500)}}),e.on("BeforeExecCommand",function(){var n,r=e.selection.getNode();r&&((b="wpview-selection-before"===r.className)||"wpview-selection-after"===r.className)&&(n=t(r))&&(s(n,b),y=n)}),e.on("ExecCommand",function(){var t,n;p&&(t=p,a(),u(t)),y&&(n=y[b?"previousSibling":"nextSibling"],n&&"P"===n.nodeName&&e.dom.isEmpty(n)&&(e.dom.remove(n),i(b,y)),y=!1)}),e.on("ResolveName",function(n){e.dom.hasClass(n.target,"wpview-wrap")?(n.name=e.dom.getAttrib(n.target,"data-wpview-type")||"wpview",n.stopPropagation()):t(n.target)&&(n.preventDefault(),n.stopPropagation())}),e.addButton("wp_view_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",onclick:function(){p&&wp.mce.views.edit(e,p)}}),e.addButton("wp_view_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){p&&o(p)}}),e.once("preinit",function(){w=e.wp._createToolbar(["wp_view_edit","wp_view_remove"])}),e.on("wptoolbar",function(e){p&&(e.element=p,e.toolbar=w)}),e.wp=e.wp||{},e.wp.getView=t,{getView:t}):{getView:k}});