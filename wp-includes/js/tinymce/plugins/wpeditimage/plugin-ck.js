/* global tinymce */tinymce.PluginManager.add("wpeditimage",function(e){function l(t){return!!e.dom.getAttrib(t,"data-mce-placeholder")||!!e.dom.getAttrib(t,"data-mce-object")}function c(){var t=[],n;o(["wp_img_alignleft","wp_img_aligncenter","wp_img_alignright","wp_img_alignnone","wp_img_edit","wp_img_remove"],function(r){function u(){var t=e.selection;r.settings.stateSelector&&t.selectorChanged(r.settings.stateSelector,function(e){r.active(e)},!0);r.settings.disabledStateSelector&&t.selectorChanged(r.settings.disabledStateSelector,function(e){r.disabled(e)})}var o;if(r==="|")n=null;else if(s.has(r)){r={type:r};i.toolbar_items_size&&(r.size=i.toolbar_items_size);t.push(r);n=null}else{if(!n){n={type:"buttongroup",items:[]};t.push(n)}if(e.buttons[r]){o=r;r=e.buttons[o];typeof r=="function"&&(r=r());r.type=r.type||"button";i.toolbar_items_size&&(r.size=i.toolbar_items_size);r=s.create(r);n.items.push(r);e.initialized?u():e.on("init",u)}}});return{type:"panel",layout:"stack",classes:"toolbar-grp inline-toolbar-grp wp-image-toolbar",ariaRoot:!0,ariaRemember:!0,items:[{type:"toolbar",layout:"flow",items:t}]}}function h(){a||t.hide()}function p(t){return t.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(t,n,r){var i,s,o,u,a,f,l=tinymce.trim;i=n.match(/id=['"]([^'"]*)['"] ?/);i&&(n=n.replace(i[0],""));s=n.match(/align=['"]([^'"]*)['"] ?/);s&&(n=n.replace(s[0],""));o=n.match(/class=['"]([^'"]*)['"] ?/);o&&(n=n.replace(o[0],""));f=n.match(/width=['"]([0-9]*)['"] ?/);f&&(n=n.replace(f[0],""));r=l(r);a=r.match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i);if(a&&a[2]){u=l(a[2]);a=l(a[1])}else{u=l(n).replace(/caption=['"]/,"").replace(/['"]$/,"");a=r}i=i&&i[1]?i[1].replace(/[<>&]+/g,""):"";s=s&&s[1]?s[1]:"alignnone";o=o&&o[1]?" "+o[1].replace(/[<>&]+/g,""):"";!f&&a&&(f=a.match(/width=['"]([0-9]*)['"]/));f&&f[1]&&(f=f[1]);if(!f||!u)return r;f=parseInt(f,10);e.getParam("wpeditimage_html5_captions")||(f+=10);return'<div class="mceTemp"><dl id="'+i+'" class="wp-caption '+s+o+'" style="width: '+f+'px">'+'<dt class="wp-caption-dt">'+a+'</dt><dd class="wp-caption-dd">'+u+"</dd></dl></div>"})}function d(e){return e.replace(/<div (?:id="attachment_|class="mceTemp)[^>]*>([\s\S]+?)<\/div>/g,function(e,t){var n="";if(t.indexOf("<img ")===-1){n=t.match(/<dd [^>]+>([\s\S]+?)<\/dd>/i);return n&&n[1]?"<p>"+n[1]+"</p>":""}n=t.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(e,t,n,r){var i,s,o,u;u=n.match(/width="([0-9]*)"/);u=u&&u[1]?u[1]:"";if(!u||!r)return n;i=t.match(/id="([^"]*)"/);i=i&&i[1]?i[1]:"";s=t.match(/class="([^"]*)"/);s=s&&s[1]?s[1]:"";o=s.match(/align[a-z]+/i)||"alignnone";s=s.replace(/wp-caption ?|align[a-z]+ ?/gi,"");s&&(s=' class="'+s+'"');r=r.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")});r=r.replace(/\s*\n\s*/g,"<br />");return'[caption id="'+i+'" align="'+o+'" width="'+u+'"'+s+"]"+n+" "+r+"[/caption]"});n.indexOf("[caption")===-1&&(n=t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2"));return n})}function v(t){var n,r,i,s,o,u,a,f,l=[],c=e.dom,h=/^\d+$/;i={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""};i.url=c.getAttrib(t,"src");i.alt=c.getAttrib(t,"alt");i.title=c.getAttrib(t,"title");a=c.getAttrib(t,"width");f=c.getAttrib(t,"height");if(!h.test(a)||parseInt(a,10)<1)a=t.naturalWidth||t.width;if(!h.test(f)||parseInt(f,10)<1)f=t.naturalHeight||t.height;i.customWidth=i.width=a;i.customHeight=i.height=f;n=tinymce.explode(t.className," ");r=[];tinymce.each(n,function(e){/^wp-image/.test(e)?i.attachment_id=parseInt(e.replace("wp-image-",""),10):/^align/.test(e)?i.align=e.replace("align",""):/^size/.test(e)?i.size=e.replace("size-",""):r.push(e)});i.extraClasses=r.join(" ");s=c.getParents(t,".wp-caption");if(s.length){s=s[0];n=s.className.split(" ");tinymce.each(n,function(e){/^align/.test(e)?i.align=e.replace("align",""):e&&e!=="wp-caption"&&l.push(e)});i.captionClassName=l.join(" ");o=c.select("dd.wp-caption-dd",s);if(o.length){o=o[0];i.caption=e.serializer.serialize(o).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,"")}}if(t.parentNode&&t.parentNode.nodeName==="A"){u=t.parentNode;i.linkUrl=c.getAttrib(u,"href");i.linkTargetBlank=c.getAttrib(u,"target")==="_blank"?!0:!1;i.linkRel=c.getAttrib(u,"rel");i.linkClassName=u.className}return i}function m(e){return e&&(!!e.textContent||!!e.innerText)}function g(t){if(!t||t.indexOf("<")===-1&&t.indexOf(">")===-1)return t;n||(n=new tinymce.html.Serializer({},e.schema));return n.serialize(e.parser.parse(t,{forced_root_block:!1}))}function y(t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,y,b,w,E=e.dom;r=tinymce.explode(n.extraClasses," ");r||(r=[]);n.caption||r.push("align"+n.align);if(n.attachment_id){r.push("wp-image-"+n.attachment_id);n.size&&n.size!=="custom"&&r.push("size-"+n.size)}y=n.width;b=n.height;if(n.size==="custom"){y=n.customWidth;b=n.customHeight}d={src:n.url,width:y||null,height:b||null,alt:n.alt,title:n.title||null,"class":r.join(" ")||null};E.setAttribs(t,d);v={href:n.linkUrl,rel:n.linkRel||null,target:n.linkTargetBlank?"_blank":null,"class":n.linkClassName||null};if(t.parentNode&&t.parentNode.nodeName==="A"&&!m(t.parentNode))n.linkUrl?E.setAttribs(t.parentNode,v):E.remove(t.parentNode,!0);else if(n.linkUrl){(f=E.getParent(t,"a"))&&E.insertAfter(t,f);f=E.create("a",v);t.parentNode.insertBefore(f,t);f.appendChild(t)}l=e.dom.getParent(t,".mceTemp");t.parentNode&&t.parentNode.nodeName==="A"&&!m(t.parentNode)?s=t.parentNode:s=t;if(n.caption){n.caption=g(n.caption);p=n.attachment_id?"attachment_"+n.attachment_id:null;w="align"+(n.align||"none");i="wp-caption "+w;n.captionClassName&&(i+=" "+n.captionClassName.replace(/[<>&]+/g,""));if(!e.getParam("wpeditimage_html5_captions")){y=parseInt(y,10);y+=10}if(l){h=E.select("dl.wp-caption",l);h.length&&E.setAttribs(h,{id:p,"class":i,style:"width: "+y+"px"});c=E.select(".wp-caption-dd",l);c.length&&E.setHTML(c[0],n.caption)}else{p=p?'id="'+p+'" ':"";o="<dl "+p+'class="'+i+'" style="width: '+y+'px">'+'<dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+n.caption+"</dd></dl>";a=E.create("div",{"class":"mceTemp"},o);if(u=E.getParent(s,"p")){u.parentNode.insertBefore(a,u);E.isEmpty(u)&&E.remove(u)}else s.parentNode.insertBefore(a,s);e.$(a).find("dt.wp-caption-dt").append(s)}}else if(l){u=E.create("p");l.parentNode.insertBefore(u,l);u.appendChild(s);E.remove(l)}wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:e,metadata:n,image:t});e.nodeChanged()}function b(t){var n,r,i;if(typeof wp=="undefined"||!wp.media){e.execCommand("mceImage");return}i=v(t);wp.media.events.trigger("editor:image-edit",{editor:e,metadata:i,image:t});n=wp.media({frame:"image",state:"image-details",metadata:i});wp.media.events.trigger("editor:frame-create",{frame:n});r=function(r){e.focus();e.undoManager.transact(function(){y(t,r)});n.detach()};n.state("image-details").on("update",r);n.state("replace-image").on("replace",r);n.on("close",function(){e.focus();n.detach()});n.open()}function w(t){var n;if(t.nodeName==="DIV"&&e.dom.hasClass(t,"mceTemp"))n=t;else if(t.nodeName==="IMG"||t.nodeName==="DT"||t.nodeName==="A")n=e.dom.getParent(t,"div.mceTemp");if(n){n.nextSibling?e.selection.select(n.nextSibling):n.previousSibling?e.selection.select(n.previousSibling):e.selection.select(n.parentNode);e.selection.collapse(!0);e.dom.remove(n)}else e.dom.remove(t);e.nodeChanged();e.undoManager.add()}var t,n,r=tinymce.DOM,i=e.settings,s=tinymce.ui.Factory,o=tinymce.each,u=tinymce.Env.iOS,a=!0,f=tinymce.$("#postdivrich");e.addButton("wp_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){w(e.selection.getNode())}});e.addButton("wp_img_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",onclick:function(){b(e.selection.getNode())}});o({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(t,n){var r=n.slice(5);e.addButton("wp_img_"+n,{tooltip:t,icon:"dashicon dashicons-align-"+r,cmd:"alignnone"===n?"wpAlignNone":"Justify"+r.slice(0,1).toUpperCase()+r.slice(1),onPostRender:function(){var t=this;e.on("NodeChange",function(r){var i;if(r.element.nodeName!=="IMG")return;i=e.dom.getParent(r.element,".wp-caption")||r.element;"alignnone"===n?t.active(!/\balign(left|center|right)\b/.test(i.className)):t.active(e.dom.hasClass(i,n))})}})});t=s.create(c()).renderTo(document.body).hide();t.reposition=function(){var t,n,i,s,o,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T=this.getEl(),N=5,C=8,k=0,L=e.selection.getNode();if(!L||L.nodeName!=="IMG")return this;o=window.pageYOffset||document.documentElement.scrollTop;a=tinymce.$("#wpadminbar")[0];f=tinymce.$(".mce-tinymce .mce-toolbar-grp")[0];l=L.getBoundingClientRect();c=(l.left+l.right)/2;h=(l.top+l.bottom)/2;p=l.top;d=E-l.bottom;v=window.innerWidth;m=T.offsetWidth;g=m/2;y=document.getElementById(e.id+"_ifr");b=r.getPos(y);w=y.offsetWidth;E=y.offsetHeight;S=T.offsetHeight;x=S+C+N;if(u)t=l.top+b.y+C;else if(p>=x){s=" mce-arrow-down";t=l.top+b.y-S-C}else if(d>=x){s=" mce-arrow-up";t=l.bottom+b.y}else{t=N;h>=x?s=" mce-arrow-down":s=" mce-arrow-up"}f?i=r.getPos(f).y+f.clientHeight:i=b.y;if(o){a&&a.getBoundingClientRect().top===0&&(k=a.clientHeight);o+k>i&&(i=o+k)}if(t&&i&&i+N>t){t=i+N;s=""}n=c-g;n+=b.x;if(l.left<0||l.right>w)n=b.x+(w-m)/2;else if(m>=v){s+=" mce-arrow-full";n=0}else if(n<0&&l.left+m>v||n+m>v&&l.right-m<0)n=(v-m)/2;else if(n<b.x){s+=" mce-arrow-left";n=l.left+b.x}else if(n+m>w+b.x){s+=" mce-arrow-right";n=l.right-m+b.x}if(!u){T.className=T.className.replace(/ ?mce-arrow-[\w]+/g,"");T.className+=s}r.setStyles(T,{left:n,top:t});return this};u&&e.on("click",function(n){if(n.target.nodeName==="IMG"){var r=n.target;window.setTimeout(function(){e.selection.select(r)},200)}else t.hide()});e.on("nodechange",function(n){var r=u?350:100;if(n.element.nodeName!=="IMG"||l(n.element)){t.hide();return}setTimeout(function(){var n=e.selection.getNode();n.nodeName==="IMG"&&!l(n)?t._visible?t.reposition():t.show():t.hide()},r)});t.on("show",function(){a=!1;if(this._visible){this.reposition();r.addClass(this.getEl(),"mce-inline-toolbar-grp-active")}});t.on("hide",function(){a=!0;r.removeClass(this.getEl(),"mce-inline-toolbar-grp-active")});t.on("keydown",function(t){if(t.keyCode===27){h();e.focus()}});r.bind(window,"resize scroll",function(){!a&&f.hasClass("wp-editor-expand")&&h()});e.on("init",function(){e.dom.bind(e.getWin(),"scroll",h)});e.on("blur hide",h);e.shortcuts.add("Alt+119","",function(){var e=t.find("toolbar")[0];e&&e.focus(!0)});e.on("init",function(){var t=e.dom,n=e.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";t.addClass(e.getBody(),n);e.on("wpLoadImageForm",function(t){if(e.getParam("wpeditimage_disable_captions"))return;var n={type:"textbox",flex:1,name:"caption",minHeight:60,multiline:!0,scroll:!0,label:"Image caption"};t.data.splice(t.data.length-1,0,n)});e.on("wpNewImageRefresh",function(e){var n,r;if(n=t.getParent(e.node,"dl.wp-caption"))if(!n.style.width){r=parseInt(e.node.clientWidth,10)+10;r=r?r+"px":"50%";t.setStyle(n,"width",r)}});e.on("wpImageFormSubmit",function(n){var r=n.imgData.data,i=n.imgData.node,s=n.imgData.caption,o="",u="",a="",f,l,c,h,p;r.id="__wp-temp-img-id";n.imgData.cancel=!0;r.style||(r.style=null);if(!r.src){if(i){(f=t.getParent(i,"div.mceTemp"))?t.remove(f):i.parentNode.nodeName==="A"?t.remove(i.parentNode):t.remove(i);e.nodeChanged()}return}if(s){s=s.replace(/\r\n|\r/g,"\n").replace(/<\/?[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")});s=s.replace(/(<br[^>]*>)\s*\n\s*/g,"$1").replace(/\s*\n\s*/g,"<br />");s=g(s)}if(!i){h=t.createHTML("img",r);if(s){c=e.selection.getNode();if(r.width){a=parseInt(r.width,10);e.getParam("wpeditimage_html5_captions")||(a+=10);a=' style="width: '+a+'px"'}h='<dl class="wp-caption alignnone"'+a+">"+'<dt class="wp-caption-dt">'+h+'</dt><dd class="wp-caption-dd">'+s+"</dd></dl>";c.nodeName==="P"?l=c:l=t.getParent(c,"p");if(l&&l.nodeName==="P"){f=t.create("div",{"class":"mceTemp"},h);l.parentNode.insertBefore(f,l);e.selection.select(f);e.nodeChanged();t.isEmpty(l)&&t.remove(l)}else e.selection.setContent('<div class="mceTemp">'+h+"</div>")}else e.selection.setContent(h)}else{p=i.id||null;t.setAttribs(i,r);f=t.getParent(i,"dl.wp-caption");if(s)if(f){if(l=t.select("dd.wp-caption-dd",f)[0])l.innerHTML=s}else{if(i.className){o=i.className.match(/wp-image-([0-9]+)/);u=i.className.match(/align(left|right|center|none)/)}if(u){u=u[0];i.className=i.className.replace(/align(left|right|center|none)/g,"")}else u="alignnone";u=' class="wp-caption '+u+'"';o&&(o=' id="attachment_'+o[1]+'"');a=r.width||i.clientWidth;if(a){a=parseInt(a,10);e.getParam("wpeditimage_html5_captions")||(a+=10);a=' style="width: '+a+'px"'}i.parentNode&&i.parentNode.nodeName==="A"?c=i.parentNode:c=i;h="<dl "+o+u+a+">"+'<dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+s+"</dd></dl>";f=t.create("div",{"class":"mceTemp"},h);if(l=t.getParent(c,"p")){l.parentNode.insertBefore(f,l);t.isEmpty(l)&&t.remove(l)}else c.parentNode.insertBefore(f,c);e.$(f).find("dt.wp-caption-dt").append(c)}else if(f){i.parentNode.nodeName==="A"?h=t.getOuterHTML(i.parentNode):h=t.getOuterHTML(i);l=t.create("p",{},h);t.insertAfter(l,f.parentNode);e.selection.select(l);e.nodeChanged();t.remove(f.parentNode)}}i=t.get("__wp-temp-img-id");t.setAttrib(i,"id",p);n.imgData.node=i});e.on("wpLoadImageData",function(n){var r,i=n.imgData.data,s=n.imgData.node;if(r=t.getParent(s,"dl.wp-caption")){r=t.select("dd.wp-caption-dd",r)[0];r&&(i.caption=e.serializer.serialize(r).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))}});t.bind(e.getDoc(),"dragstart",function(n){var r=e.selection.getNode();r.nodeName==="IMG"&&t.getParent(r,".wp-caption")&&n.preventDefault()});tinymce.Env.ie&&tinymce.Env.ie>10&&t.bind(e.getBody(),"mscontrolselect",function(n){n.target.nodeName==="IMG"&&t.getParent(n.target,".wp-caption")?e.getBody().focus():n.target.nodeName==="DL"&&t.hasClass(n.target,"wp-caption")&&n.target.focus()})});e.on("ObjectResized",function(t){var n=t.target;n.nodeName==="IMG"&&e.undoManager.transact(function(){var r,i,s=e.dom;n.className=n.className.replace(/\bsize-[^ ]+/,"");if(r=s.getParent(n,".wp-caption")){i=t.width||s.getAttrib(n,"width");if(i){i=parseInt(i,10);e.getParam("wpeditimage_html5_captions")||(i+=10);s.setStyle(r,"width",i+"px")}}})});e.on("BeforeExecCommand",function(n){var r,i,s,o,u,a=n.command,f=e.dom;if(a==="mceInsertContent"){if(r=f.getParent(e.selection.getNode(),"div.mceTemp")){i=f.create("p");f.insertAfter(i,r);e.selection.setCursorLocation(i,0);e.nodeChanged()}}else if(a==="JustifyLeft"||a==="JustifyRight"||a==="JustifyCenter"||a==="wpAlignNone"){r=e.selection.getNode();o="align"+a.slice(7).toLowerCase();s=e.dom.getParent(r,".wp-caption");if(r.nodeName!=="IMG"&&!s)return;r=s||r;e.dom.hasClass(r,o)?u=" alignnone":u=" "+o;r.className=r.className.replace(/ ?align(left|center|right|none)/g,"")+u;e.nodeChanged();n.preventDefault();t&&t.reposition();e.fire("ExecCommand",{command:a,ui:n.ui,value:n.value})}});e.on("keydown",function(t){var n,r,i,s,o=e.selection,u=t.keyCode,a=e.dom,f=tinymce.util.VK;if(u===f.ENTER){n=o.getNode();r=a.getParent(n,"div.mceTemp");if(r){a.events.cancel(t);tinymce.each(a.select("dt, dd",r),function(e){a.isEmpty(e)&&a.remove(e)});s=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />';i=a.create("p",null,s);n.nodeName==="DD"?a.insertAfter(i,r):r.parentNode.insertBefore(i,r);e.nodeChanged();o.setCursorLocation(i,0)}}else if(u===f.DELETE||u===f.BACKSPACE){n=o.getNode();if(n.nodeName==="DIV"&&a.hasClass(n,"mceTemp"))r=n;else if(n.nodeName==="IMG"||n.nodeName==="DT"||n.nodeName==="A")r=a.getParent(n,"div.mceTemp");if(r){a.events.cancel(t);w(n);return!1}}});tinymce.Env.gecko&&e.on("undo redo",function(){e.selection.getNode().nodeName==="IMG"&&e.selection.collapse()});e.wpSetImgCaption=function(e){return p(e)};e.wpGetImgCaption=function(e){return d(e)};e.on("BeforeSetContent",function(t){t.format!=="raw"&&(t.content=e.wpSetImgCaption(t.content))});e.on("PostProcess",function(t){t.get&&(t.content=e.wpGetImgCaption(t.content))});return{_do_shcode:p,_get_shcode:d}});