/* global _wpMediaViewsL10n, confirm, getUserSetting, setUserSetting */(function(e,t){var n,r=wp.media,i="ontouchend"in document;n=r.view.l10n=typeof _wpMediaViewsL10n=="undefined"?{}:_wpMediaViewsL10n;r.view.settings=n.settings||{};delete n.settings;r.model.settings.post=r.view.settings.post;e.support.transition=function(){var e=document.documentElement.style,n={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"},r;r=t.find(t.keys(n),function(n){return!t.isUndefined(e[n])});return r&&{end:n[r]}}();r.events=t.extend({},Backbone.Events);r.transition=function(n,r){var i=e.Deferred();r=r||2e3;if(e.support.transition){n instanceof e||(n=e(n));n.first().one(e.support.transition.end,i.resolve);t.delay(i.resolve,r)}else i.resolve();return i.promise()};r.controller.Region=function(e){t.extend(this,t.pick(e||{},"id","view","selector"))};r.controller.Region.extend=Backbone.Model.extend;t.extend(r.controller.Region.prototype,{mode:function(e){if(!e)return this._mode;if(e===this._mode)return this;this.trigger("deactivate");this._mode=e;this.render(e);this.trigger("activate");return this},render:function(e){if(e&&e!==this._mode)return this.mode(e);var t={view:null},n;this.trigger("create",t);n=t.view;this.trigger("render",n);n&&this.set(n);return this},get:function(){return this.view.views.first(this.selector)},set:function(e,t){t&&(t.add=!1);return this.view.views.set(this.selector,e,t)},trigger:function(e){var n,r;if(!this._mode)return;r=t.toArray(arguments);n=this.id+":"+e;r[0]=n+":"+this._mode;this.view.trigger.apply(this.view,r);r[0]=n;this.view.trigger.apply(this.view,r);return this}});r.controller.StateMachine=function(e){this.states=new Backbone.Collection(e)};r.controller.StateMachine.extend=Backbone.Model.extend;t.extend(r.controller.StateMachine.prototype,Backbone.Events,{state:function(e){this.states=this.states||new Backbone.Collection;e=e||this._state;e&&!this.states.get(e)&&this.states.add({id:e});return this.states.get(e)},setState:function(e){var t=this.state();if(t&&e===t.id||!this.states||!this.states.get(e))return this;if(t){t.trigger("deactivate");this._lastState=t.id}this._state=e;this.state().trigger("activate");return this},lastState:function(){if(this._lastState)return this.state(this._lastState)}});t.each(["on","off","trigger"],function(e){r.controller.StateMachine.prototype[e]=function(){this.states=this.states||new Backbone.Collection;this.states[e].apply(this.states,arguments);return this}});r.controller.State=Backbone.Model.extend({constructor:function(){this.on("activate",this._preActivate,this);this.on("activate",this.activate,this);this.on("activate",this._postActivate,this);this.on("deactivate",this._deactivate,this);this.on("deactivate",this.deactivate,this);this.on("reset",this.reset,this);this.on("ready",this._ready,this);this.on("ready",this.ready,this);Backbone.Model.apply(this,arguments);this.on("change:menu",this._updateMenu,this)},ready:function(){},activate:function(){},deactivate:function(){},reset:function(){},_ready:function(){this._updateMenu()},_preActivate:function(){this.active=!0},_postActivate:function(){this.on("change:menu",this._menu,this);this.on("change:titleMode",this._title,this);this.on("change:content",this._content,this);this.on("change:toolbar",this._toolbar,this);this.frame.on("title:render:default",this._renderTitle,this);this._title();this._menu();this._toolbar();this._content();this._router()},_deactivate:function(){this.active=!1;this.frame.off("title:render:default",this._renderTitle,this);this.off("change:menu",this._menu,this);this.off("change:titleMode",this._title,this);this.off("change:content",this._content,this);this.off("change:toolbar",this._toolbar,this)},_title:function(){this.frame.title.render(this.get("titleMode")||"default")},_renderTitle:function(e){e.$el.text(this.get("title")||"")},_router:function(){var e=this.frame.router,t=this.get("router"),n;this.frame.$el.toggleClass("hide-router",!t);if(!t)return;this.frame.router.render(t);n=e.get();n&&n.select&&n.select(this.frame.content.mode())},_menu:function(){var e=this.frame.menu,t=this.get("menu"),n;this.frame.$el.toggleClass("hide-menu",!t);if(!t)return;e.mode(t);n=e.get();n&&n.select&&n.select(this.id)},_updateMenu:function(){var e=this.previous("menu"),t=this.get("menu");e&&this.frame.off("menu:render:"+e,this._renderMenu,this);t&&this.frame.on("menu:render:"+t,this._renderMenu,this)},_renderMenu:function(e){var t=this.get("menuItem"),n=this.get("title"),r=this.get("priority");if(!t&&n){t={text:n};r&&(t.priority=r)}if(!t)return;e.set(this.id,t)}});t.each(["toolbar","content"],function(e){r.controller.State.prototype["_"+e]=function(){var t=this.get(e);t&&this.frame[e].render(t)}});r.selectionSync={syncSelection:function(){var e=this.get("selection"),n=this.frame._selection;if(!this.get("syncSelection")||!n||!e)return;if(e.multiple){e.reset([],{silent:!0});e.validateAll(n.attachments);n.difference=t.difference(n.attachments.models,e.models)}e.single(n.single)},recordSelection:function(){var e=this.get("selection"),t=this.frame._selection;if(!this.get("syncSelection")||!t||!e)return;if(e.multiple){t.attachments.reset(e.toArray().concat(t.difference));t.difference=[]}else t.attachments.add(e.toArray());t.single=e._single}};r.controller.Library=r.controller.State.extend({defaults:{id:"library",title:n.mediaLibraryTitle,multiple:!1,content:"upload",menu:"default",router:"browse",toolbar:"select",searchable:!0,filterable:!1,sortable:!0,autoSelect:!0,describe:!1,contentUserSetting:!0,syncSelection:!0},initialize:function(){var e=this.get("selection"),n;this.get("library")||this.set("library",r.query());if(!(e instanceof r.model.Selection)){n=e;if(!n){n=this.get("library").props.toJSON();n=t.omit(n,"orderby","query")}this.set("selection",new r.model.Selection(null,{multiple:this.get("multiple"),props:n}))}this.resetDisplays()},activate:function(){this.syncSelection();wp.Uploader.queue.on("add",this.uploading,this);this.get("selection").on("add remove reset",this.refreshContent,this);if(this.get("router")&&this.get("contentUserSetting")){this.frame.on("content:activate",this.saveContentMode,this);this.set("content",getUserSetting("libraryContent",this.get("content")))}},deactivate:function(){this.recordSelection();this.frame.off("content:activate",this.saveContentMode,this);this.get("selection").off(null,null,this);wp.Uploader.queue.off(null,null,this)},reset:function(){this.get("selection").reset();this.resetDisplays();this.refreshContent()},resetDisplays:function(){var e=r.view.settings.defaultProps;this._displays=[];this._defaultDisplaySettings={align:e.align||getUserSetting("align","none"),size:e.size||getUserSetting("imgsize","medium"),link:e.link||getUserSetting("urlbutton","file")}},display:function(e){var t=this._displays;t[e.cid]||(t[e.cid]=new Backbone.Model(this.defaultDisplaySettings(e)));return t[e.cid]},defaultDisplaySettings:function(e){var t=this._defaultDisplaySettings;if(t.canEmbed=this.canEmbed(e))t.link="embed";return t},canEmbed:function(e){if(!e.get("uploading")){var n=e.get("type");if(n!=="audio"&&n!=="video")return!1}return t.contains(r.view.settings.embedExts,e.get("filename").split(".").pop())},refreshContent:function(){var e=this.get("selection"),t=this.frame,n=t.router.get(),r=t.content.mode();this.active&&!e.length&&n&&!n.get(r)&&this.frame.content.render(this.get("content"))},uploading:function(e){var t=this.frame.content;"upload"===t.mode()&&this.frame.content.mode("browse");if(this.get("autoSelect")){this.get("selection").add(e);this.frame.trigger("library:selection:add")}},saveContentMode:function(){if("browse"!==this.get("router"))return;var e=this.frame.content.mode(),t=this.frame.router.get();t&&t.get(e)&&setUserSetting("libraryContent",e)}});t.extend(r.controller.Library.prototype,r.selectionSync);r.controller.ImageDetails=r.controller.State.extend({defaults:t.defaults({id:"image-details",title:n.imageDetailsTitle,content:"image-details",menu:!1,router:!1,toolbar:"image-details",editing:!1,priority:60},r.controller.Library.prototype.defaults),initialize:function(e){this.image=e.image;r.controller.State.prototype.initialize.apply(this,arguments)},activate:function(){this.frame.modal.$el.addClass("image-details")}});r.controller.GalleryEdit=r.controller.Library.extend({defaults:{id:"gallery-edit",title:n.editGalleryTitle,multiple:!1,searchable:!1,sortable:!0,display:!1,content:"browse",toolbar:"gallery-edit",describe:!0,displaySettings:!0,dragInfo:!0,idealColumnWidth:170,editing:!1,priority:60,syncSelection:!1},initialize:function(){this.get("library")||this.set("library",new r.model.Selection);this.get("AttachmentView")||this.set("AttachmentView",r.view.Attachment.EditLibrary);r.controller.Library.prototype.initialize.apply(this,arguments)},activate:function(){var e=this.get("library");e.props.set("type","image");this.get("library").observe(wp.Uploader.queue);this.frame.on("content:render:browse",this.gallerySettings,this);r.controller.Library.prototype.activate.apply(this,arguments)},deactivate:function(){this.get("library").unobserve(wp.Uploader.queue);this.frame.off("content:render:browse",this.gallerySettings,this);r.controller.Library.prototype.deactivate.apply(this,arguments)},gallerySettings:function(e){if(!this.get("displaySettings"))return;var t=this.get("library");if(!t||!e)return;t.gallery=t.gallery||new Backbone.Model;e.sidebar.set({gallery:new r.view.Settings.Gallery({controller:this,model:t.gallery,priority:40})});e.toolbar.set("reverse",{text:n.reverseOrder,priority:80,click:function(){t.reset(t.toArray().reverse())}})}});r.controller.GalleryAdd=r.controller.Library.extend({defaults:t.defaults({id:"gallery-library",title:n.addToGalleryTitle,multiple:"add",filterable:"uploaded",menu:"gallery",toolbar:"gallery-add",priority:100,syncSelection:!1},r.controller.Library.prototype.defaults),initialize:function(){this.get("library")||this.set("library",r.query({type:"image"}));r.controller.Library.prototype.initialize.apply(this,arguments)},activate:function(){var e=this.get("library"),t=this.frame.state("gallery-edit").get("library");this.editLibrary&&this.editLibrary!==t&&e.unobserve(this.editLibrary);e.validator=function(e){return!!this.mirroring.get(e.cid)&&!t.get(e.cid)&&r.model.Selection.prototype.validator.apply(this,arguments)};e.reset(e.mirroring.models,{silent:!0});e.observe(t);this.editLibrary=t;r.controller.Library.prototype.activate.apply(this,arguments)}});r.controller.CollectionEdit=r.controller.Library.extend({defaults:{multiple:!1,sortable:!0,searchable:!1,content:"browse",describe:!0,dragInfo:!0,idealColumnWidth:170,editing:!1,priority:60,SettingsView:!1,syncSelection:!1},initialize:function(){var e=this.get("collectionType");"video"===this.get("type")&&(e="video-"+e);this.set("id",e+"-edit");this.set("toolbar",e+"-edit");this.get("library")||this.set("library",new r.model.Selection);this.get("AttachmentView")||this.set("AttachmentView",r.view.Attachment.EditLibrary);r.controller.Library.prototype.initialize.apply(this,arguments)},activate:function(){var e=this.get("library");e.props.set("type",this.get("type"));this.get("library").observe(wp.Uploader.queue);this.frame.on("content:render:browse",this.renderSettings,this);r.controller.Library.prototype.activate.apply(this,arguments)},deactivate:function(){this.get("library").unobserve(wp.Uploader.queue);this.frame.off("content:render:browse",this.renderSettings,this);r.controller.Library.prototype.deactivate.apply(this,arguments)},renderSettings:function(t){var i=this.get("library"),s=this.get("collectionType"),o=this.get("dragInfoText"),u=this.get("SettingsView"),a={};if(!i||!t)return;i[s]=i[s]||new Backbone.Model;a[s]=new u({controller:this,model:i[s],priority:40});t.sidebar.set(a);o&&t.toolbar.set("dragInfo",new r.View({el:e('<div class="instructions">'+o+"</div>")[0],priority:-40}));t.toolbar.set("reverse",{text:n.reverseOrder,priority:80,click:function(){i.reset(i.toArray().reverse())}})}});r.controller.CollectionAdd=r.controller.Library.extend({defaults:t.defaults({multiple:"add",filterable:"uploaded",priority:100,syncSelection:!1},r.controller.Library.prototype.defaults),initialize:function(){var e=this.get("collectionType");"video"===this.get("type")&&(e="video-"+e);this.set("id",e+"-library");this.set("toolbar",e+"-add");this.set("menu",e);this.get("library")||this.set("library",r.query({type:this.get("type")}));r.controller.Library.prototype.initialize.apply(this,arguments)},activate:function(){var e=this.get("library"),t=this.get("editLibrary"),n=this.frame.state(this.get("collectionType")+"-edit").get("library");t&&t!==n&&e.unobserve(t);e.validator=function(e){return!!this.mirroring.get(e.cid)&&!n.get(e.cid)&&r.model.Selection.prototype.validator.apply(this,arguments)};e.reset(e.mirroring.models,{silent:!0});e.observe(n);this.set("editLibrary",n);r.controller.Library.prototype.activate.apply(this,arguments)}});r.controller.FeaturedImage=r.controller.Library.extend({defaults:t.defaults({id:"featured-image",title:n.setFeaturedImageTitle,multiple:!1,filterable:"uploaded",toolbar:"featured-image",priority:60,syncSelection:!0},r.controller.Library.prototype.defaults),initialize:function(){var e,t;this.get("library")||this.set("library",r.query({type:"image"}));r.controller.Library.prototype.initialize.apply(this,arguments);e=this.get("library");t=e.comparator;e.comparator=function(e,n){var r=!!this.mirroring.get(e.cid),i=!!this.mirroring.get(n.cid);return!r&&i?-1:r&&!i?1:t.apply(this,arguments)};e.observe(this.get("selection"))},activate:function(){this.updateSelection();this.frame.on("open",this.updateSelection,this);r.controller.Library.prototype.activate.apply(this,arguments)},deactivate:function(){this.frame.off("open",this.updateSelection,this);r.controller.Library.prototype.deactivate.apply(this,arguments)},updateSelection:function(){var e=this.get("selection"),t=r.view.settings.post.featuredImageId,n;if(""!==t&&-1!==t){n=r.model.Attachment.get(t);n.fetch()}e.reset(n?[n]:[])}});r.controller.ReplaceImage=r.controller.Library.extend({defaults:t.defaults({id:"replace-image",title:n.replaceImageTitle,multiple:!1,filterable:"uploaded",toolbar:"replace",menu:!1,priority:60,syncSelection:!0},r.controller.Library.prototype.defaults),initialize:function(e){var t,n;this.image=e.image;this.get("library")||this.set("library",r.query({type:"image"}));r.controller.Library.prototype.initialize.apply(this,arguments);t=this.get("library");n=t.comparator;t.comparator=function(e,t){var r=!!this.mirroring.get(e.cid),i=!!this.mirroring.get(t.cid);return!r&&i?-1:r&&!i?1:n.apply(this,arguments)};t.observe(this.get("selection"))},activate:function(){this.updateSelection();r.controller.Library.prototype.activate.apply(this,arguments)},updateSelection:function(){var e=this.get("selection"),t=this.image.attachment;e.reset(t?[t]:[])}});r.controller.EditImage=r.controller.State.extend({defaults:{id:"edit-image",title:n.editImage,menu:!1,toolbar:"edit-image",content:"edit-image",url:""},activate:function(){this.listenTo(this.frame,"toolbar:render:edit-image",this.toolbar)},deactivate:function(){this.stopListening(this.frame)},toolbar:function(){var e=this.frame,t=e.lastState(),i=t&&t.id;e.toolbar.set(new r.view.Toolbar({controller:e,items:{back:{style:"primary",text:n.back,priority:20,click:function(){i?e.setState(i):e.close()}}}}))}});r.controller.MediaLibrary=r.controller.Library.extend({defaults:t.defaults({filterable:"uploaded",displaySettings:!1,priority:80,syncSelection:!1},r.controller.Library.prototype.defaults),initialize:function(e){this.media=e.media;this.type=e.type;this.set("library",r.query({type:this.type}));r.controller.Library.prototype.initialize.apply(this,arguments)},activate:function(){if(r.frame.lastMime){this.set("library",r.query({type:r.frame.lastMime}));delete r.frame.lastMime}r.controller.Library.prototype.activate.apply(this,arguments)}});r.controller.Embed=r.controller.State.extend({defaults:{id:"embed",title:n.insertFromUrlTitle,content:"embed",menu:"default",toolbar:"main-embed",priority:120,type:"link",url:"",metadata:{}},sensitivity:200,initialize:function(e){this.metadata=e.metadata;this.debouncedScan=t.debounce(t.bind(this.scan,this),this.sensitivity);this.props=new Backbone.Model(this.metadata||{url:""});this.props.on("change:url",this.debouncedScan,this);this.props.on("change:url",this.refresh,this);this.on("scan",this.scanImage,this)},scan:function(){var t,n=this,r={type:"link",scanners:[]};this.props.get("url")&&this.trigger("scan",r);if(r.scanners.length){t=r.scanners=e.when.apply(e,r.scanners);t.always(function(){n.get("scanners")===t&&n.set("loading",!1)})}else r.scanners=null;r.loading=!!r.scanners;this.set(r)},scanImage:function(t){var n=this.frame,r=this,i=this.props.get("url"),s=new Image,o=e.Deferred();t.scanners.push(o.promise());s.onload=function(){o.resolve();if(r!==n.state()||i!==r.props.get("url"))return;r.set({type:"image"});r.props.set({width:s.width,height:s.height})};s.onerror=o.reject;s.src=i},refresh:function(){this.frame.toolbar.get().refresh()},reset:function(){this.props.clear().set({url:""});this.active&&this.refresh()}});r.controller.Cropper=r.controller.State.extend({defaults:{id:"cropper",title:n.cropImage,toolbar:"crop",content:"crop",router:!1,canSkipCrop:!1},activate:function(){this.frame.on("content:create:crop",this.createCropContent,this);this.frame.on("close",this.removeCropper,this);this.set("selection",new Backbone.Collection(this.frame._selection.single))},deactivate:function(){this.frame.toolbar.mode("browse")},createCropContent:function(){this.cropperView=new wp.media.view.Cropper({controller:this,attachment:this.get("selection").first()});this.cropperView.on("image-loaded",this.createCropToolbar,this);this.frame.content.set(this.cropperView)},removeCropper:function(){this.imgSelect.cancelSelection();this.imgSelect.setOptions({remove:!0});this.imgSelect.update();this.cropperView.remove()},createCropToolbar:function(){var e,r;e=this.get("canSkipCrop")||!1;r={controller:this.frame,items:{insert:{style:"primary",text:n.cropImage,priority:80,requires:{library:!1,selection:!1},click:function(){var e=this,t=this.controller.state().get("selection").first();t.set({cropDetails:this.controller.state().imgSelect.getSelection()});this.$el.text(n.cropping);this.$el.attr("disabled",!0);this.controller.state().doCrop(t).done(function(t){e.controller.trigger("cropped",t);e.controller.close()}).fail(function(){e.controller.trigger("content:error:crop")})}}}};e&&t.extend(r.items,{skip:{style:"secondary",text:n.skipCropping,priority:70,requires:{library:!1,selection:!1},click:function(){var e=this.controller.state().get("selection").first();this.controller.state().cropperView.remove();this.controller.trigger("skippedcrop",e);this.controller.close()}}});this.frame.toolbar.set(new wp.media.view.Toolbar(r))},doCrop:function(e){return wp.ajax.post("custom-header-crop",{nonce:e.get("nonces").edit,id:e.get("id"),cropDetails:e.get("cropDetails")})}});r.View=wp.Backbone.View.extend({constructor:function(e){e&&e.controller&&(this.controller=e.controller);wp.Backbone.View.apply(this,arguments)},dispose:function(){this.undelegateEvents();this.model&&this.model.off&&this.model.off(null,null,this);this.collection&&this.collection.off&&this.collection.off(null,null,this);this.controller&&this.controller.off&&this.controller.off(null,null,this);return this},remove:function(){this.dispose();return wp.Backbone.View.prototype.remove.apply(this,arguments)}});r.view.Frame=r.View.extend({initialize:function(){t.defaults(this.options,{mode:["select"]});this._createRegions();this._createStates();this._createModes()},_createRegions:function(){this.regions=this.regions?this.regions.slice():[];t.each(this.regions,function(e){this[e]=new r.controller.Region({view:this,id:e,selector:".media-frame-"+e})},this)},_createStates:function(){this.states=new Backbone.Collection(null,{model:r.controller.State});this.states.on("add",function(e){e.frame=this;e.trigger("ready")},this);this.options.states&&this.states.add(this.options.states)},_createModes:function(){this.activeModes=new Backbone.Collection;this.activeModes.on("add remove reset",t.bind(this.triggerModeEvents,this));t.each(this.options.mode,function(e){this.activateMode(e)},this)},reset:function(){this.states.invoke("trigger","reset");return this},triggerModeEvents:function(e,n,r){var i,s={add:"activate",remove:"deactivate"},o;t.each(r,function(e,t){e&&(i=t)});if(!t.has(s,i))return;o=e.get("id")+":"+s[i];this.trigger(o)},activateMode:function(e){if(this.isModeActive(e))return;this.activeModes.add([{id:e}]);this.$el.addClass("mode-"+e);return this},deactivateMode:function(e){if(!this.isModeActive(e))return this;this.activeModes.remove(this.activeModes.where({id:e}));this.$el.removeClass("mode-"+e);this.trigger(e+":deactivate");return this},isModeActive:function(e){return Boolean(this.activeModes.where({id:e}).length)}});t.extend(r.view.Frame.prototype,r.controller.StateMachine.prototype);r.view.MediaFrame=r.view.Frame.extend({className:"media-frame",template:r.template("media-frame"),regions:["menu","title","content","toolbar","router"],events:{"click div.media-frame-title h1":"toggleMenu"},initialize:function(){r.view.Frame.prototype.initialize.apply(this,arguments);t.defaults(this.options,{title:"",modal:!0,uploader:!0});this.$el.addClass("wp-core-ui");if(this.options.modal){this.modal=new r.view.Modal({controller:this,title:this.options.title});this.modal.content(this)}if(wp.Uploader.limitExceeded||!wp.Uploader.browser.supported)this.options.uploader=!1;if(this.options.uploader){this.uploader=new r.view.UploaderWindow({controller:this,uploader:{dropzone:this.modal?this.modal.$el:this.$el,container:this.$el}});this.views.set(".media-frame-uploader",this.uploader)}this.on("attach",t.bind(this.views.ready,this.views),this);this.on("title:create:default",this.createTitle,this);this.title.mode("default");this.on("title:render",function(e){e.$el.append('<span class="dashicons dashicons-arrow-down"></span>')});this.on("menu:create:default",this.createMenu,this)},render:function(){!this.state()&&this.options.state&&this.setState(this.options.state);return r.view.Frame.prototype.render.apply(this,arguments)},createTitle:function(e){e.view=new r.View({controller:this,tagName:"h1"})},createMenu:function(e){e.view=new r.view.Menu({controller:this})},toggleMenu:function(){this.$el.find(".media-menu").toggleClass("visible")},createToolbar:function(e){e.view=new r.view.Toolbar({controller:this})},createRouter:function(e){e.view=new r.view.Router({controller:this})},createIframeStates:function(n){var i=r.view.settings,s=i.tabs,o=i.tabUrl,u;if(!s||!o)return;u=e("#post_ID");u.length&&(o+="&post_id="+u.val());t.each(s,function(e,r){this.state("iframe:"+r).set(t.defaults({tab:r,src:o+"&tab="+r,title:e,content:"iframe",menu:"default"},n))},this);this.on("content:create:iframe",this.iframeContent,this);this.on("menu:render:default",this.iframeMenu,this);this.on("open",this.hijackThickbox,this);this.on("close",this.restoreThickbox,this)},iframeContent:function(e){this.$el.addClass("hide-toolbar");e.view=new r.view.Iframe({controller:this})},iframeMenu:function(e){var n={};if(!e)return;t.each(r.view.settings.tabs,function(e,t){n["iframe:"+t]={text:this.state("iframe:"+t).get("title"),priority:200}},this);e.set(n)},hijackThickbox:function(){var e=this;if(!window.tb_remove||this._tb_remove)return;this._tb_remove=window.tb_remove;window.tb_remove=function(){e.close();e.reset();e.setState(e.options.state);e._tb_remove.call(window)}},restoreThickbox:function(){if(!this._tb_remove)return;window.tb_remove=this._tb_remove;delete this._tb_remove}});t.each(["open","close","attach","detach","escape"],function(e){r.view.MediaFrame.prototype[e]=function(){this.modal&&this.modal[e].apply(this.modal,arguments);return this}});r.view.MediaFrame.Select=r.view.MediaFrame.extend({initialize:function(){r.view.MediaFrame.prototype.initialize.apply(this,arguments);t.defaults(this.options,{selection:[],library:{},multiple:!1,state:"library"});this.createSelection();this.createStates();this.bindHandlers()},createSelection:function(){var e=this.options.selection;e instanceof r.model.Selection||(this.options.selection=new r.model.Selection(e,{multiple:this.options.multiple}));this._selection={attachments:new r.model.Attachments,difference:[]}},createStates:function(){var e=this.options;if(this.options.states)return;this.states.add([new r.controller.Library({library:r.query(e.library),multiple:e.multiple,title:e.title,priority:20})])},bindHandlers:function(){this.on("router:create:browse",this.createRouter,this);this.on("router:render:browse",this.browseRouter,this);this.on("content:create:browse",this.browseContent,this);this.on("content:render:upload",this.uploadContent,this);this.on("toolbar:create:select",this.createSelectToolbar,this)},browseRouter:function(e){e.set({upload:{text:n.uploadFilesTitle,priority:20},browse:{text:n.mediaLibraryTitle,priority:40}})},browseContent:function(e){var t=this.state();this.$el.removeClass("hide-toolbar");e.view=new r.view.AttachmentsBrowser({controller:this,collection:t.get("library"),selection:t.get("selection"),model:t,sortable:t.get("sortable"),search:t.get("searchable"),filters:t.get("filterable"),display:t.has("display")?t.get("display"):t.get("displaySettings"),dragInfo:t.get("dragInfo"),idealColumnWidth:t.get("idealColumnWidth"),suggestedWidth:t.get("suggestedWidth"),suggestedHeight:t.get("suggestedHeight"),AttachmentView:t.get("AttachmentView")})},uploadContent:function(){this.$el.removeClass("hide-toolbar");this.content.set(new r.view.UploaderInline({controller:this}))},createSelectToolbar:function(e,t){t=t||this.options.button||{};t.controller=this;e.view=new r.view.Toolbar.Select(t)}});r.view.MediaFrame.Post=r.view.MediaFrame.Select.extend({initialize:function(){this.counts={audio:{count:r.view.settings.attachmentCounts.audio,state:"playlist"},video:{count:r.view.settings.attachmentCounts.video,state:"video-playlist"}};t.defaults(this.options,{multiple:!0,editing:!1,state:"insert",metadata:{}});r.view.MediaFrame.Select.prototype.initialize.apply(this,arguments);this.createIframeStates()},createStates:function(){var e=this.options;this.states.add([new r.controller.Library({id:"insert",title:n.insertMediaTitle,priority:20,toolbar:"main-insert",filterable:"all",library:r.query(e.library),multiple:e.multiple?"reset":!1,editable:!0,allowLocalEdits:!0,displaySettings:!0,displayUserSettings:!0}),new r.controller.Library({id:"gallery",title:n.createGalleryTitle,priority:40,toolbar:"main-gallery",filterable:"uploaded",multiple:"add",editable:!1,library:r.query(t.defaults({type:"image"},e.library))}),new r.controller.Embed({metadata:e.metadata}),new r.controller.EditImage({model:e.editImage}),new r.controller.GalleryEdit({library:e.selection,editing:e.editing,menu:"gallery"}),new r.controller.GalleryAdd,new r.controller.Library({id:"playlist",title:n.createPlaylistTitle,priority:60,toolbar:"main-playlist",filterable:"uploaded",multiple:"add",editable:!1,library:r.query(t.defaults({type:"audio"},e.library))}),new r.controller.CollectionEdit({type:"audio",collectionType:"playlist",title:n.editPlaylistTitle,SettingsView:r.view.Settings.Playlist,library:e.selection,editing:e.editing,menu:"playlist",dragInfoText:n.playlistDragInfo,dragInfo:!1}),new r.controller.CollectionAdd({type:"audio",collectionType:"playlist",title:n.addToPlaylistTitle}),new r.controller.Library({id:"video-playlist",title:n.createVideoPlaylistTitle,priority:60,toolbar:"main-video-playlist",filterable:"uploaded",multiple:"add",editable:!1,library:r.query(t.defaults({type:"video"},e.library))}),new r.controller.CollectionEdit({type:"video",collectionType:"playlist",title:n.editVideoPlaylistTitle,SettingsView:r.view.Settings.Playlist,library:e.selection,editing:e.editing,menu:"video-playlist",dragInfoText:n.videoPlaylistDragInfo,dragInfo:!1}),new r.controller.CollectionAdd({type:"video",collectionType:"playlist",title:n.addToVideoPlaylistTitle})]);r.view.settings.post.featuredImageId&&this.states.add(new r.controller.FeaturedImage)},bindHandlers:function(){var e,n;r.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments);this.on("activate",this.activate,this);n=t.find(this.counts,function(e){return e.count===0});typeof n!="undefined"&&this.listenTo(r.model.Attachments.all,"change:type",this.mediaTypeCounts);this.on("menu:create:gallery",this.createMenu,this);this.on("menu:create:playlist",this.createMenu,this);this.on("menu:create:video-playlist",this.createMenu,this);this.on("toolbar:create:main-insert",this.createToolbar,this);this.on("toolbar:create:main-gallery",this.createToolbar,this);this.on("toolbar:create:main-playlist",this.createToolbar,this);this.on("toolbar:create:main-video-playlist",this.createToolbar,this);this.on("toolbar:create:featured-image",this.featuredImageToolbar,this);this.on("toolbar:create:main-embed",this.mainEmbedToolbar,this);e={menu:{"default":"mainMenu",gallery:"galleryMenu",playlist:"playlistMenu","video-playlist":"videoPlaylistMenu"},content:{embed:"embedContent","edit-image":"editImageContent","edit-selection":"editSelectionContent"},toolbar:{"main-insert":"mainInsertToolbar","main-gallery":"mainGalleryToolbar","gallery-edit":"galleryEditToolbar","gallery-add":"galleryAddToolbar","main-playlist":"mainPlaylistToolbar","playlist-edit":"playlistEditToolbar","playlist-add":"playlistAddToolbar","main-video-playlist":"mainVideoPlaylistToolbar","video-playlist-edit":"videoPlaylistEditToolbar","video-playlist-add":"videoPlaylistAddToolbar"}};t.each(e,function(e,n){t.each(e,function(e,t){this.on(n+":render:"+t,this[e],this)},this)},this)},activate:function(){t.each(this.counts,function(e){e.count<1&&this.menuItemVisibility(e.state,"hide")},this)},mediaTypeCounts:function(e,t){if(typeof this.counts[t]!="undefined"&&this.counts[t].count<1){this.counts[t].count++;this.menuItemVisibility(this.counts[t].state,"show")}},mainMenu:function(e){e.set({"library-separator":new r.View({className:"separator",priority:100})})},menuItemVisibility:function(e,t){var n=this.menu.get();t==="hide"?n.hide(e):t==="show"&&n.show(e)},galleryMenu:function(e){var t=this.lastState(),i=t&&t.id,s=this;e.set({cancel:{text:n.cancelGalleryTitle,priority:20,click:function(){i?s.setState(i):s.close();this.controller.modal.focusManager.focus()}},separateCancel:new r.View({className:"separator",priority:40})})},playlistMenu:function(e){var t=this.lastState(),i=t&&t.id,s=this;e.set({cancel:{text:n.cancelPlaylistTitle,priority:20,click:function(){i?s.setState(i):s.close()}},separateCancel:new r.View({className:"separator",priority:40})})},videoPlaylistMenu:function(e){var t=this.lastState(),i=t&&t.id,s=this;e.set({cancel:{text:n.cancelVideoPlaylistTitle,priority:20,click:function(){i?s.setState(i):s.close()}},separateCancel:new r.View({className:"separator",priority:40})})},embedContent:function(){var e=(new r.view.Embed({controller:this,model:this.state()})).render();this.content.set(e);i||e.url.focus()},editSelectionContent:function(){var e=this.state(),t=e.get("selection"),i;i=(new r.view.AttachmentsBrowser({controller:this,collection:t,selection:t,model:e,sortable:!0,search:!1,dragInfo:!0,AttachmentView:r.view.Attachment.EditSelection})).render();i.toolbar.set("backToLibrary",{text:n.returnToLibrary,priority:-100,click:function(){this.controller.content.mode("browse")}});this.content.set(i)},editImageContent:function(){var e=this.state().get("image"),t=(new r.view.EditImage({model:e,controller:this})).render();this.content.set(t);t.loadEditor()},selectionStatusToolbar:function(e){var t=this.state().get("editable");e.set("selection",(new r.view.Selection({controller:this,collection:this.state().get("selection"),priority:-40,editable:t&&function(){this.controller.content.mode("edit-selection")}})).render())},mainInsertToolbar:function(e){var t=this;this.selectionStatusToolbar(e);e.set("insert",{style:"primary",priority:80,text:n.insertIntoPost,requires:{selection:!0},click:function(){var e=t.state(),n=e.get("selection");t.close();e.trigger("insert",n).reset()}})},mainGalleryToolbar:function(e){var t=this;this.selectionStatusToolbar(e);e.set("gallery",{style:"primary",text:n.createNewGallery,priority:60,requires:{selection:!0},click:function(){var e=t.state().get("selection"),n=t.state("gallery-edit"),i=e.where({type:"image"});n.set("library",new r.model.Selection(i,{props:e.props.toJSON(),multiple:!0}));this.controller.setState("gallery-edit");this.controller.modal.focusManager.focus()}})},mainPlaylistToolbar:function(e){var t=this;this.selectionStatusToolbar(e);e.set("playlist",{style:"primary",text
:n.createNewPlaylist,priority:100,requires:{selection:!0},click:function(){var e=t.state().get("selection"),n=t.state("playlist-edit"),i=e.where({type:"audio"});n.set("library",new r.model.Selection(i,{props:e.props.toJSON(),multiple:!0}));this.controller.setState("playlist-edit");this.controller.modal.focusManager.focus()}})},mainVideoPlaylistToolbar:function(e){var t=this;this.selectionStatusToolbar(e);e.set("video-playlist",{style:"primary",text:n.createNewVideoPlaylist,priority:100,requires:{selection:!0},click:function(){var e=t.state().get("selection"),n=t.state("video-playlist-edit"),i=e.where({type:"video"});n.set("library",new r.model.Selection(i,{props:e.props.toJSON(),multiple:!0}));this.controller.setState("video-playlist-edit");this.controller.modal.focusManager.focus()}})},featuredImageToolbar:function(e){this.createSelectToolbar(e,{text:n.setFeaturedImage,state:this.options.state})},mainEmbedToolbar:function(e){e.view=new r.view.Toolbar.Embed({controller:this})},galleryEditToolbar:function(){var e=this.state().get("editing");this.toolbar.set(new r.view.Toolbar({controller:this,items:{insert:{style:"primary",text:e?n.updateGallery:n.insertGallery,priority:80,requires:{library:!0},click:function(){var e=this.controller,t=e.state();e.close();t.trigger("update",t.get("library"));e.setState(e.options.state);e.reset()}}}}))},galleryAddToolbar:function(){this.toolbar.set(new r.view.Toolbar({controller:this,items:{insert:{style:"primary",text:n.addToGallery,priority:80,requires:{selection:!0},click:function(){var e=this.controller,t=e.state(),n=e.state("gallery-edit");n.get("library").add(t.get("selection").models);t.trigger("reset");e.setState("gallery-edit")}}}}))},playlistEditToolbar:function(){var e=this.state().get("editing");this.toolbar.set(new r.view.Toolbar({controller:this,items:{insert:{style:"primary",text:e?n.updatePlaylist:n.insertPlaylist,priority:80,requires:{library:!0},click:function(){var e=this.controller,t=e.state();e.close();t.trigger("update",t.get("library"));e.setState(e.options.state);e.reset()}}}}))},playlistAddToolbar:function(){this.toolbar.set(new r.view.Toolbar({controller:this,items:{insert:{style:"primary",text:n.addToPlaylist,priority:80,requires:{selection:!0},click:function(){var e=this.controller,t=e.state(),n=e.state("playlist-edit");n.get("library").add(t.get("selection").models);t.trigger("reset");e.setState("playlist-edit")}}}}))},videoPlaylistEditToolbar:function(){var e=this.state().get("editing");this.toolbar.set(new r.view.Toolbar({controller:this,items:{insert:{style:"primary",text:e?n.updateVideoPlaylist:n.insertVideoPlaylist,priority:140,requires:{library:!0},click:function(){var e=this.controller,t=e.state(),n=t.get("library");n.type="video";e.close();t.trigger("update",n);e.setState(e.options.state);e.reset()}}}}))},videoPlaylistAddToolbar:function(){this.toolbar.set(new r.view.Toolbar({controller:this,items:{insert:{style:"primary",text:n.addToVideoPlaylist,priority:140,requires:{selection:!0},click:function(){var e=this.controller,t=e.state(),n=e.state("video-playlist-edit");n.get("library").add(t.get("selection").models);t.trigger("reset");e.setState("video-playlist-edit")}}}}))}});r.view.MediaFrame.ImageDetails=r.view.MediaFrame.Select.extend({defaults:{id:"image",url:"",menu:"image-details",content:"image-details",toolbar:"image-details",type:"link",title:n.imageDetailsTitle,priority:120},initialize:function(e){this.image=new r.model.PostImage(e.metadata);this.options.selection=new r.model.Selection(this.image.attachment,{multiple:!1});r.view.MediaFrame.Select.prototype.initialize.apply(this,arguments)},bindHandlers:function(){r.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments);this.on("menu:create:image-details",this.createMenu,this);this.on("content:create:image-details",this.imageDetailsContent,this);this.on("content:render:edit-image",this.editImageContent,this);this.on("toolbar:render:image-details",this.renderImageDetailsToolbar,this);this.on("toolbar:render:replace",this.renderReplaceImageToolbar,this)},createStates:function(){this.states.add([new r.controller.ImageDetails({image:this.image,editable:!1}),new r.controller.ReplaceImage({id:"replace-image",library:r.query({type:"image"}),image:this.image,multiple:!1,title:n.imageReplaceTitle,toolbar:"replace",priority:80,displaySettings:!0}),new r.controller.EditImage({image:this.image,selection:this.options.selection})])},imageDetailsContent:function(e){e.view=new r.view.ImageDetails({controller:this,model:this.state().image,attachment:this.state().image.attachment})},editImageContent:function(){var e=this.state(),t=e.get("image"),n;if(!t)return;n=(new r.view.EditImage({model:t,controller:this})).render();this.content.set(n);n.loadEditor()},renderImageDetailsToolbar:function(){this.toolbar.set(new r.view.Toolbar({controller:this,items:{select:{style:"primary",text:n.update,priority:80,click:function(){var e=this.controller,t=e.state();e.close();t.trigger("update",e.image.toJSON());e.setState(e.options.state);e.reset()}}}}))},renderReplaceImageToolbar:function(){var e=this,t=e.lastState(),i=t&&t.id;this.toolbar.set(new r.view.Toolbar({controller:this,items:{back:{text:n.back,priority:20,click:function(){i?e.setState(i):e.close()}},replace:{style:"primary",text:n.replace,priority:80,click:function(){var e=this.controller,t=e.state(),n=t.get("selection"),r=n.single();e.close();e.image.changeAttachment(r,t.display(r));t.trigger("replace",e.image.toJSON());e.setState(e.options.state);e.reset()}}}}))}});r.view.Modal=r.View.extend({tagName:"div",template:r.template("media-modal"),attributes:{tabindex:0},events:{"click .media-modal-backdrop, .media-modal-close":"escapeHandler",keydown:"keydown"},initialize:function(){t.defaults(this.options,{container:document.body,title:"",propagate:!0,freeze:!0});this.focusManager=new r.view.FocusManager({el:this.el})},prepare:function(){return{title:this.options.title}},attach:function(){if(this.views.attached)return this;this.views.rendered||this.render();this.$el.appendTo(this.options.container);this.views.attached=!0;this.views.ready();return this.propagate("attach")},detach:function(){this.$el.is(":visible")&&this.close();this.$el.detach();this.views.attached=!1;return this.propagate("detach")},open:function(){var t=this.$el,n=this.options,r;if(t.is(":visible"))return this;this.views.attached||this.attach();n.freeze&&(this._freeze={scrollTop:e(window).scrollTop()});e("body").addClass("modal-open");t.show();if("ontouchend"in document&&(r=window.tinymce&&window.tinymce.activeEditor)&&!r.isHidden()&&r.iframeElement){r.iframeElement.focus();r.iframeElement.blur();setTimeout(function(){r.iframeElement.blur()},100)}this.$el.focus();return this.propagate("open")},close:function(t){var n=this._freeze;if(!this.views.attached||!this.$el.is(":visible"))return this;e("body").removeClass("modal-open");this.$el.hide().undelegate("keydown");e("#wpbody-content").focus();this.propagate("close");n&&e(window).scrollTop(n.scrollTop);t&&t.escape&&this.propagate("escape");return this},escape:function(){return this.close({escape:!0})},escapeHandler:function(e){e.preventDefault();this.escape()},content:function(e){this.views.set(".media-modal-content",e);return this},propagate:function(e){this.trigger(e);this.options.propagate&&this.controller.trigger(e);return this},keydown:function(e){if(27===e.which&&this.$el.is(":visible")){this.escape();e.stopImmediatePropagation()}}});r.view.FocusManager=r.View.extend({events:{keydown:"constrainTabbing"},focus:function(){this.$(".media-menu-item").first().focus()},constrainTabbing:function(e){var t;if(9!==e.keyCode)return;t=this.$(":tabbable");if(t.last()[0]===e.target&&!e.shiftKey){t.first().focus();return!1}if(t.first()[0]===e.target&&e.shiftKey){t.last().focus();return!1}}});r.view.UploaderWindow=r.View.extend({tagName:"div",className:"uploader-window",template:r.template("uploader-window"),initialize:function(){var n;this.$browser=e('<a href="#" class="browser" />').hide().appendTo("body");n=this.options.uploader=t.defaults(this.options.uploader||{},{dropzone:this.$el,browser:this.$browser,params:{}});n.dropzone&&!(n.dropzone instanceof e)&&(n.dropzone=e(n.dropzone));this.controller.on("activate",this.refresh,this);this.controller.on("detach",function(){this.$browser.remove()},this)},refresh:function(){this.uploader&&this.uploader.refresh()},ready:function(){var n=r.view.settings.post.id,i;if(this.uploader)return;n&&(this.options.uploader.params.post_id=n);this.uploader=new wp.Uploader(this.options.uploader);i=this.uploader.dropzone;i.on("dropzone:enter",t.bind(this.show,this));i.on("dropzone:leave",t.bind(this.hide,this));e(this.uploader).on("uploader:ready",t.bind(this._ready,this))},_ready:function(){this.controller.trigger("uploader:ready")},show:function(){var e=this.$el.show();t.defer(function(){e.css({opacity:1})})},hide:function(){var e=this.$el.css({opacity:0});r.transition(e).done(function(){"0"===e.css("opacity")&&e.hide()});t.delay(function(){"0"===e.css("opacity")&&e.is(":visible")&&e.hide()},500)}});r.view.EditorUploader=r.View.extend({tagName:"div",className:"uploader-editor",template:r.template("uploader-editor"),localDrag:!1,overContainer:!1,overDropzone:!1,draggingFile:null,initialize:function(){var n=this;this.initialized=!1;if(!window.tinyMCEPreInit||!window.tinyMCEPreInit.dragDropUpload||!this.browserSupport())return this;this.$document=e(document);this.dropzones=[];this.files=[];this.$document.on("drop",".uploader-editor",t.bind(this.drop,this));this.$document.on("dragover",".uploader-editor",t.bind(this.dropzoneDragover,this));this.$document.on("dragleave",".uploader-editor",t.bind(this.dropzoneDragleave,this));this.$document.on("click",".uploader-editor",t.bind(this.click,this));this.$document.on("dragover",t.bind(this.containerDragover,this));this.$document.on("dragleave",t.bind(this.containerDragleave,this));this.$document.on("dragstart dragend drop",function(e){n.localDrag=e.type==="dragstart"});this.initialized=!0;return this},browserSupport:function(){var e=!1,t=document.createElement("div");e="draggable"in t||"ondragstart"in t&&"ondrop"in t;e=e&&!!(window.File&&window.FileList&&window.FileReader);return e},isDraggingFile:function(e){if(this.draggingFile!==null)return this.draggingFile;if(t.isUndefined(e.originalEvent)||t.isUndefined(e.originalEvent.dataTransfer))return!1;this.draggingFile=t.indexOf(e.originalEvent.dataTransfer.types,"Files")>-1&&t.indexOf(e.originalEvent.dataTransfer.types,"text/plain")===-1;return this.draggingFile},refresh:function(n){var r;for(r in this.dropzones)this.dropzones[r].toggle(this.overContainer||this.overDropzone);t.isUndefined(n)||e(n.target).closest(".uploader-editor").toggleClass("droppable",this.overDropzone);!this.overContainer&&!this.overDropzone&&(this.draggingFile=null);return this},render:function(){if(!this.initialized)return this;r.View.prototype.render.apply(this,arguments);e(".wp-editor-wrap, #wp-fullscreen-body").each(t.bind(this.attach,this));return this},attach:function(t,n){var r=this.$el.clone();this.dropzones.push(r);e(n).append(r);return this},drop:function(t){var n=null;this.containerDragleave(t);this.dropzoneDragleave(t);this.files=t.originalEvent.dataTransfer.files;if(this.files.length<1)return;n=e(t.target).parents(".wp-editor-wrap");n.length>0&&n[0].id&&(window.wpActiveEditor=n[0].id.slice(3,-5));if(!this.workflow){this.workflow=wp.media.editor.open("content",{frame:"post",state:"insert",title:wp.media.view.l10n.addMedia,multiple:!0});this.workflow.on("uploader:ready",this.addFiles,this)}else{this.workflow.state().reset();this.addFiles.apply(this);this.workflow.open()}return!1},addFiles:function(){if(this.files.length){this.workflow.uploader.uploader.uploader.addFile(t.toArray(this.files));this.files=[]}return this},containerDragover:function(e){if(this.localDrag||!this.isDraggingFile(e))return;this.overContainer=!0;this.refresh()},containerDragleave:function(){this.overContainer=!1;t.delay(t.bind(this.refresh,this),50)},dropzoneDragover:function(e){if(this.localDrag||!this.isDraggingFile(e))return;this.overDropzone=!0;this.refresh(e);return!1},dropzoneDragleave:function(e){this.overDropzone=!1;t.delay(t.bind(this.refresh,this,e),50)},click:function(e){this.containerDragleave(e);this.dropzoneDragleave(e);this.localDrag=!1}});r.view.UploaderInline=r.View.extend({tagName:"div",className:"uploader-inline",template:r.template("uploader-inline"),events:{"click .close":"hide"},initialize:function(){t.defaults(this.options,{message:"",status:!0,canClose:!1});!this.options.$browser&&this.controller.uploader&&(this.options.$browser=this.controller.uploader.$browser);t.isUndefined(this.options.postId)&&(this.options.postId=r.view.settings.post.id);this.options.status&&this.views.set(".upload-inline-status",new r.view.UploaderStatus({controller:this.controller}))},prepare:function(){var e=this.controller.state().get("suggestedWidth"),t=this.controller.state().get("suggestedHeight"),n={};n.message=this.options.message;n.canClose=this.options.canClose;if(e&&t){n.suggestedWidth=e;n.suggestedHeight=t}return n},dispose:function(){if(this.disposing)return r.View.prototype.dispose.apply(this,arguments);this.disposing=!0;return this.remove()},remove:function(){var e=r.View.prototype.remove.apply(this,arguments);t.defer(t.bind(this.refresh,this));return e},refresh:function(){var e=this.controller.uploader;e&&e.refresh()},ready:function(){var e=this.options.$browser,t;if(this.controller.uploader){t=this.$(".browser");if(t[0]===e[0])return;e.detach().text(t.text());e[0].className=t[0].className;t.replaceWith(e.show())}this.refresh();return this},show:function(){this.$el.removeClass("hidden")},hide:function(){this.$el.addClass("hidden")}});r.view.UploaderStatus=r.View.extend({className:"media-uploader-status",template:r.template("uploader-status"),events:{"click .upload-dismiss-errors":"dismiss"},initialize:function(){this.queue=wp.Uploader.queue;this.queue.on("add remove reset",this.visibility,this);this.queue.on("add remove reset change:percent",this.progress,this);this.queue.on("add remove reset change:uploading",this.info,this);this.errors=wp.Uploader.errors;this.errors.reset();this.errors.on("add remove reset",this.visibility,this);this.errors.on("add",this.error,this)},dispose:function(){wp.Uploader.queue.off(null,null,this);r.View.prototype.dispose.apply(this,arguments);return this},visibility:function(){this.$el.toggleClass("uploading",!!this.queue.length);this.$el.toggleClass("errors",!!this.errors.length);this.$el.toggle(!!this.queue.length||!!this.errors.length)},ready:function(){t.each({$bar:".media-progress-bar div",$index:".upload-index",$total:".upload-total",$filename:".upload-filename"},function(e,t){this[t]=this.$(e)},this);this.visibility();this.progress();this.info()},progress:function(){var e=this.queue,n=this.$bar;if(!n||!e.length)return;n.width(e.reduce(function(e,n){if(!n.get("uploading"))return e+100;var r=n.get("percent");return e+(t.isNumber(r)?r:100)},0)/e.length+"%")},info:function(){var e=this.queue,t=0,n;if(!e.length)return;n=this.queue.find(function(e,n){t=n;return e.get("uploading")});this.$index.text(t+1);this.$total.text(e.length);this.$filename.html(n?this.filename(n.get("filename")):"")},filename:function(e){return r.truncate(t.escape(e),24)},error:function(e){this.views.add(".upload-errors",new r.view.UploaderStatusError({filename:this.filename(e.get("file").name),message:e.get("message")}),{at:0})},dismiss:function(e){var n=this.views.get(".upload-errors");e.preventDefault();n&&t.invoke(n,"remove");wp.Uploader.errors.reset()}});r.view.UploaderStatusError=r.View.extend({className:"upload-error",template:r.template("uploader-status-error")});r.view.Toolbar=r.View.extend({tagName:"div",className:"media-toolbar",initialize:function(){var e=this.controller.state(),t=this.selection=e.get("selection"),n=this.library=e.get("library");this._views={};this.primary=new r.view.PriorityList;this.secondary=new r.view.PriorityList;this.primary.$el.addClass("media-toolbar-primary search-form");this.secondary.$el.addClass("media-toolbar-secondary");this.views.set([this.secondary,this.primary]);this.options.items&&this.set(this.options.items,{silent:!0});this.options.silent||this.render();t&&t.on("add remove reset",this.refresh,this);n&&n.on("add remove reset",this.refresh,this)},dispose:function(){this.selection&&this.selection.off(null,null,this);this.library&&this.library.off(null,null,this);return r.View.prototype.dispose.apply(this,arguments)},ready:function(){this.refresh()},set:function(e,n,i){var s;i=i||{};if(t.isObject(e))t.each(e,function(e,t){this.set(t,e,{silent:!0})},this);else{if(!(n instanceof Backbone.View)){n.classes=["media-button-"+e].concat(n.classes||[]);n=(new r.view.Button(n)).render()}n.controller=n.controller||this.controller;this._views[e]=n;s=n.options.priority<0?"secondary":"primary";this[s].set(e,n,i)}i.silent||this.refresh();return this},get:function(e){return this._views[e]},unset:function(e,t){delete this._views[e];this.primary.unset(e,t);this.secondary.unset(e,t);(!t||!t.silent)&&this.refresh();return this},refresh:function(){var e=this.controller.state(),n=e.get("library"),r=e.get("selection");t.each(this._views,function(e){if(!e.model||!e.options||!e.options.requires)return;var i=e.options.requires,s=!1;s=t.some(r.models,function(e){return e.get("uploading")===!0});i.selection&&r&&!r.length?s=!0:i.library&&n&&!n.length&&(s=!0);e.model.set("disabled",s)})}});r.view.Toolbar.Select=r.view.Toolbar.extend({initialize:function(){var e=this.options;t.bindAll(this,"clickSelect");t.defaults(e,{event:"select",state:!1,reset:!0,close:!0,text:n.select,requires:{selection:!0}});e.items=t.defaults(e.items||{},{select:{style:"primary",text:e.text,priority:80,click:this.clickSelect,requires:e.requires}});r.view.Toolbar.prototype.initialize.apply(this,arguments)},clickSelect:function(){var e=this.options,t=this.controller;e.close&&t.close();e.event&&t.state().trigger(e.event);e.state&&t.setState(e.state);e.reset&&t.reset()}});r.view.Toolbar.Embed=r.view.Toolbar.Select.extend({initialize:function(){t.defaults(this.options,{text:n.insertIntoPost,requires:!1});r.view.Toolbar.Select.prototype.initialize.apply(this,arguments)},refresh:function(){var e=this.controller.state().props.get("url");this.get("select").model.set("disabled",!e||e==="http://");r.view.Toolbar.Select.prototype.refresh.apply(this,arguments)}});r.view.Button=r.View.extend({tagName:"a",className:"media-button",attributes:{href:"#"},events:{click:"click"},defaults:{text:"",style:"",size:"large",disabled:!1},initialize:function(){this.model=new Backbone.Model(this.defaults);t.each(this.defaults,function(e,n){var r=this.options[n];if(t.isUndefined(r))return;this.model.set(n,r);delete this.options[n]},this);this.model.on("change",this.render,this)},render:function(){var e=["button",this.className],n=this.model.toJSON();n.style&&e.push("button-"+n.style);n.size&&e.push("button-"+n.size);e=t.uniq(e.concat(this.options.classes));this.el.className=e.join(" ");this.$el.attr("disabled",n.disabled);this.$el.text(this.model.get("text"));return this},click:function(e){"#"===this.attributes.href&&e.preventDefault();this.options.click&&!this.model.get("disabled")&&this.options.click.apply(this,arguments)}});r.view.ButtonGroup=r.View.extend({tagName:"div",className:"button-group button-large media-button-group",initialize:function(){this.buttons=t.map(this.options.buttons||[],function(e){return e instanceof Backbone.View?e:(new r.view.Button(e)).render()});delete this.options.buttons;this.options.classes&&this.$el.addClass(this.options.classes)},render:function(){this.$el.html(e(t.pluck(this.buttons,"el")).detach());return this}});r.view.PriorityList=r.View.extend({tagName:"div",initialize:function(){this._views={};this.set(t.extend({},this._views,this.options.views),{silent:!0});delete this.options.views;this.options.silent||this.render()},set:function(e,n,r){var i,s,o;r=r||{};if(t.isObject(e)){t.each(e,function(e,t){this.set(t,e)},this);return this}n instanceof Backbone.View||(n=this.toView(n,e,r));n.controller=n.controller||this.controller;this.unset(e);i=n.options.priority||10;s=this.views.get()||[];t.find(s,function(e,t){if(e.options.priority>i){o=t;return!0}});this._views[e]=n;this.views.add(n,{at:t.isNumber(o)?o:s.length||0});return this},get:function(e){return this._views[e]},unset:function(e){var t=this.get(e);t&&t.remove();delete this._views[e];return this},toView:function(e){return new r.View(e)}});r.view.MenuItem=r.View.extend({tagName:"a",className:"media-menu-item",attributes:{href:"#"},events:{click:"_click"},_click:function(t){var n=this.options.click;t&&t.preventDefault();n?n.call(this):this.click();i||e(".media-frame-content input").first().focus()},click:function(){var e=this.options.state;if(e){this.controller.setState(e);this.views.parent.$el.removeClass("visible")}},render:function(){var e=this.options;e.text?this.$el.text(e.text):e.html&&this.$el.html(e.html);return this}});r.view.Menu=r.view.PriorityList.extend({tagName:"div",className:"media-menu",property:"state",ItemView:r.view.MenuItem,region:"menu",toView:function(e,t){e=e||{};e[this.property]=e[this.property]||t;return(new this.ItemView(e)).render()},ready:function(){r.view.PriorityList.prototype.ready.apply(this,arguments);this.visibility()},set:function(){r.view.PriorityList.prototype.set.apply(this,arguments);this.visibility()},unset:function(){r.view.PriorityList.prototype.unset.apply(this,arguments);this.visibility()},visibility:function(){var e=this.region,t=this.controller[e].get(),n=this.views.get(),r=!n||n.length<2;this===t&&this.controller.$el.toggleClass("hide-"+e,r)},select:function(e){var t=this.get(e);if(!t)return;this.deselect();t.$el.addClass("active")},deselect:function(){this.$el.children().removeClass("active")},hide:function(e){var t=this.get(e);if(!t)return;t.$el.addClass("hidden")},show:function(e){var t=this.get(e);if(!t)return;t.$el.removeClass("hidden")}});r.view.RouterItem=r.view.MenuItem.extend({click:function(){var e=this.options.contentMode;e&&this.controller.content.mode(e)}});r.view.Router=r.view.Menu.extend({tagName:"div",className:"media-router",property:"contentMode",ItemView:r.view.RouterItem,region:"router",initialize:function(){this.controller.on("content:render",this.update,this);r.view.Menu.prototype.initialize.apply(this,arguments)},update:function(){var e=this.controller.content.mode();e&&this.select(e)}});r.view.Sidebar=r.view.PriorityList.extend({className:"media-sidebar"});r.view.Attachment=r.View.extend({tagName:"li",className:"attachment",template:r.template("attachment"),attributes:function(){return{tabIndex:0,role:"checkbox","aria-label":this.model.get("title"),"aria-checked":!1,"data-id":this.model.get("id")}},events:{"click .js--select-attachment":"toggleSelectionHandler","change [data-setting]":"updateSetting","change [data-setting] input":"updateSetting","change [data-setting] select":"updateSetting","change [data-setting] textarea":"updateSetting","click .close":"removeFromLibrary","click .check":"checkClickHandler","click a":"preventDefault",keydown:"toggleSelectionHandler"},buttons:{},initialize:function(){var e=this.options.selection,n=t.defaults(this.options,{rerenderOnModelChange:!0});n.rerenderOnModelChange?this.model.on("change",this.render,this):this.model.on("change:percent",this.progress,this);this.model.on("change:title",this._syncTitle,this);this.model.on("change:caption",this._syncCaption,this);this.model.on("change:artist",this._syncArtist,this);this.model.on("change:album",this._syncAlbum,this);this.model.on("add",this.select,this);this.model.on("remove",this.deselect,this);if(e){e.on("reset",this.updateSelect,this);this.model.on("selection:single selection:unsingle",this.details,this);this.details(this.model,this.controller.state().get("selection"))}},dispose:function(){var e=this.options.selection;this.updateAll();e&&e.off(null,null,this);r.View.prototype.dispose.apply(this,arguments);return this},render:function(){var e=t.defaults(this.model.toJSON(),{orientation:"landscape",uploading:!1,type:"",subtype:"",icon:"",filename:"",caption:"",title:"",dateFormatted:"",width:"",height:"",compat:!1,alt:"",description:""},this.options);e.buttons=this.buttons;e.describe=this.controller.state().get("describe");"image"===e.type&&(e.size=this.imageSize());e.can={};if(e.nonces){e.can.remove=!!e.nonces["delete"];e.can.save=!!e.nonces.update}this.controller.state().get("allowLocalEdits")&&(e.allowLocalEdits=!0);e.uploading&&!e.percent&&(e.percent=0);this.views.detach();this.$el.html(this.template(e));this.$el.toggleClass("uploading",e.uploading);e.uploading?this.$bar=this.$(".media-progress-bar div"):delete this.$bar;this.updateSelect();this.updateSave();this.views.render();return this},progress:function(){this.$bar&&this.$bar.length&&this.$bar.width(this.model.get("percent")+"%")},toggleSelectionHandler:function(e){var t;if("INPUT"===e.target.nodeName)return;if(37===e.keyCode||38===e.keyCode||39===e.keyCode||40===e.keyCode){this.controller.trigger("attachment:keydown:arrow",e);return}if("keydown"===e.type&&13!==e.keyCode&&32!==e.keyCode)return;if(this.controller.isModeActive("grid")){if(this.controller.isModeActive("edit")){this.controller.trigger("edit:attachment",this.model,e.currentTarget);e.stopPropagation();return}this.controller.isModeActive("select")&&(t="toggle")}if(e.shiftKey)t="between";else if(e.ctrlKey||e.metaKey)t="toggle";this.toggleSelection({method:t});this.controller.trigger("selection:toggle");e.stopPropagation()},toggleSelection:function(e){var n=this.collection,r=this.options.selection,i=this.model,s=e&&e.method,o,u,a,f;if(!r)return;o=r.single();s=t.isUndefined(s)?r.multiple:s;if("between"===s&&o&&r.multiple){if(o===i)return;a=n.indexOf(o);f=n.indexOf(this.model);a<f?u=n.models.slice(a,f+1):u=n.models.slice(f,a+1);r.add(u);r.single(i);return}if("toggle"===s){r[this.selected()?"remove":"add"](i);r.single(i);return}if("add"===s){r.add(i);r.single(i);return}s||(s="add");s!=="add"&&(s="reset");if(this.selected())r[o===i?"remove":"single"](i);else{r[s](i);r.single(i)}},updateSelect:function(){this[this.selected()?"select":"deselect"]()},selected:function(){var e=this.options.selection;if(e)return!!e.get(this.model.cid)},select:function(e,t){var n=this.options.selection,r=this.controller;if(!n||t&&t!==n)return;if(this.$el.hasClass("selected"))return;this.$el.addClass("selected").attr("aria-checked",!0);(!r.isModeActive("grid")||!r.isModeActive("select"))&&this.$(".check").attr("tabindex","0")},deselect:function(e,t){var n=this.options.selection;if(!n||t&&t!==n)return;this.$el.removeClass("selected").attr("aria-checked",!1).find(".check").attr("tabindex","-1")},details:function(e,t){var n=this.options.selection,r;if(n!==t)return;r=n.single();this.$el.toggleClass("details",r===this.model)},preventDefault:function(e){e.preventDefault()},imageSize:function(e){var n=this.model.get("sizes");e=e||"medium";return n&&n[e]?t.clone(n[e]):{url:this.model.get("url"),width:this.model.get("width"),height:this.model.get("height"),orientation:this.model.get("orientation")}},updateSetting:function(t){var n=e(t.target).closest("[data-setting]"),r,i;if(!n.length)return;r=n.data("setting");i=t.target.value;this.model.get(r)!==i&&this.save(r,i)},save:function(){var t=this,n=this._save=this._save||{status:"ready"},r=this.model.save.apply(this.model,arguments),i=n.requests?e.when(r,n.requests):r;n.savedTimer&&clearTimeout(n.savedTimer);this.updateSave("waiting");n.requests=i;i.always(function(){if(n.requests!==i)return;t.updateSave(i.state()==="resolved"?"complete":"error");n.savedTimer=setTimeout(function(){t.updateSave("ready");delete n.savedTimer},2e3)})},updateSave:function(e){var t=this._save=this._save||{status:"ready"};if(e&&e!==t.status){this.$el.removeClass("save-"+t.status);t.status=e}this.$el.addClass("save-"+t.status);return this},updateAll:function(){var n=this.$("[data-setting]"),r=this.model,i;i=t.chain(n).map(function(t){var n=e("input, textarea, select, [value]",t),i,s;if(!n.length)return;i=e(t).data("setting");s=n.val();if(r.get(i)!==s)return[i,s]}).compact().object().value();t.isEmpty(i)||r.save(i)},removeFromLibrary:function(e){e.stopPropagation();this.collection.remove(this.model)},checkClickHandler:function(e){var t=this.options.selection;if(!t)return;e.stopPropagation();if(t.where({id:this.model.get("id")}).length){t.remove(this.model);this.$el.focus()}else t.add(this.model)}});t.each({caption:"_syncCaption",title:"_syncTitle",artist:"_syncArtist",album:"_syncAlbum"},function(e,t){r.view.Attachment.prototype[e]=function(e,n){var r=this.$('[data-setting="'+t+'"]');return r.length?n===r.find("input, textarea, select, [value]").val()?this:this.render():this}});r.view.Attachment.Library=r.view.Attachment.extend({buttons:{check:!0}});r.view.Attachment.EditLibrary=r.view.Attachment.extend({buttons:{close:!0}});r.view.Attachments=r.View.extend({tagName:"ul",className:"attachments",attributes:{tabIndex:-1},initialize:function(){this.el.id=t.uniqueId("__attachments-view-");t.defaults(this.options,{refreshSensitivity:i?300:200,refreshThreshold:3,AttachmentView:r.view.Attachment,sortable:!1,resize:!0,idealColumnWidth:e(window).width()<640?135:150});this._viewsByCid={};this.$window=e(window);this.resizeEvent="resize.media-modal-columns";this.collection.on("add",function(e){this.views.add(this.createAttachmentView(e),{at:this.collection.indexOf(e)})},this);this.collection.on("remove",function(e){var t=this._viewsByCid[e.cid];delete this._viewsByCid[e.cid];t&&t.remove()},this);this.collection.on("reset",this.render,this);this.listenTo(this.controller,"library:selection:add",this.attachmentFocus);this.scroll=t.chain(this.scroll).bind(this).throttle(this.options.refreshSensitivity).value();this.options.scrollElement=this.options.scrollElement||this.el;e(this.options.scrollElement).on("scroll",this.scroll);this.initSortable();t.bindAll(this,"setColumns");if(this.options.resize){this.on("ready",this.bindEvents);this.controller.on("open",this.setColumns);t.defer(this.setColumns,this)}},bindEvents:function(){this.$window.off(this.resizeEvent).on(this.resizeEvent,t.debounce(this.setColumns,50))},attachmentFocus:function(){this.$("li:first").focus()},restoreFocus:function(){this.$("li.selected:first").focus()},arrowEvent:function(e){var t=this.$el.children("li"),n=this.columns,r=t.filter(":focus").index(),i=r+1<=n?1:Math.ceil((r+1)/n);if(r===-1)return;if(37===e.keyCode){if(0===r)return;t.eq(r-1).focus()}if(38===e.keyCode){if(1===i)return;t.eq(r-n).focus()}if(39===e.keyCode){if(t.length===r)return;t.eq(r+1).focus()}if(40===e.keyCode){if(Math.ceil(t.length/n)===i)return;t.eq(r+n).focus()}},dispose:function(){this.collection.props.off(null,null,this);this.options.resize&&this.$window.off(this.resizeEvent);r.View.prototype.dispose.apply(this,arguments)},setColumns:function(){var e=this.columns,t=this.$el.width();if(t){this.columns=Math.min(Math.round(t/this.options.idealColumnWidth),12)||1;(!e||e!==this.columns)&&this.$el.closest(".media-frame-content").attr("data-columns",this.columns)}},initSortable:function(){var n=this.collection;if(i||!this.options.sortable||!e.fn.sortable)return;this.$el.sortable(t.extend({disabled:!!n.comparator,containment:this.$el,tolerance:"pointer",start:function(e,t){t.item.data("sortableIndexStart",t.item.index())},update:function(e,t){var r=n.at(t.item.data("sortableIndexStart")),i=n.comparator;delete n.comparator;n.remove(r,{silent:!0});n.add(r,{silent:!0,at:t.item.index()});n.comparator=i;n.trigger("reset",n);n.saveMenuOrder()}},this.options.sortable));n.props.on("change:orderby",function(){this.$el.sortable("option","disabled",!!n.comparator)},this);this.collection.props.on("change:orderby",this.refreshSortable,this);this.refreshSortable()},refreshSortable:function(){if(i||!this.options.sortable||!e.fn.sortable)return;var t=this.collection,n=t.props.get("orderby"),r="menuOrder"===n||!t.comparator;this.$el.sortable("option","disabled",!r)},createAttachmentView:function(e){var t=new this.options.AttachmentView({controller:this.controller,model:e,collection:this.collection,selection:this.options.selection});return this._viewsByCid[e.cid]=t},prepare:function(){if(this.collection.length)this.views.set(this.collection.map(this.createAttachmentView,this));else{this.views.unset();this.collection.more().done(this.scroll)}},ready:function(){this.scroll()},scroll:function(){var t=this,n=this.options.scrollElement,r=n.scrollTop,i;if(n==document){n=document.body;r=e(document).scrollTop()}if(!e(n).is(":visible")||!this.collection.hasMore())return;i=this.views.parent.toolbar;n.scrollHeight-(r+n.clientHeight)<n.clientHeight/3&&i.get("spinner").show();n.scrollHeight<
r+n.clientHeight*this.options.refreshThreshold&&this.collection.more().done(function(){t.scroll();i.get("spinner").hide()})}});r.view.Search=r.View.extend({tagName:"input",className:"search",id:"media-search-input",attributes:{type:"search",placeholder:n.search},events:{input:"search",keyup:"search",change:"search",search:"search"},render:function(){this.el.value=this.model.escape("search");return this},search:function(e){e.target.value?this.model.set("search",e.target.value):this.model.unset("search")}});r.view.AttachmentFilters=r.View.extend({tagName:"select",className:"attachment-filters",id:"media-attachment-filters",events:{change:"change"},keys:[],initialize:function(){this.createFilters();t.extend(this.filters,this.options.filters);this.$el.html(t.chain(this.filters).map(function(t,n){return{el:e("<option></option>").val(n).html(t.text)[0],priority:t.priority||50}},this).sortBy("priority").pluck("el").value());this.model.on("change",this.select,this);this.select()},createFilters:function(){this.filters={}},change:function(){var e=this.filters[this.el.value];e&&this.model.set(e.props)},select:function(){var e=this.model,n="all",r=e.toJSON();t.find(this.filters,function(e,i){var s=t.all(e.props,function(e,n){return e===(t.isUndefined(r[n])?null:r[n])});if(s)return n=i});this.$el.val(n)}});r.view.AttachmentFilters.Uploaded=r.view.AttachmentFilters.extend({createFilters:function(){var e=this.model.get("type"),t=r.view.settings.mimeTypes,i;t&&e&&(i=t[e]);this.filters={all:{text:i||n.allMediaItems,props:{uploadedTo:null,orderby:"date",order:"DESC"},priority:10},uploaded:{text:n.uploadedToThisPost,props:{uploadedTo:r.view.settings.post.id,orderby:"menuOrder",order:"ASC"},priority:20}}}});r.view.AttachmentFilters.All=r.view.AttachmentFilters.extend({createFilters:function(){var e={};t.each(r.view.settings.mimeTypes||{},function(t,n){e[n]={text:t,props:{status:null,type:n,uploadedTo:null,orderby:"date",order:"DESC"}}});e.all={text:n.allMediaItems,props:{status:null,type:null,uploadedTo:null,orderby:"date",order:"DESC"},priority:10};r.view.settings.post.id&&(e.uploaded={text:n.uploadedToThisPost,props:{status:null,type:null,uploadedTo:r.view.settings.post.id,orderby:"menuOrder",order:"ASC"},priority:20});e.unattached={text:n.unattached,props:{status:null,uploadedTo:0,type:null,orderby:"menuOrder",order:"ASC"},priority:50};r.view.settings.mediaTrash&&this.controller.isModeActive("grid")&&(e.trash={text:n.trash,props:{uploadedTo:null,status:"trash",type:null,orderby:"date",order:"DESC"},priority:50});this.filters=e}});r.view.AttachmentsBrowser=r.View.extend({tagName:"div",className:"attachments-browser",initialize:function(){t.defaults(this.options,{filters:!1,search:!0,display:!1,sidebar:!0,AttachmentView:r.view.Attachment.Library});this.listenTo(this.controller,"toggle:upload:attachment",t.bind(this.toggleUploader,this));this.createToolbar();this.options.sidebar&&this.createSidebar();this.createUploader();this.createAttachments();this.updateContent();if(!this.options.sidebar||"errors"===this.options.sidebar){this.$el.addClass("hide-sidebar");"errors"===this.options.sidebar&&this.$el.addClass("sidebar-for-errors")}this.collection.on("add remove reset",this.updateContent,this)},dispose:function(){this.options.selection.off(null,null,this);r.View.prototype.dispose.apply(this,arguments);return this},createToolbar:function(){var t,i,s;s={controller:this.controller};this.controller.isModeActive("grid")&&(s.className="media-toolbar wp-filter");this.toolbar=new r.view.Toolbar(s);this.views.add(this.toolbar);this.toolbar.set("spinner",new r.view.Spinner({priority:-60}));if(-1!==e.inArray(this.options.filters,["uploaded","all"])){this.toolbar.set("filtersLabel",(new r.view.Label({value:n.filterByType,attributes:{"for":"media-attachment-filters"},priority:-80})).render());if("uploaded"===this.options.filters)this.toolbar.set("filters",(new r.view.AttachmentFilters.Uploaded({controller:this.controller,model:this.collection.props,priority:-80})).render());else{i=new r.view.AttachmentFilters.All({controller:this.controller,model:this.collection.props,priority:-80});this.toolbar.set("filters",i.render())}}if(this.controller.isModeActive("grid")){t=r.View.extend({className:"view-switch media-grid-view-switch",template:r.template("media-library-view-switcher")});this.toolbar.set("libraryViewSwitcher",(new t({controller:this.controller,priority:-90})).render());this.toolbar.set("dateFilterLabel",(new r.view.Label({value:n.filterByDate,attributes:{"for":"media-attachment-date-filters"},priority:-75})).render());this.toolbar.set("dateFilter",(new r.view.DateFilter({controller:this.controller,model:this.collection.props,priority:-75})).render());this.toolbar.set("selectModeToggleButton",(new r.view.SelectModeToggleButton({text:n.bulkSelect,controller:this.controller,priority:-70})).render());this.toolbar.set("deleteSelectedButton",(new r.view.DeleteSelectedButton({filters:i,style:"primary",disabled:!0,text:r.view.settings.mediaTrash?n.trashSelected:n.deleteSelected,controller:this.controller,priority:-60,click:function(){var t=[],i=[],s=this,o=this.controller.state().get("selection"),u=this.controller.state().get("library");if(!o.length)return;if(!r.view.settings.mediaTrash&&!confirm(n.warnBulkDelete))return;if(r.view.settings.mediaTrash&&"trash"!==o.at(0).get("status")&&!confirm(n.warnBulkTrash))return;o.each(function(e){if(!e.get("nonces")["delete"]){i.push(e);return}if(r.view.settings.mediaTrash&&"trash"===e.get("status")){e.set("status","inherit");t.push(e.save());i.push(e)}else if(r.view.settings.mediaTrash){e.set("status","trash");t.push(e.save());i.push(e)}else e.destroy()});if(t.length){o.remove(i);e.when.apply(null,t).then(function(){u._requery(!0);s.controller.trigger("selection:action:done")})}else this.controller.trigger("selection:action:done")}})).render())}if(this.options.search){this.toolbar.set("searchLabel",(new r.view.Label({value:n.searchMediaLabel,attributes:{"for":"media-search-input"},priority:60})).render());this.toolbar.set("search",(new r.view.Search({controller:this.controller,model:this.collection.props,priority:60})).render())}this.options.dragInfo&&this.toolbar.set("dragInfo",new r.View({el:e('<div class="instructions">'+n.dragInfo+"</div>")[0],priority:-40}));this.options.suggestedWidth&&this.options.suggestedHeight&&this.toolbar.set("suggestedDimensions",new r.View({el:e('<div class="instructions">'+n.suggestedDimensions+" "+this.options.suggestedWidth+" &times; "+this.options.suggestedHeight+"</div>")[0],priority:-40}))},updateContent:function(){var e=this,t;this.controller.isModeActive("grid")?t=e.attachmentsNoResults:t=e.uploader;if(!this.collection.length){this.toolbar.get("spinner").show();this.dfd=this.collection.more().done(function(){e.collection.length?t.$el.addClass("hidden"):t.$el.removeClass("hidden");e.toolbar.get("spinner").hide()})}else{t.$el.addClass("hidden");e.toolbar.get("spinner").hide()}},createUploader:function(){this.uploader=new r.view.UploaderInline({controller:this.controller,status:!1,message:this.controller.isModeActive("grid")?"":n.noItemsFound,canClose:this.controller.isModeActive("grid")});this.uploader.hide();this.views.add(this.uploader)},toggleUploader:function(){this.uploader.$el.hasClass("hidden")?this.uploader.show():this.uploader.hide()},createAttachments:function(){this.attachments=new r.view.Attachments({controller:this.controller,collection:this.collection,selection:this.options.selection,model:this.model,sortable:this.options.sortable,scrollElement:this.options.scrollElement,idealColumnWidth:this.options.idealColumnWidth,AttachmentView:this.options.AttachmentView});this.attachments.listenTo(this.controller,"attachment:keydown:arrow",this.attachments.arrowEvent);this.attachments.listenTo(this.controller,"attachment:details:shift-tab",this.attachments.restoreFocus);this.views.add(this.attachments);if(this.controller.isModeActive("grid")){this.attachmentsNoResults=new r.View({controller:this.controller,tagName:"p"});this.attachmentsNoResults.$el.addClass("hidden no-media");this.attachmentsNoResults.$el.html(n.noMedia);this.views.add(this.attachmentsNoResults)}},createSidebar:function(){var e=this.options,t=e.selection,n=this.sidebar=new r.view.Sidebar({controller:this.controller});this.views.add(n);this.controller.uploader&&n.set("uploads",new r.view.UploaderStatus({controller:this.controller,priority:40}));t.on("selection:single",this.createSingle,this);t.on("selection:unsingle",this.disposeSingle,this);t.single()&&this.createSingle()},createSingle:function(){var e=this.sidebar,t=this.options.selection.single();e.set("details",new r.view.Attachment.Details({controller:this.controller,model:t,priority:80}));e.set("compat",new r.view.AttachmentCompat({controller:this.controller,model:t,priority:120}));this.options.display&&e.set("display",new r.view.Settings.AttachmentDisplay({controller:this.controller,model:this.model.display(t),attachment:t,priority:160,userSettings:this.model.get("displayUserSettings")}));this.model.id==="insert"&&e.$el.addClass("visible")},disposeSingle:function(){var e=this.sidebar;e.unset("details");e.unset("compat");e.unset("display");e.$el.removeClass("visible")}});r.view.Selection=r.View.extend({tagName:"div",className:"media-selection",template:r.template("media-selection"),events:{"click .edit-selection":"edit","click .clear-selection":"clear"},initialize:function(){t.defaults(this.options,{editable:!1,clearable:!0});this.attachments=new r.view.Attachments.Selection({controller:this.controller,collection:this.collection,selection:this.collection,model:new Backbone.Model});this.views.set(".selection-view",this.attachments);this.collection.on("add remove reset",this.refresh,this);this.controller.on("content:activate",this.refresh,this)},ready:function(){this.refresh()},refresh:function(){if(!this.$el.children().length)return;var e=this.collection,t="edit-selection"===this.controller.content.mode();this.$el.toggleClass("empty",!e.length);this.$el.toggleClass("one",1===e.length);this.$el.toggleClass("editing",t);this.$(".count").text(n.selected.replace("%d",e.length))},edit:function(e){e.preventDefault();this.options.editable&&this.options.editable.call(this,this.collection)},clear:function(e){e.preventDefault();this.collection.reset();this.controller.modal.focusManager.focus()}});r.view.Attachment.Selection=r.view.Attachment.extend({className:"attachment selection",toggleSelection:function(){this.options.selection.single(this.model)}});r.view.Attachments.Selection=r.view.Attachments.extend({events:{},initialize:function(){t.defaults(this.options,{sortable:!0,resize:!1,AttachmentView:r.view.Attachment.Selection});return r.view.Attachments.prototype.initialize.apply(this,arguments)}});r.view.Attachment.EditSelection=r.view.Attachment.Selection.extend({buttons:{close:!0}});r.view.Settings=r.View.extend({events:{"click button":"updateHandler","change input":"updateHandler","change select":"updateHandler","change textarea":"updateHandler"},initialize:function(){this.model=this.model||new Backbone.Model;this.model.on("change",this.updateChanges,this)},prepare:function(){return t.defaults({model:this.model.toJSON()},this.options)},render:function(){r.View.prototype.render.apply(this,arguments);t(this.model.attributes).chain().keys().each(this.update,this);return this},update:function(e){var t=this.model.get(e),n=this.$('[data-setting="'+e+'"]'),r,i;if(!n.length)return;if(n.is("select")){i=n.find('[value="'+t+'"]');if(i.length){n.find("option").prop("selected",!1);i.prop("selected",!0)}else this.model.set(e,n.find(":selected").val())}else if(n.hasClass("button-group")){r=n.find("button").removeClass("active");r.filter('[value="'+t+'"]').addClass("active")}else n.is('input[type="text"], textarea')?n.is(":focus")||n.val(t):n.is('input[type="checkbox"]')&&n.prop("checked",!!t&&"false"!==t)},updateHandler:function(t){var n=e(t.target).closest("[data-setting]"),r=t.target.value,i;t.preventDefault();if(!n.length)return;n.is('input[type="checkbox"]')&&(r=n[0].checked);this.model.set(n.data("setting"),r);(i=n.data("userSetting"))&&setUserSetting(i,r)},updateChanges:function(e){e.hasChanged()&&t(e.changed).chain().keys().each(this.update,this)}});r.view.Settings.AttachmentDisplay=r.view.Settings.extend({className:"attachment-display-settings",template:r.template("attachment-display-settings"),initialize:function(){var e=this.options.attachment;t.defaults(this.options,{userSettings:!1});r.view.Settings.prototype.initialize.apply(this,arguments);this.model.on("change:link",this.updateLinkTo,this);e&&e.on("change:uploading",this.render,this)},dispose:function(){var e=this.options.attachment;e&&e.off(null,null,this);r.view.Settings.prototype.dispose.apply(this,arguments)},render:function(){var e=this.options.attachment;e&&t.extend(this.options,{sizes:e.get("sizes"),type:e.get("type")});r.view.Settings.prototype.render.call(this);this.updateLinkTo();return this},updateLinkTo:function(){var e=this.model.get("link"),t=this.$(".link-to-custom"),n=this.options.attachment;if("none"===e||"embed"===e||!n&&"custom"!==e){t.addClass("hidden");return}if(n){"post"===e?t.val(n.get("link")):"file"===e?t.val(n.get("url")):this.model.get("linkUrl")||t.val("http://");t.prop("readonly","custom"!==e)}t.removeClass("hidden");!i&&t.is(":visible")&&t.focus()[0].select()}});r.view.Settings.Gallery=r.view.Settings.extend({className:"collection-settings gallery-settings",template:r.template("gallery-settings")});r.view.Settings.Playlist=r.view.Settings.extend({className:"collection-settings playlist-settings",template:r.template("playlist-settings")});r.view.Attachment.Details=r.view.Attachment.extend({tagName:"div",className:"attachment-details",template:r.template("attachment-details"),events:{"change [data-setting]":"updateSetting","change [data-setting] input":"updateSetting","change [data-setting] select":"updateSetting","change [data-setting] textarea":"updateSetting","click .delete-attachment":"deleteAttachment","click .trash-attachment":"trashAttachment","click .untrash-attachment":"untrashAttachment","click .edit-attachment":"editAttachment","click .refresh-attachment":"refreshAttachment",keydown:"toggleSelectionHandler"},initialize:function(){this.options=t.defaults(this.options,{rerenderOnModelChange:!1});this.on("ready",this.initialFocus);r.view.Attachment.prototype.initialize.apply(this,arguments)},initialFocus:function(){i||this.$(":input").eq(0).focus()},deleteAttachment:function(e){e.preventDefault();if(confirm(n.warnDelete)){this.model.destroy();this.controller.modal.focusManager.focus()}},trashAttachment:function(e){var t=this.controller.library;e.preventDefault();if(r.view.settings.mediaTrash&&"edit-metadata"===this.controller.content.mode()){this.model.set("status","trash");this.model.save().done(function(){t._requery(!0)})}else this.model.destroy()},untrashAttachment:function(e){var t=this.controller.library;e.preventDefault();this.model.set("status","inherit");this.model.save().done(function(){t._requery(!0)})},editAttachment:function(e){var t=this.controller.states.get("edit-image");if(window.imageEdit&&t){e.preventDefault();t.set("image",this.model);this.controller.setState("edit-image")}else this.$el.addClass("needs-refresh")},refreshAttachment:function(e){this.$el.removeClass("needs-refresh");e.preventDefault();this.model.fetch()},toggleSelectionHandler:function(e){if("keydown"===e.type&&9===e.keyCode&&e.shiftKey&&e.target===this.$(":tabbable").get(0)){this.controller.trigger("attachment:details:shift-tab",e);return!1}if(37===e.keyCode||38===e.keyCode||39===e.keyCode||40===e.keyCode){this.controller.trigger("attachment:keydown:arrow",e);return}}});r.view.AttachmentCompat=r.View.extend({tagName:"form",className:"compat-item",events:{submit:"preventDefault","change input":"save","change select":"save","change textarea":"save"},initialize:function(){this.model.on("change:compat",this.render,this)},dispose:function(){this.$(":focus").length&&this.save();return r.View.prototype.dispose.apply(this,arguments)},render:function(){var e=this.model.get("compat");if(!e||!e.item)return;this.views.detach();this.$el.html(e.item);this.views.render();return this},preventDefault:function(e){e.preventDefault()},save:function(e){var n={};e&&e.preventDefault();t.each(this.$el.serializeArray(),function(e){n[e.name]=e.value});this.model.saveCompat(n)}});r.view.Iframe=r.View.extend({className:"media-iframe",render:function(){this.views.detach();this.$el.html('<iframe src="'+this.controller.state().get("src")+'" />');this.views.render();return this}});r.view.Embed=r.View.extend({className:"media-embed",initialize:function(){this.url=(new r.view.EmbedUrl({controller:this.controller,model:this.model.props})).render();this.views.set([this.url]);this.refresh();this.model.on("change:type",this.refresh,this);this.model.on("change:loading",this.loading,this)},settings:function(e){this._settings&&this._settings.remove();this._settings=e;this.views.add(e)},refresh:function(){var e=this.model.get("type"),t;if("image"===e)t=r.view.EmbedImage;else{if("link"!==e)return;t=r.view.EmbedLink}this.settings(new t({controller:this.controller,model:this.model.props,priority:40}))},loading:function(){this.$el.toggleClass("embed-loading",this.model.get("loading"))}});r.view.Label=r.View.extend({tagName:"label",className:"screen-reader-text",initialize:function(){this.value=this.options.value},render:function(){this.$el.html(this.value);return this}});r.view.EmbedUrl=r.View.extend({tagName:"label",className:"embed-url",events:{input:"url",keyup:"url",change:"url"},initialize:function(){var n=this;this.$input=e('<input id="embed-url-field" type="url" />').val(this.model.get("url"));this.input=this.$input[0];this.spinner=e('<span class="spinner" />')[0];this.$el.append([this.input,this.spinner]);this.model.on("change:url",this.render,this);this.model.get("url")&&t.delay(function(){n.model.trigger("change:url")},500)},render:function(){var e=this.$input;if(e.is(":focus"))return;this.input.value=this.model.get("url")||"http://";r.View.prototype.render.apply(this,arguments);return this},ready:function(){i||this.focus()},url:function(e){this.model.set("url",e.target.value)},focus:function(){var e=this.$input;e.is(":visible")&&e.focus()[0].select()}});r.view.EmbedLink=r.view.Settings.extend({className:"embed-link-settings",template:r.template("embed-link-settings"),initialize:function(){this.spinner=e('<span class="spinner" />');this.$el.append(this.spinner[0]);this.listenTo(this.model,"change:url",this.updateoEmbed)},updateoEmbed:function(){var e=this.model.get("url");this.$(".setting.title").show();this.$(".embed-container").hide().find(".embed-preview").html("");if(e&&e.length<6)return;this.spinner.show();setTimeout(t.bind(this.fetch,this),500)},fetch:function(){if(e("#embed-url-field").val()!==this.model.get("url"))return;wp.ajax.send("parse-embed",{data:{post_ID:r.view.settings.post.id,shortcode:"[embed]"+this.model.get("url")+"[/embed]"}}).done(t.bind(this.renderoEmbed,this))},renderoEmbed:function(e){var t=e&&e.body||"";this.spinner.hide();this.$(".setting.title").hide();this.$(".embed-container").show().find(".embed-preview").html(t)}});r.view.EmbedImage=r.view.Settings.AttachmentDisplay.extend({className:"embed-media-settings",template:r.template("embed-image-settings"),initialize:function(){r.view.Settings.AttachmentDisplay.prototype.initialize.apply(this,arguments);this.model.on("change:url",this.updateImage,this)},updateImage:function(){this.$("img").attr("src",this.model.get("url"))}});r.view.ImageDetails=r.view.Settings.AttachmentDisplay.extend({className:"image-details",template:r.template("image-details"),events:t.defaults(r.view.Settings.AttachmentDisplay.prototype.events,{"click .edit-attachment":"editAttachment","click .replace-attachment":"replaceAttachment","click .advanced-toggle":"onToggleAdvanced",'change [data-setting="customWidth"]':"onCustomSize",'change [data-setting="customHeight"]':"onCustomSize",'keyup [data-setting="customWidth"]':"onCustomSize",'keyup [data-setting="customHeight"]':"onCustomSize"}),initialize:function(){this.options.attachment=this.model.attachment;this.listenTo(this.model,"change:url",this.updateUrl);this.listenTo(this.model,"change:link",this.toggleLinkSettings);this.listenTo(this.model,"change:size",this.toggleCustomSize);r.view.Settings.AttachmentDisplay.prototype.initialize.apply(this,arguments)},prepare:function(){var e=!1;this.model.attachment&&(e=this.model.attachment.toJSON());return t.defaults({model:this.model.toJSON(),attachment:e},this.options)},render:function(){var e=this,t=arguments;if(this.model.attachment&&"pending"===this.model.dfd.state())this.model.dfd.done(function(){r.view.Settings.AttachmentDisplay.prototype.render.apply(e,t);e.postRender()}).fail(function(){e.model.attachment=!1;r.view.Settings.AttachmentDisplay.prototype.render.apply(e,t);e.postRender()});else{r.view.Settings.AttachmentDisplay.prototype.render.apply(this,arguments);this.postRender()}return this},postRender:function(){setTimeout(t.bind(this.resetFocus,this),10);this.toggleLinkSettings();getUserSetting("advImgDetails")==="show"&&this.toggleAdvanced(!0);this.trigger("post-render")},resetFocus:function(){this.$(".link-to-custom").blur();this.$(".embed-media-settings").scrollTop(0)},updateUrl:function(){this.$(".image img").attr("src",this.model.get("url"));this.$(".url").val(this.model.get("url"))},toggleLinkSettings:function(){this.model.get("link")==="none"?this.$(".link-settings").addClass("hidden"):this.$(".link-settings").removeClass("hidden")},toggleCustomSize:function(){this.model.get("size")!=="custom"?this.$(".custom-size").addClass("hidden"):this.$(".custom-size").removeClass("hidden")},onCustomSize:function(t){var n=e(t.target).data("setting"),r=e(t.target).val(),i;if(!/^\d+/.test(r)||parseInt(r,10)<1){t.preventDefault();return}if(n==="customWidth"){i=Math.round(1/this.model.get("aspectRatio")*r);this.model.set("customHeight",i,{silent:!0});this.$('[data-setting="customHeight"]').val(i)}else{i=Math.round(this.model.get("aspectRatio")*r);this.model.set("customWidth",i,{silent:!0});this.$('[data-setting="customWidth"]').val(i)}},onToggleAdvanced:function(e){e.preventDefault();this.toggleAdvanced()},toggleAdvanced:function(e){var t=this.$el.find(".advanced-section"),n;if(t.hasClass("advanced-visible")||e===!1){t.removeClass("advanced-visible");t.find(".advanced-settings").addClass("hidden");n="hide"}else{t.addClass("advanced-visible");t.find(".advanced-settings").removeClass("hidden");n="show"}setUserSetting("advImgDetails",n)},editAttachment:function(e){var t=this.controller.states.get("edit-image");if(window.imageEdit&&t){e.preventDefault();t.set("image",this.model.attachment);this.controller.setState("edit-image")}},replaceAttachment:function(e){e.preventDefault();this.controller.setState("replace-image")}});r.view.Cropper=r.View.extend({className:"crop-content",template:r.template("crop-content"),initialize:function(){t.bindAll(this,"onImageLoad")},ready:function(){this.controller.frame.on("content:error:crop",this.onError,this);this.$image=this.$el.find(".crop-image");this.$image.on("load",this.onImageLoad);e(window).on("resize.cropper",t.debounce(this.onImageLoad,250))},remove:function(){e(window).off("resize.cropper");this.$el.remove();this.$el.off();wp.media.View.prototype.remove.apply(this,arguments)},prepare:function(){return{title:n.cropYourImage,url:this.options.attachment.get("url")}},onImageLoad:function(){var e=this.controller.get("imgSelectOptions");typeof e=="function"&&(e=e(this.options.attachment,this.controller));e=t.extend(e,{parent:this.$el});this.trigger("image-loaded");this.controller.imgSelect=this.$image.imgAreaSelect(e)},onError:function(){var e=this.options.attachment.get("filename");this.views.add(".upload-errors",new r.view.UploaderStatusError({filename:r.view.UploaderStatus.prototype.filename(e),message:_wpMediaViewsL10n.cropError}),{at:0})}});r.view.EditImage=r.View.extend({className:"image-editor",template:r.template("image-editor"),initialize:function(e){this.editor=window.imageEdit;this.controller=e.controller;r.View.prototype.initialize.apply(this,arguments)},prepare:function(){return this.model.toJSON()},render:function(){r.View.prototype.render.apply(this,arguments);return this},loadEditor:function(){var e=this.editor.open(this.model.get("id"),this.model.get("nonces").edit,this);e.done(t.bind(this.focus,this))},focus:function(){this.$(".imgedit-submit .button").eq(0).focus()},back:function(){var e=this.controller.lastState();this.controller.setState(e)},refresh:function(){this.model.fetch()},save:function(){var e=this,t=this.controller.lastState();this.model.fetch().done(function(){e.controller.setState(t)})}});r.view.Spinner=r.View.extend({tagName:"span",className:"spinner",spinnerTimeout:!1,delay:400,show:function(){this.spinnerTimeout||(this.spinnerTimeout=t.delay(function(e){e.show()},this.delay,this.$el));return this},hide:function(){this.$el.hide();this.spinnerTimeout=clearTimeout(this.spinnerTimeout);return this}})})(jQuery,_);