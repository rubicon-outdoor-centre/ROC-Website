/* global tinymce */window.wp=window.wp||{};(function(e,t,n){"use strict";var r={},i={};t.mce=t.mce||{};t.mce.views={register:function(e,n){r[e]=t.mce.View.extend(_.extend(n,{type:e}))},unregister:function(e){delete r[e]},get:function(e){return r[e]},unbind:function(){_.each(i,function(e){e.unbind()})},setMarkers:function(e){var t=[{content:e}],n=this,i,s;_.each(r,function(e,r){s=t.slice();t=[];_.each(s,function(s){var o=s.content,u,a;if(s.processed){t.push(s);return}while(o&&(u=e.prototype.match(o))){u.index&&t.push({content:o.substring(0,u.index)});i=n.createInstance(r,u.content,u.options);a=i.loader?".":i.text;t.push({content:'<p data-wpview-marker="'+i.encodedText+'">'+a+"</p>",processed:!0});o=o.slice(u.index+u.content.length)}o&&t.push({content:o})})});e=_.pluck(t,"content").join("");return e.replace(/<p>\s*<p data-wpview-marker=/g,"<p data-wpview-marker=").replace(/<\/p>\s*<\/p>/g,"</p>")},createInstance:function(e,t,n){var r=this.get(e),s,o;t=tinymce.DOM.decode(t);o=this.getInstance(t);if(o)return o;s=encodeURIComponent(t);n=_.extend(n||{},{text:t,encodedText:s});return i[s]=new r(n)},getInstance:function(e){return typeof e=="string"?i[encodeURIComponent(e)]:i[n(e).attr("data-wpview-text")]},getText:function(e){return decodeURIComponent(n(e).attr("data-wpview-text")||"")},render:function(e){_.each(i,function(t){t.render(e)})},update:function(e,t,n){var r=this.getInstance(n);r&&r.update(e,t,n)},edit:function(e,t){var n=this.getInstance(t);n&&n.edit&&n.edit(n.text,function(r){n.update(r,e,t)})},remove:function(e,t){var n=this.getInstance(t);n&&n.remove(e,t)}};t.mce.View=function(e){_.extend(this,e);this.initialize()};t.mce.View.extend=Backbone.View.extend;_.extend(t.mce.View.prototype,{content:null,loader:!0,initialize:function(){},getContent:function(){return this.content},render:function(e,t){e!=null&&(this.content=e);e=this.getContent();if(!this.loader&&!e)return;t&&this.unbind();this.replaceMarkers();e?this.setContent(e,function(e,t,r){n(t).data("rendered",!0);this.bindNode.call(this,e,t,r)},t?null:!1):this.setLoader()},bindNode:function(){},unbindNode:function(){},unbind:function(){this.getNodes(function(e,t,r){this.unbindNode.call(this,e,t,r);n(t).trigger("wp-mce-view-unbind")},!0)},getEditors:function(e){_.each(tinymce.editors,function(t){t.plugins.wpview&&e.call(this,t)},this)},getNodes:function(e,t){this.getEditors(function(r){var i=this;n(r.getBody()).find('[data-wpview-text="'+i.encodedText+'"]').filter(function(){var e;if(t==null)return!0;e=n(this).data("rendered")===!0;return t?e:!e}).each(function(){e.call(i,r,this,n(this).find(".wpview-content").get(0))})})},getMarkers:function(e){this.getEditors(function(t){var r=this;n(t.getBody()).find('[data-wpview-marker="'+this.encodedText+'"]').each(function(){e.call(r,t,this)})})},replaceMarkers:function(){this.getMarkers(function(e,t){if(!this.loader&&n(t).text()!==this.text){e.dom.setAttrib(t,"data-wpview-marker",null);return}e.dom.replace(e.dom.createFragment('<div class="wpview-wrap" data-wpview-text="'+this.encodedText+'" data-wpview-type="'+this.type+'">'+'<p class="wpview-selection-before"> </p>'+'<div class="wpview-body" contenteditable="false">'+'<div class="wpview-content wpview-type-'+this.type+'"></div>'+"</div>"+'<p class="wpview-selection-after"> </p>'+"</div>"),t)})},removeMarkers:function(){this.getMarkers(function(e,t){e.dom.setAttrib(t,"data-wpview-marker",null)})},setContent:function(e,t,n){_.isObject(e)&&e.body.indexOf("<script")!==-1?this.setIframes(e.head||"",e.body,t,n):_.isString(e)&&e.indexOf("<script")!==-1?this.setIframes("",e,t,n):this.getNodes(function(n,r,i){e=e.body||e;e.indexOf("<iframe")!==-1&&(e+='<div class="wpview-overlay"></div>');i.innerHTML="";i.appendChild(_.isString(e)?n.dom.createFragment(e):e);t&&t.call(this,n,r,i)},n)},setIframes:function(t,r,i,s){var o=e.MutationObserver||e.WebKitMutationObserver||e.MozMutationObserver,u=this;this.getNodes(function(e,s,a){var f=e.dom,l="",c=e.getBody().className||"",h=e.getDoc().getElementsByTagName("head")[0];tinymce.each(f.$('link[rel="stylesheet"]',h),function(e){e.href&&e.href.indexOf("skins/lightgray/content.min.css")===-1&&e.href.indexOf("skins/wordpress/wp-content.css")===-1&&(l+=f.getOuterHTML(e))});setTimeout(function(){function m(){var t,r;if(h.contentWindow){t=n(h);r=n(p.body).height();if(t.height()!==r){t.height(r);e.nodeChanged()}}}function g(){p.body.className=e.getBody().className}var h,p,d,v;a.innerHTML="";h=f.add(a,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",allowTransparency:"true",scrolling:"no","class":"wpview-sandbox",style:{width:"100%",display:"block"}});f.add(a,"div",{"class":"wpview-overlay"});p=h.contentWindow.document;p.open();p.write('<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+t+l+"<style>"+"html {"+"background: transparent;"+"padding: 0;"+"margin: 0;"+"}"+"body#wpview-iframe-sandbox {"+"background: transparent;"+"padding: 1px 0 !important;"+"margin: -1px 0 0 !important;"+"}"+"body#wpview-iframe-sandbox:before,"+"body#wpview-iframe-sandbox:after {"+"display: none;"+'content: "";'+"}"+"</style>"+"</head>"+'<body id="wpview-iframe-sandbox" class="'+c+'">'+r+"</body>"+"</html>");p.close();n(h.contentWindow).on("load",m);if(o){d=new o(_.debounce(m,100));d.observe(p.body,{attributes:!0,childList:!0,subtree:!0});n(s).one("wp-mce-view-unbind",function(){d.disconnect()})}else for(v=1;v<6;v++)setTimeout(m,v*700);e.on("wp-body-class-change",g);n(s).one("wp-mce-view-unbind",function(){e.off("wp-body-class-change",g)});i&&i.call(u,e,s,a)},50)},s)},setLoader:function(){this.setContent('<div class="loading-placeholder"><div class="dashicons dashicons-admin-media"></div><div class="wpview-loading"><ins></ins></div></div>')},setError:function(e,t){this.setContent('<div class="wpview-error"><div class="dashicons dashicons-'+(t||"no")+'"></div>'+"<p>"+e+"</p>"+"</div>")},match:function(e){var n=t.shortcode.next(this.type,e);if(n)return{index:n.index,content:n.content,options:{shortcode:n.shortcode}}},update:function(e,i,s){_.find(r,function(r,o){var u=r.prototype.match(e);if(u){n(s).data("rendered",!1);i.dom.setAttrib(s,"data-wpview-text",encodeURIComponent(e));t.mce.views.createInstance(o,e,u.options).render();i.focus();return!0}})},remove:function(e,t){this.unbindNode.call(this,e,t,n(t).find(".wpview-content").get(0));n(t).trigger("wp-mce-view-unbind");e.dom.remove(t);e.focus()}})})(window,window.wp,window.jQuery);(function(e,t,n){var r=n("#post_ID").val()||0,i,s,o,u;i={state:[],edit:function(e,t){var n=wp.media[this.type],r=n.edit(e);this.pausePlayers&&this.pausePlayers();_.each(this.state,function(e){r.state(e).on("update",function(e){t(n.shortcode(e).string())})});r.on("close",function(){r.detach()});r.open()}};s=_.extend({},i,{state:["gallery-edit"],template:wp.media.template("editor-gallery"),initialize:function(){var e=wp.media.gallery.attachments(this.shortcode,r),t=this.shortcode.attrs.named,n=this;e.more().done(function(){e=e.toJSON();_.each(e,function(e){e.sizes&&(t.size&&e.sizes[t.size]?e.thumbnail=e.sizes[t.size]:e.sizes.thumbnail?e.thumbnail=e.sizes.thumbnail:e.sizes.full&&(e.thumbnail=e.sizes.full))});n.render(n.template({attachments:e,columns:t.columns?parseInt(t.columns,10):wp.media.galleryDefaults.columns}))}).fail(function(e,t){n.setError(t)})}});o=_.extend({},i,{action:"parse-media-shortcode",initialize:function(){var e=this;if(this.url){this.loader=!1;this.shortcode=wp.media.embed.shortcode({url:this.text})}wp.ajax.post(this.action,{post_ID:r,type:this.shortcode.tag,shortcode:this.shortcode.string()}).done(function(t){e.render(t)}).fail(function(t){e.url?e.removeMarkers():e.setError(t.message||t.statusText,"admin-media")});this.getEditors(function(t){t.on("wpview-selected",function(){e.pausePlayers()})})},pausePlayers:function(){this.getNodes(function(e,t,r){var i=n("iframe.wpview-sandbox",r).get(0);i&&(i=i.contentWindow)&&i.mejs&&_.each(i.mejs.players,function(e){try{e.pause()}catch(t){}})})}});u=_.extend({},o,{action:"parse-embed",edit:function(e,t){var n=wp.media.embed,r=n.edit(e,this.url),i=this;this.pausePlayers();r.state("embed").props.on("change:url",function(e,t){t&&e.get("url")&&(r.state("embed").metadata=e.toJSON())});r.state("embed").on("select",function(){var e=r.state("embed").metadata;i.url?t(e.url):t(n.shortcode(e).string())});r.on("close",function(){r.detach()});r.open()}});t.register("gallery",_.extend({},s));t.register("audio",_.extend({},o,{state:["audio-details"]}));t.register("video",_.extend({},o,{state:["video-details"]}));t.register("playlist",_.extend({},o,{state:["playlist-edit","video-playlist-edit"]}));t.register("embed",_.extend({},u));t.register("embedURL",_.extend({},u,{match:function(e){var t=/(^|<p>)(https?:\/\/[^\s"]+?)(<\/p>\s*|$)/gi,n=t.exec(e);if(n)return{index:n.index+n[1].length,content:n[2],options:{url:!0}}}}))})(window,window.wp.mce.views,window.jQuery);